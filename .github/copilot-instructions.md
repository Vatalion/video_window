# GitHub Copilot Instructions - Craft Video Marketplace

## Project Overview

**Craft Video Marketplace** is a Flutter-based mobile marketplace enabling video content creators to monetize through auction-based sales. Built with **Flutter 3.35.4+** (minimum 3.19.6), **Dart 3.9.2+** (minimum 3.5.6), and **Serverpod 2.9.x** as a modular monolith backend with PostgreSQL 15+ + Redis 7.2.4+.

**Business Model**: TikTok-style feed → Story pages → Offer/Auction mechanics → Stripe-hosted checkout → Shipping & fulfillment.

## Critical Architecture Patterns

### 1. Serverpod + Melos Monorepo Structure

This project uses **Serverpod's standard structure** with a **Melos-managed Flutter workspace**:

```
video_window/                           # Root
├── video_window_server/                # Serverpod backend
├── video_window_client/                # Generated API client (auto-generated)
├── video_window_flutter/               # Flutter app (Melos workspace root)
│   └── packages/                       # Flutter packages managed by Melos
│       ├── core/                       # Data layer, repositories, utilities
│       ├── shared/                     # Design system, common widgets
│       └── features/                   # Feature packages folder
│           ├── auth/                   # Authentication feature
│           ├── timeline/               # Timeline/video editing
│           ├── commerce/               # Marketplace/auctions
│           └── publishing/             # Content publishing
└── video_window_shared/                # Shared Dart code (Serverpod-managed)
```

**Key Rules**:
- **Never edit** `video_window_client/` or `video_window_shared/` - regenerated by Serverpod
- Feature packages contain **only** `use_cases/` and `presentation/` layers
- All data operations centralized in `packages/core/`
- Melos workspace is inside `video_window_flutter/` directory
- Use path dependencies between internal packages

### 2. State Management - Centralized BLoC

- Global state (auth, app) lives in `video_window_flutter/lib/presentation/bloc/`
- Feature-specific BLoCs in `video_window_flutter/packages/features/<feature>/lib/presentation/bloc/`
- **NO GetIt globals** - inject dependencies via constructors
- Use base classes from `packages/core/lib/bloc/`: `BaseBloc`, `BaseListBloc`, `BaseCrudBloc`, `ServerpodBloc`

**Data Flow**:
```
UI Widget → BLoC Event → Use Case → Repository → Serverpod Client → Backend
         ← BLoC State ←  Result  ← Domain Entity ← DTO ←
```

### 3. Serverpod-First Integration

- **Auto-generated folders**: `video_window_client/` and `video_window_shared/` - never edit manually
- All backend calls use generated client from `video_window_client/`
- Repositories live in `video_window_flutter/packages/core/lib/data/repositories/`
- Backend modules: `video_window_server/lib/src/endpoints/{identity, story, offers, payments, orders}/`
- Run `serverpod generate` (not Melos) to regenerate client code after server changes

### 4. Data Transformation Boundaries

**Critical**: Transform data at each layer boundary. Never pass raw strings across layers.

```dart
// ✅ CORRECT
onChanged: (value) {
  if (EmailValidator.isValid(value)) {
    context.read<AuthBloc>().add(SignInEmailChanged(
      email: EmailAddress(value.trim()) // String → Value Object
    ));
  }
}

// ❌ WRONG - raw string crossing layers
context.read<AuthBloc>().add(SignInEmailChanged(email: value));
```

Use `Either<Failure, Success>` for domain operations. Transform exceptions to domain failures at repository boundaries.

## Essential Developer Workflows

### Melos Commands (Primary Development Interface)

```bash
# MUST RUN FIRST - setup environment (run from video_window_flutter/)
cd video_window_flutter
melos run setup              # Installs deps + runs code generation

# Development cycle
melos run generate           # Runs build_runner for Flutter packages
melos run analyze            # Static analysis (pre-commit)
melos run format             # Format all code
melos run test               # Full test suite with coverage

# Specific test types
melos run test:unit          # Unit tests only
melos run test:widget        # Widget tests
melos run test:integration   # Integration tests

# Cleanup
melos run clean              # Clean all packages
```

**Serverpod Code Generation** (separate from Melos):
```bash
# From project root after server changes
cd video_window_server
serverpod generate           # Regenerates video_window_client/ and video_window_shared/
```

**Code generation is mandatory** after:
- Serverpod protocol changes (`video_window_server/lib/src/protocol/*.yaml`)
- Adding new Serverpod endpoints
- Server model updates

### Task Runner (VS Code Tasks)

Available tasks via `CMD+Shift+P` → "Run Task":
- **Melos: Setup** - First-time environment setup
- **Melos: Analyze** - Quick static analysis
- **Melos: Test** - Run full test suite
- **Melos: Generate** - Code generation

## Project-Specific Conventions

### Naming Standards

- **Files**: `snake_case.dart` (e.g., `user_repository.dart`)
- **Classes**: `PascalCase` (e.g., `AuthenticationBloc`)
- **BLoC Events**: `PascalCase` with action (e.g., `SignInRequested`)
- **BLoC States**: `PascalCase` with status (e.g., `AuthLoading`, `AuthSuccess`)
- **Database tables**: `snake_case` plural (e.g., `auction_bids`)
- **API endpoints**: `kebab-case` (e.g., `/users/{id}/profile`)

### File Organization

**Feature Package Structure** (from `coding-standards.md`):
```
video_window_flutter/packages/features/auth/
├── lib/
│   ├── use_cases/           # Business logic
│   │   ├── sign_in_use_case.dart
│   │   └── sign_up_use_case.dart
│   └── presentation/        # UI layer
│       ├── bloc/
│       ├── pages/
│       └── widgets/
└── test/                    # Mirror lib/ structure
```

### Security & Performance Rules

1. **Never trust client data** - validate at endpoint boundaries
2. **No PAN/secrets in logs** - Stripe is SAQ A scoped (hosted checkout)
3. **Mobile-first performance**: Consider memory, CPU, battery on every commit
4. **Accessibility required**: WCAG 2.1 AA (44x44 targets, 4.5:1 contrast, semantic labels)
5. **Video security**: FLAG_SECURE (Android), capture detection (iOS), watermarked HLS with signed URLs

## Critical Integration Points

### Payment Flow (Stripe Connect Express)

1. Backend creates Checkout Session with 24h expiry
2. Flutter opens hosted checkout in webview
3. Webhook drives state machine: `checkout.session.completed` → `payment_intent.succeeded`
4. Order moves to shipping (72h SLA for tracking)

**Never implement custom payment UI** - use Stripe's hosted checkout.

### Auction Mechanics

- First qualified offer (≥ maker minimum) → 72h auction
- Soft close: bids in final 15min extend by 15min (max +24h)
- Maker can accept current high bid anytime to end auction
- Auto-reject threshold configurable per listing

### Video Pipeline

1. In-app capture/upload → `packages/features/timeline/`
2. Clip composition → Local or Server processing
3. Upload to S3 → FFmpeg transcoding (Serverpod)
4. HLS output → CloudFront CDN with signed URLs
5. Playback with watermark overlay (no offline, no casting)

## BMAD Method Integration

This project uses **BMAD (Business Methodology for Agile Development)** conventions:

- `bmad/cis/` - Creative Intelligence System (5 specialized agents: Carson, Dr. Quinn, Maya, Victor, Sophia)
- `bmad/bmb/` - BMad Builder Module (create custom agents/workflows)
- `bmad/bmm/` - BMad Method Module (PM, Architect, Dev agents)
- `bmad/core/` - Core tasks and workflows

**For AI agents**: Load `bmad/<module>/config.yaml` and reference `bmad/core/tasks/workflow.xml` for workflow execution.

## Documentation Map

### **Core Documentation** ✅
- **PRD**: `docs/prd.md` - Complete product requirements
- **Architecture**: `docs/architecture/tech-stack.md`, `coding-standards.md`, `bloc-implementation-guide.md`
- **Package specs**: `package-architecture-requirements.md` (PSR1-PSR15)
- **Data flow**: `data-flow-mapping.md` - Layer transformation rules
- **Stories**: `docs/stories/` - Feature breakdown by epic (20 epics total: 3 foundational + 17 feature epics)
- **Serverpod guide**: `serverpod-integration-guide.md`

### **Governance Framework** ✅ NEW
- **Process Hub**: `docs/process/README.md` - Central documentation process guide
- **Definition of Ready**: `docs/process/definition-of-ready.md` - Story readiness criteria
- **Definition of Done**: `docs/process/definition-of-done.md` - Story completion criteria
- **Story Approval**: `docs/process/story-approval-workflow.md` - Complete story lifecycle
- **Epic Validation**: `docs/process/epic-validation-backlog.md` - Epic validation tracking
- **Test Strategy**: `docs/testing/master-test-strategy.md` - Comprehensive testing approach

### **Development Prerequisites**
**BEFORE starting ANY development work, confirm:**
1. ✅ Epic validation complete (check `docs/process/epic-validation-backlog.md`)
2. ✅ Stakeholder approvals obtained (see validation reports in `docs/`)
3. ✅ Stories follow Definition of Ready (`docs/process/definition-of-ready.md`)
4. ✅ Test strategy understood (`docs/testing/master-test-strategy.md`)

## Common Mistakes to Avoid

### **Technical Mistakes**
1. ❌ Editing `video_window_client/` or `video_window_shared/` directly → ✅ Modify Serverpod schemas in `video_window_server/`, run `serverpod generate`
2. ❌ Using GetIt service locator → ✅ Constructor injection
3. ❌ Raw strings across layers → ✅ Value objects with validation
4. ❌ Manual HTTP clients → ✅ Generated Serverpod client from `video_window_client/`
5. ❌ Feature packages with data layer → ✅ Core package handles all data
6. ❌ Global state → ✅ BLoC pattern with proper scoping
7. ❌ Forgetting `melos run format` before commit → ✅ Format is part of CI gates
8. ❌ Running Melos from project root → ✅ Run from `video_window_flutter/` directory

### **Process Mistakes** ⚠️ NEW GOVERNANCE REQUIREMENTS
9. ❌ Starting development without epic validation → ✅ Check `docs/process/epic-validation-backlog.md` first
10. ❌ Creating stories without Definition of Ready → ✅ Use `docs/process/definition-of-ready.md` checklist
11. ❌ Bypassing stakeholder approval → ✅ Follow `docs/process/story-approval-workflow.md`
12. ❌ Missing test strategy compliance → ✅ Review `docs/testing/master-test-strategy.md`
13. ❌ Incomplete Definition of Done → ✅ Use `docs/process/definition-of-done.md` checklist

## Quick Start for New Developers

```bash
# 1. Clone and setup
git clone <repo>
cd video_window

# 2. Install Melos globally
dart pub global activate melos

# 3. Bootstrap workspace (CRITICAL FIRST STEP)
cd video_window_flutter
melos run setup

# 4. Run app
flutter run

# 5. Before committing
melos run format
melos run analyze
melos run test
```

## Need More Context?

### **Technical Context**
- **Architecture overview**: Read `docs/architecture/greenfield-implementation-guide.md`
- **BLoC patterns**: See `bloc-implementation-guide.md` with base classes
- **Package boundaries**: Check `package-architecture-requirements.md`
- **PRD business rules**: Refer to `docs/prd.md` and `docs/brief.md`
- **Workflow automation**: `.github/workflows/quality-gates.yml`

### **Process & Governance Context** ⚠️ CRITICAL FOR DEVELOPMENT
- **Documentation process**: Start with `docs/process/README.md` - central process guide
- **Development readiness**: Use `docs/process/epic-validation-backlog.md` to confirm epic status
- **Story management**: Follow `docs/process/story-approval-workflow.md` for complete lifecycle
- **Quality gates**: Review `docs/testing/master-test-strategy.md` for testing requirements

---

**Last Updated**: 2025-11-03 | **Flutter**: 3.35.4+ (min 3.19.6) | **Dart**: 3.9.2+ (min 3.5.6) | **Serverpod**: 2.9.x | **Governance**: ✅ Complete
