# Epic 01: Environment & CI/CD Setup - Technical Specification

**Epic Goal:** Establish the complete development environment, repository structure, tooling, and CI/CD pipeline to enable flawless development of the Craft Video Marketplace.

**Stories:**
- 01-1: Bootstrap Repository Structure (Serverpod + Melos monorepo)
- 01-2: Local Development Environment (Docker, PostgreSQL, Redis)
- 01-3: Code Generation Workflows (Serverpod + build_runner)
- 01-4: CI/CD Pipeline (GitHub Actions quality gates)

---

## Architecture Overview

### Component Mapping
- **Repository Structure:** Serverpod standard layout with Melos-managed Flutter workspace
- **Local Environment:** Docker Compose orchestration for PostgreSQL + Redis
- **Code Generation:** Serverpod CLI for backend, build_runner for Flutter
- **CI/CD:** GitHub Actions with quality gates (format, analyze, test)
- **Secrets Management:** 1Password Connect for development secrets

### Technology Stack
- **Flutter:** 3.35.4+ (minimum 3.19.6)
- **Dart:** 3.9.2+ (minimum 3.5.6)
- **Serverpod:** 2.9.x
- **PostgreSQL:** 15+
- **Redis:** 7.2.4+
- **Docker:** Latest stable
- **Melos:** Latest (workspace management)
- **GitHub Actions:** Workflow automation

---

## Repository Structure

### Serverpod Standard Layout
```
video_window/                           # Root
├── .github/
│   └── workflows/
│       ├── quality-gates.yml          # CI/CD pipeline
│       └── deploy.yml                 # Deployment workflows
├── video_window_server/                # Serverpod backend
│   ├── bin/
│   │   └── main.dart                  # Server entry point
│   ├── config/
│   │   ├── development.yaml           # Dev config
│   │   ├── staging.yaml               # Staging config
│   │   └── production.yaml            # Production config
│   ├── lib/
│   │   └── src/
│   │       ├── endpoints/             # API endpoints
│   │       │   ├── identity/          # Authentication
│   │       │   ├── story/             # Content management
│   │       │   ├── offers/            # Commerce
│   │       │   ├── payments/          # Stripe integration
│   │       │   └── orders/            # Order fulfillment
│   │       ├── protocol/              # Data models (YAML)
│   │       └── generated/             # Auto-generated code
│   ├── migrations/                    # Database migrations
│   ├── test/                          # Backend tests
│   └── pubspec.yaml
├── video_window_client/                # Generated API client (DO NOT EDIT)
│   └── lib/                           # Auto-generated from server
├── video_window_shared/                # Shared Dart code (DO NOT EDIT)
│   └── lib/                           # Auto-generated from server
├── video_window_flutter/               # Flutter app (Melos workspace root)
│   ├── lib/
│   │   ├── main.dart                  # App entry point
│   │   ├── app_shell/                 # Bootstrap, routing, theme
│   │   └── presentation/
│   │       └── bloc/                  # Global BLoCs (app, auth)
│   ├── packages/                      # Flutter packages managed by Melos
│   │   ├── core/                      # Data layer, repositories, utilities
│   │   │   ├── lib/
│   │   │   │   ├── bloc/              # Base BLoC classes
│   │   │   │   ├── data/              # Repositories
│   │   │   │   ├── domain/            # Domain entities
│   │   │   │   └── utils/             # Utilities
│   │   │   └── pubspec.yaml
│   │   ├── shared/                    # Design system, common widgets
│   │   │   ├── lib/
│   │   │   │   ├── design_system/     # Tokens, theme
│   │   │   │   └── widgets/           # Shared widgets
│   │   │   └── pubspec.yaml
│   │   └── features/                  # Feature packages folder
│   │       ├── auth/                  # Authentication feature
│   │       │   ├── lib/
│   │       │   │   ├── use_cases/     # Business logic
│   │       │   │   └── presentation/  # UI layer
│   │       │   └── pubspec.yaml
│   │       ├── timeline/              # Timeline/video editing
│   │       ├── commerce/              # Marketplace/auctions
│   │       └── publishing/            # Content publishing
│   ├── test/                          # App-level tests
│   ├── melos.yaml                     # Melos workspace config
│   └── pubspec.yaml
├── docker-compose.yml                  # Local development services
├── .dockerignore
├── .gitignore
├── README.md                           # Project overview
└── docs/                               # Documentation

CRITICAL RULES:
- NEVER edit video_window_client/ or video_window_shared/ - regenerated by Serverpod
- Feature packages contain ONLY use_cases/ and presentation/ layers
- All data operations centralized in packages/core/
- Melos workspace is inside video_window_flutter/ directory
- Use path dependencies between internal packages
```

---

## Development Environment Setup

### Prerequisites Checklist
```bash
# Required installations
✅ Flutter 3.35.4+ (minimum 3.19.6)
✅ Dart 3.9.2+ (minimum 3.5.6)
✅ Docker Desktop (latest stable)
✅ Git (latest stable)
✅ VS Code or IntelliJ IDEA with Flutter/Dart plugins

# Verify installations
flutter --version  # Should show >=3.35.4
dart --version     # Should show >=3.9.2
docker --version   # Should be running
git --version
```

### Global Tool Installation
```bash
# Install Melos globally
dart pub global activate melos

# Install Serverpod CLI globally
dart pub global activate serverpod_cli

# Verify Melos installation
melos --version

# Verify Serverpod CLI
serverpod --version  # Should show 2.9.x
```

### Docker Compose Configuration

**File:** `docker-compose.yml` (project root)

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: video_window_postgres
    environment:
      POSTGRES_DB: video_window_dev
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: dev_password_change_in_production
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7.2.4-alpine
    container_name: video_window_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    command: redis-server --appendonly yes

volumes:
  postgres_data:
  redis_data:
```

### Environment Variables

**File:** `video_window_server/config/development.yaml`

```yaml
# Development configuration
apiServer:
  port: 8080
  publicHost: localhost
  publicPort: 8080
  publicScheme: http

insights:
  enabled: false

database:
  host: localhost
  port: 5432
  name: video_window_dev
  user: postgres
  password: dev_password_change_in_production
  
  # Connection pool settings
  maxConnections: 10
  minConnections: 2
  sslMode: disable  # Development only

redis:
  enabled: true
  host: localhost
  port: 6379

# Development-specific settings
logging:
  level: debug
  format: pretty

cors:
  enabled: true
  allowedOrigins:
    - http://localhost:*
```

---

## Code Generation Workflows

### Serverpod Code Generation

**Purpose:** Generate client code (`video_window_client/`) and shared models (`video_window_shared/`) from server definitions.

**When to Run:**
- After creating/modifying protocol files in `video_window_server/lib/src/protocol/*.yaml`
- After adding new Serverpod endpoints
- After server model updates

**Command:**
```bash
# From project root
cd video_window_server
serverpod generate

# What it generates:
# - video_window_client/lib/src/protocol/ (DO NOT EDIT)
# - video_window_shared/lib/src/protocol/ (DO NOT EDIT)
# - video_window_server/lib/src/generated/ (DO NOT EDIT)
```

**Example Protocol File:** `video_window_server/lib/src/protocol/user.yaml`

```yaml
class: User
fields:
  id: String
  email: String
  displayName: String?
  createdAt: DateTime
  updatedAt: DateTime
```

### Flutter Code Generation (build_runner)

**Purpose:** Generate code for JSON serialization, routing, and other Flutter-specific needs.

**When to Run:**
- After modifying files with code generation annotations (@freezed, @JsonSerializable, etc.)
- After adding new routes or state classes

**Command:**
```bash
# From video_window_flutter/ directory
cd video_window_flutter
melos run generate

# Or for specific packages
melos exec --scope=core -- dart run build_runner build --delete-conflicting-outputs
```

### Melos Workspace Bootstrap

**Purpose:** Install dependencies and setup all packages in the workspace.

**First-Time Setup:**
```bash
# Navigate to Flutter workspace
cd video_window_flutter

# Bootstrap all packages (CRITICAL FIRST STEP)
melos run setup

# What it does:
# 1. Runs 'flutter pub get' on all packages
# 2. Runs build_runner code generation
# 3. Verifies dependencies are properly linked
```

**Daily Development:**
```bash
# After pulling latest code
melos clean && melos run setup

# Before committing
melos run format
melos run analyze
melos run test
```

---

## CI/CD Pipeline

### GitHub Actions Quality Gates

**File:** `.github/workflows/quality-gates.yml`

```yaml
name: Quality Gates

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.4'
          dart-version: '3.9.2'
      
      - name: Install Melos
        run: dart pub global activate melos
      
      - name: Bootstrap workspace
        working-directory: video_window_flutter
        run: melos run setup
      
      - name: Check formatting
        working-directory: video_window_flutter
        run: melos run format-check

  analyze:
    name: Static Analysis
    runs-on: ubuntu-latest
    needs: format-check
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.4'
          dart-version: '3.9.2'
      
      - name: Install Melos
        run: dart pub global activate melos
      
      - name: Bootstrap workspace
        working-directory: video_window_flutter
        run: melos run setup
      
      - name: Run analysis
        working-directory: video_window_flutter
        run: melos run analyze

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: analyze
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.4'
          dart-version: '3.9.2'
      
      - name: Install Melos
        run: dart pub global activate melos
      
      - name: Bootstrap workspace
        working-directory: video_window_flutter
        run: melos run setup
      
      - name: Run tests
        working-directory: video_window_flutter
        run: melos run test:unit
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info

  serverpod-tests:
    name: Serverpod Backend Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: video_window_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7.2.4-alpine
        ports:
          - 6379:6379
    
    steps:
      - uses: actions/checkout@v4
      - uses: dart-lang/setup-dart@v1
        with:
          sdk: '3.9.2'
      
      - name: Install Serverpod CLI
        run: dart pub global activate serverpod_cli
      
      - name: Install dependencies
        working-directory: video_window_server
        run: dart pub get
      
      - name: Generate code
        working-directory: video_window_server
        run: serverpod generate
      
      - name: Run migrations
        working-directory: video_window_server
        run: dart run bin/main.dart --migrate --test
      
      - name: Run tests
        working-directory: video_window_server
        run: dart test
```

### Pre-Commit Hooks (Recommended)

**File:** `.husky/pre-commit` (if using Husky)

```bash
#!/bin/sh
cd video_window_flutter
melos run format
melos run analyze
```

---

## Development Workflows

### Daily Development Cycle

```bash
# 1. Start local services
docker-compose up -d

# 2. Verify services are healthy
docker-compose ps

# 3. Navigate to Flutter workspace
cd video_window_flutter

# 4. Run the app
flutter run

# 5. In another terminal: Watch for changes and regenerate
cd video_window_server
serverpod generate --watch
```

### Adding a New Serverpod Endpoint

```bash
# 1. Create endpoint file
# video_window_server/lib/src/endpoints/example_endpoint.dart

# 2. Generate client code
cd video_window_server
serverpod generate

# 3. The generated client will be available in Flutter:
# import 'package:video_window_client/video_window_client.dart';
```

### Adding a New Feature Package

```bash
# 1. Create package structure
cd video_window_flutter/packages/features
mkdir -p new_feature/lib/{use_cases,presentation}

# 2. Create pubspec.yaml
cat > new_feature/pubspec.yaml << 'EOF'
name: new_feature
publish_to: none

dependencies:
  flutter:
    sdk: flutter
  core:
    path: ../../core
  shared:
    path: ../../shared
  video_window_client:
    path: ../../../../video_window_client

dev_dependencies:
  flutter_test:
    sdk: flutter
EOF

# 3. Bootstrap with Melos
cd ../../  # Back to video_window_flutter
melos bootstrap
```

### Troubleshooting Common Issues

#### Issue: "Melos command not found"
```bash
# Solution: Add pub cache to PATH
export PATH="$PATH:$HOME/.pub-cache/bin"

# Or reinstall Melos
dart pub global activate melos
```

#### Issue: "Serverpod generate fails"
```bash
# Solution: Clean and regenerate
cd video_window_server
rm -rf lib/src/generated
serverpod generate
```

#### Issue: "Database connection refused"
```bash
# Solution: Verify Docker services
docker-compose ps
docker-compose logs postgres

# Restart services
docker-compose down
docker-compose up -d
```

#### Issue: "Build runner conflicts"
```bash
# Solution: Clean build artifacts
cd video_window_flutter
melos clean
melos run setup
```

---

## Testing Strategy

### Unit Tests
- **Location:** `{package}/test/unit/`
- **Coverage:** ≥80% overall, ≥95% for critical paths
- **Command:** `melos run test:unit`

### Widget Tests
- **Location:** `{package}/test/widget/`
- **Purpose:** Test UI components in isolation
- **Command:** `melos run test:widget`

### Integration Tests
- **Location:** `video_window_flutter/test/integration/`
- **Purpose:** Test feature interactions and API integration
- **Command:** `melos run test:integration`

### Serverpod Backend Tests
- **Location:** `video_window_server/test/`
- **Purpose:** Test endpoints, business logic, database operations
- **Command:** `cd video_window_server && dart test`

---

## Monitoring and Observability

### Local Development Monitoring

```bash
# PostgreSQL logs
docker-compose logs -f postgres

# Redis logs
docker-compose logs -f redis

# Serverpod logs
cd video_window_server
dart run bin/main.dart  # Logs to console in dev mode
```

### Performance Profiling

```bash
# Flutter performance overlay
flutter run --profile

# Serverpod performance
# Enable insights in config/development.yaml:
# insights:
#   enabled: true
```

---

## Security Considerations

### Development Secrets
- **Never commit:** `config/development.yaml` with real credentials
- **Use:** Environment variables or 1Password for sensitive data
- **Template:** Provide `.env.example` with placeholder values

### Database Security
- **Development:** Simple passwords are OK
- **Staging/Production:** Use AWS Secrets Manager or 1Password Connect
- **Migrations:** Always test in development before production

### API Security
- **CORS:** Restricted in production, permissive in development
- **Rate Limiting:** Configured per environment
- **Authentication:** JWT tokens with proper expiry and rotation

---

## Success Criteria

Epic 01 is considered complete when:

- ✅ Repository structure matches Serverpod + Melos layout
- ✅ Docker Compose successfully starts PostgreSQL + Redis
- ✅ `melos run setup` completes without errors
- ✅ `serverpod generate` produces client code
- ✅ `melos run format` passes
- ✅ `melos run analyze` passes with zero warnings
- ✅ `melos run test` passes with ≥80% coverage
- ✅ GitHub Actions quality gates pass on PR
- ✅ Developer setup guide tested on clean machine
- ✅ Flutter app runs successfully with `flutter run`
- ✅ Serverpod backend responds to health check

---

## References

- [Serverpod Documentation](https://docs.serverpod.dev/)
- [Melos Documentation](https://melos.invertase.dev/)
- [Flutter Documentation](https://docs.flutter.dev/)
- [Docker Compose Documentation](https://docs.docker.com/compose/)
- [GitHub Actions Documentation](https://docs.github.com/en/actions)

---

**Document Version:** 1.0  
**Last Updated:** 2025-11-03  
**Status:** APPROVED  
**Approved By:** Winston (Architect), Amelia (Dev Lead), Murat (Test Lead)  
**Approval Date:** 2025-11-03
