# Serverpod Setup & Installation Guide

**Version:** Serverpod 2.9.x (2.9.1 production, 2.9.2 available)  
**Project:** Video Window (Craft Video Marketplace)  
**Last Updated:** 2025-10-30  
**Status:** ✅ Production Ready

---

## Prerequisites

### Required Software
- **Dart SDK:** 3.5.6 (bundled with Flutter 3.19.6)
- **Flutter:** 3.19.6
- **Docker Desktop:** Latest stable (for PostgreSQL + Redis)
- **PostgreSQL:** 15+ (via Docker or local)
- **Redis:** 7.0+ (via Docker or local)

### Development Environment
```bash
# Verify Flutter/Dart versions
flutter --version  # Should show Flutter 3.19.6
dart --version     # Should show Dart 3.5.6

# Verify Docker is running
docker --version
docker ps  # Should not error
```

---

## Serverpod CLI Installation

### Global Installation
```bash
# Install Serverpod CLI globally
dart pub global activate serverpod_cli

# Verify installation
serverpod version  # Should show 2.9.x
```

### Add to PATH (if needed)
```bash
# macOS/Linux - Add to ~/.zshrc or ~/.bashrc
export PATH="$PATH":"$HOME/.pub-cache/bin"

# Reload shell
source ~/.zshrc
```

---

## Video Window Project Structure

Our project follows Serverpod's standard structure with Melos integration:

```
video_window/                        # Project root
├── video_window_server/             # Serverpod backend
│   ├── lib/src/
│   │   ├── endpoints/               # API endpoints by domain
│   │   │   ├── identity/            # Auth & users
│   │   │   ├── story/               # Content & media
│   │   │   ├── offers/              # Marketplace offers
│   │   │   ├── payments/            # Stripe integration
│   │   │   └── orders/              # Order management
│   │   ├── services/                # Business logic
│   │   └── generated/               # Auto-generated (DO NOT EDIT)
│   ├── config/                      # Environment configs
│   ├── migrations/                  # Database migrations
│   └── docker-compose.yaml          # Local dev services
│
├── video_window_client/             # Generated API client (DO NOT EDIT)
├── video_window_shared/             # Shared models (DO NOT EDIT)
└── video_window_flutter/            # Flutter app (Melos workspace)
```

**⚠️ CRITICAL:** Never manually edit `video_window_client/` or `video_window_shared/` - these are regenerated by Serverpod.

---

## Initial Setup (First Time)

### 1. Start Local Services

```bash
cd video_window_server

# Start PostgreSQL + Redis via Docker
docker-compose up -d

# Verify services are running
docker ps  # Should show postgres and redis containers
```

**Default Ports:**
- PostgreSQL: `5432`
- Redis: `6379`
- Serverpod: `8080` (development server)

### 2. Database Setup

```bash
# Create database (first time only)
createdb video_window_dev

# Run migrations
serverpod create-migration
serverpod migrate

# Verify database connection
psql -h localhost -U postgres -d video_window_dev -c '\dt'
```

### 3. Generate Client Code

```bash
# From video_window_server directory
serverpod generate

# This regenerates:
# - video_window_client/lib/
# - video_window_shared/lib/
```

**When to Run:** After any changes to protocol files (`.yaml` in `lib/src/protocol/`)

---

## Running the Development Server

### Start Server

```bash
cd video_window_server

# Development mode with hot reload
serverpod run

# Server starts on http://localhost:8080
# Health check: http://localhost:8080/health
```

### Verify Server

```bash
# Test health endpoint
curl http://localhost:8080/health

# Expected response:
# {"status": "ok", "timestamp": "2025-10-30T..."}
```

---

## Environment Configuration

### Development Environment

**File:** `video_window_server/config/development.yaml`

```yaml
database:
  host: localhost
  port: 5432
  name: video_window_dev
  user: postgres
  password: postgres

redis:
  host: localhost
  port: 6379

server:
  port: 8080
  publicHost: localhost
  publicScheme: http
```

### Production Environment

**File:** `video_window_server/config/production.yaml`

```yaml
database:
  host: ${DB_HOST}
  port: ${DB_PORT}
  name: ${DB_NAME}
  user: ${DB_USER}
  password: ${DB_PASSWORD}

redis:
  host: ${REDIS_HOST}
  port: ${REDIS_PORT}

server:
  port: 8080
  publicHost: ${PUBLIC_HOST}
  publicScheme: https
```

**⚠️ Security:** Never commit passwords. Use environment variables in production.

---

## Flutter Integration

### 1. Add Client Dependency

**File:** `video_window_flutter/pubspec.yaml`

```yaml
dependencies:
  video_window_client:
    path: ../video_window_client
```

### 2. Initialize Client

```dart
import 'package:video_window_client/video_window_client.dart';

final client = Client(
  'http://localhost:8080/',
  authenticationKeyManager: FlutterAuthenticationKeyManager(),
);
```

### 3. Use Generated Endpoints

```dart
// Example: Calling an endpoint
final result = await client.identity.signInWithEmail(
  email: 'user@example.com',
  otp: '123456',
);
```

---

## Troubleshooting

### Issue: "Command not found: serverpod"
**Cause:** CLI not in PATH  
**Solution:**
```bash
# Add to PATH
export PATH="$PATH":"$HOME/.pub-cache/bin"
source ~/.zshrc
```

### Issue: "Database connection failed"
**Cause:** PostgreSQL not running  
**Solution:**
```bash
# Check Docker containers
docker ps

# Restart if needed
cd video_window_server
docker-compose restart postgres
```

### Issue: "Port 8080 already in use"
**Cause:** Another process using port  
**Solution:**
```bash
# Find process
lsof -i :8080

# Kill process (if safe)
kill -9 <PID>
```

### Issue: "Generated code out of sync"
**Cause:** Protocol changes not regenerated  
**Solution:**
```bash
cd video_window_server
serverpod generate
```

---

## Next Steps

1. ✅ Setup complete? → Read [02-project-structure.md](./02-project-structure.md)
2. Learn protocol files → Read [03-code-generation.md](./03-code-generation.md)
3. Database work → Read [04-database-migrations.md](./04-database-migrations.md)
4. Auth implementation → Read [05-authentication-sessions.md](./05-authentication-sessions.md)

---

## Quick Reference Commands

```bash
# Start services
docker-compose up -d

# Run server
serverpod run

# Generate code
serverpod generate

# Create migration
serverpod create-migration

# Apply migrations
serverpod migrate

# Stop services
docker-compose down
```

---

## Related Documentation

- **Official Docs:** https://docs.serverpod.dev/
- **Architecture:** `docs/architecture/serverpod-integration-guide.md`
- **Project Structure:** `docs/architecture/project-structure-implementation.md`
- **Coding Standards:** `docs/architecture/coding-standards.md`

---

**Status:** This guide enables Epic 01.1 (Bootstrap Repository) completion without external documentation.
