# Serverpod Database Migrations

**Version:** Serverpod 2.9.x  
**Last Updated:** 2025-10-30

---

## Overview

Serverpod manages database schema through migrations. This guide covers creating, applying, and managing migrations for Video Window.

---

## Database Setup

### PostgreSQL Configuration

**Development:**
```yaml
# config/development.yaml
database:
  host: localhost
  port: 5432
  name: video_window_dev
  user: postgres
  password: postgres
```

**Production:**
```yaml
# config/production.yaml
database:
  host: ${DB_HOST}
  port: ${DB_PORT}
  name: ${DB_NAME}
  user: ${DB_USER}
  password: ${DB_PASSWORD}
  sslMode: require
```

---

## Migration Workflow

### 1. Create Migration

```bash
cd video_window_server

# Serverpod auto-generates migration from protocol
serverpod create-migration
```

**Output:**
```
Creating migration from protocol changes...
✓ Migration file created: migrations/20251030143022_add_auctions.sql

Review the migration before applying:
  - Check ALTER TABLE statements
  - Verify indexes and constraints
  - Test with sample data if needed
```

### 2. Review Migration File

**File:** `migrations/20251030143022_add_auctions.sql`

```sql
--
-- Migration generated by Serverpod
-- Generated: 2025-10-30 14:30:22
--

-- Create auctions table
CREATE TABLE auctions (
  id SERIAL PRIMARY KEY,
  listing_id INTEGER NOT NULL REFERENCES listings(id) ON DELETE CASCADE,
  start_time TIMESTAMP NOT NULL,
  end_time TIMESTAMP NOT NULL,
  min_bid_increment INTEGER NOT NULL DEFAULT 500,
  soft_close_enabled BOOLEAN NOT NULL DEFAULT TRUE,
  extensions_count INTEGER NOT NULL DEFAULT 0,
  status TEXT NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- Create indexes
CREATE INDEX idx_auctions_listing_id ON auctions(listing_id);
CREATE INDEX idx_auctions_end_time ON auctions(end_time);
CREATE INDEX idx_auctions_status ON auctions(status);

-- Create auction_bids table
CREATE TABLE auction_bids (
  id SERIAL PRIMARY KEY,
  auction_id INTEGER NOT NULL REFERENCES auctions(id) ON DELETE CASCADE,
  bidder_id INTEGER NOT NULL REFERENCES users(id),
  amount INTEGER NOT NULL,
  bid_at TIMESTAMP NOT NULL DEFAULT NOW(),
  is_winning BOOLEAN NOT NULL DEFAULT FALSE
);

CREATE INDEX idx_auction_bids_auction_id ON auction_bids(auction_id);
CREATE INDEX idx_auction_bids_bidder_id ON auction_bids(bidder_id);
```

### 3. Apply Migration

```bash
# Apply to development database
serverpod migrate

# Output:
# Applying migration: 20251030143022_add_auctions.sql
# ✓ Migration applied successfully
```

### 4. Verify Migration

```bash
# Check tables exist
psql -h localhost -U postgres -d video_window_dev -c '\dt'

# Check specific table
psql -h localhost -U postgres -d video_window_dev -c '\d auctions'
```

---

## Migration Best Practices

### 1. Always Review Before Applying

```bash
# Review changes
cat migrations/20251030143022_add_auctions.sql

# Test in development first
serverpod migrate

# Only then apply to staging/production
```

### 2. Add Data Migrations Manually

```sql
-- migrations/20251030150000_seed_admin_user.sql

-- Create admin user
INSERT INTO users (email, display_name, role, created_at, updated_at)
VALUES (
  'admin@videowindow.com',
  'System Admin',
  'admin',
  NOW(),
  NOW()
);
```

### 3. Handle Destructive Changes Carefully

```sql
-- ❌ DANGEROUS - Data loss!
DROP TABLE old_table;

-- ✅ SAFE - Backup first
CREATE TABLE old_table_backup AS SELECT * FROM old_table;
-- Then verify backup before dropping
```

### 4. Use Transactions

```sql
BEGIN;

-- All migration statements
ALTER TABLE users ADD COLUMN verified BOOLEAN DEFAULT FALSE;
UPDATE users SET verified = TRUE WHERE email LIKE '%@videowindow.com';

COMMIT;
-- If anything fails, entire migration rolls back
```

---

## Common Scenarios

### Adding a Column

**Protocol:**
```yaml
# user.yaml
class: User
fields:
  id: int, primary
  email: String
  emailVerified: bool  # NEW FIELD
```

**Generated Migration:**
```sql
ALTER TABLE users ADD COLUMN email_verified BOOLEAN NOT NULL DEFAULT FALSE;
```

### Adding an Index

```sql
-- High-traffic query optimization
CREATE INDEX idx_stories_created_at ON stories(created_at DESC);
```

### Adding Foreign Key

```sql
ALTER TABLE stories
ADD CONSTRAINT fk_stories_maker_id
FOREIGN KEY (maker_id)
REFERENCES users(id)
ON DELETE CASCADE;
```

---

## Rollback Strategy

### Manual Rollback

```sql
-- Create rollback file
-- migrations/20251030143022_add_auctions_rollback.sql

DROP TABLE IF EXISTS auction_bids CASCADE;
DROP TABLE IF EXISTS auctions CASCADE;
```

Apply rollback:
```bash
psql -h localhost -U postgres -d video_window_dev \
  -f migrations/20251030143022_add_auctions_rollback.sql
```

---

## Production Deployment

### Pre-Deployment Checklist

- [ ] Migration tested in development
- [ ] Migration tested in staging with production-like data
- [ ] Backup strategy confirmed
- [ ] Rollback plan documented
- [ ] Performance impact assessed
- [ ] Team notified of schema changes

### Deployment Commands

```bash
# 1. Backup database
pg_dump -h $DB_HOST -U $DB_USER $DB_NAME > backup_pre_migration.sql

# 2. Apply migration
cd video_window_server
serverpod migrate --env production

# 3. Verify
psql -h $DB_HOST -U $DB_USER $DB_NAME -c '\dt'

# 4. Deploy application
# (Application deployment commands)
```

---

## Troubleshooting

### Issue: "Migration already applied"
```bash
# Check migration history
psql -h localhost -U postgres -d video_window_dev \
  -c 'SELECT * FROM serverpod_migrations ORDER BY timestamp DESC;'
```

### Issue: "Column already exists"
```sql
-- Use IF NOT EXISTS
ALTER TABLE users ADD COLUMN IF NOT EXISTS verified BOOLEAN DEFAULT FALSE;
```

### Issue: "Cannot drop column with data"
```sql
-- Safe column removal
ALTER TABLE users ALTER COLUMN old_column DROP NOT NULL;  -- Step 1
UPDATE users SET old_column = NULL;  -- Step 2
-- Deploy app that doesn't use column  -- Step 3
-- After verification:
ALTER TABLE users DROP COLUMN old_column;  -- Step 4
```

---

## Related Documentation

- **Setup:** [01-setup-installation.md](./01-setup-installation.md)
- **Code Generation:** [03-code-generation.md](./03-code-generation.md)
- **Authentication:** [05-authentication-sessions.md](./05-authentication-sessions.md)

---

**Key Takeaway:** Always review migrations, test thoroughly, and have a rollback plan before production deployment.
