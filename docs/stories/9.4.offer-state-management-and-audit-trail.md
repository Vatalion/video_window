# Story 9.4: Offer State Management & Audit Trail

## Status
Ready for Dev

## Story
**As a** compliance analyst,
**I want** complete visibility into offer lifecycle events and historical records,
**so that** audits, exports, and customer support rely on immutable data

## Acceptance Criteria
1. **BUSINESS CRITICAL**: `offer_history_endpoint` returns paginated offer timelines with audit entries, supports filtering by status/date, and enforces RBAC for maker, buyer, and admin views.
2. `offer_audit_service.dart` writes immutable records to Postgres + Glacier vault (`offers_audit_glacier.tf`), ensuring WORM retention and export tooling for regulators.
3. Client history view (`offer_history_bloc.dart` and widgets) merges server timeline with local context, supports offline cache, and highlights rule-triggered changes.
4. Monitoring dashboards surface audit ingestion health (Datadog metric `offers.audit.ingest_success_rate`), Glacier export jobs, and queue depth for archival tasks.
5. Tests verify history pagination, RBAC, export integrity hashes, and offline cache reconciliation, achieving ≥80% coverage across services and presentation layers.

## Prerequisites
1. Story 9.2 – Server Validation & Auction Trigger (submission + audit logging baseline)
2. Story 9.3 – Offer Withdrawal & Cancellation (cancellation audit context)
3. Story 6.3 – Content Security & Anti-Piracy System (Glacier retention patterns)
4. Story 2.2 – RBAC Enforcement (role-based access for history views)

## Tasks / Subtasks

### Phase 1 – Audit Persistence & Glacier Archival

- [ ] **BUSINESS CRITICAL - COM-101**: Enhance `offer_audit_service.dart` to write immutable records and Glacier exports (AC: 2) [Source: docs/tech-spec-epic-9.md – Implementation Guide §4]
  - [ ] Persist audit entries with hash chain (previous hash + current payload)
  - [ ] Stream weekly exports to Glacier vault `offers-audit-${ENV}` via AWS Data Lifecycle Manager
  - [ ] Record export job metadata for compliance review
  - [ ] Implement redaction rules for PII while preserving trace IDs
- [ ] Update Terraform (`offers_audit_glacier.tf`) provisioning retention policies, IAM roles, and SNS notifications on archival failures (AC: 2, 4)

### Phase 2 – History Retrieval & Client Experience

- [ ] Build `offer_history_endpoint.dart` with pagination + filters (AC: 1) [Source: docs/tech-spec-epic-9.md – Implementation Guide §4]
  - [ ] Support cursor-based pagination sorted by `created_at`
  - [ ] Filter by status transitions, date ranges, and actor type
  - [ ] Enforce RBAC: buyers see their offers, makers see story offers, admins full access
  - [ ] Return structured timeline entries referencing audit log IDs
- [ ] Implement Flutter history BLoC + widgets (AC: 3) [Source: docs/tech-spec-epic-9.md – Implementation Guide §4]
  - [ ] Merge server timeline with local audit cache from `offers_audit_service.dart`
  - [ ] Surface badges for rule-triggered events (auto rejection, cancellation, acceptance)
  - [ ] Provide offline read-only cache with pull-to-refresh once online
  - [ ] Add export button triggering support workflow for CSV/PDF (hooks into compliance portal)

### Phase 3 – Observability, Testing, & Runbooks

- [ ] Instrument Datadog + Kibana dashboards (AC: 4) [Source: docs/tech-spec-epic-9.md – Monitoring & Analytics]
  - [ ] Metrics: `offers.audit.ingest_success_rate`, `offers.audit.export_latency_ms`
  - [ ] Kibana saved search for audit anomalies (status reversal, hash mismatch)
  - [ ] PagerDuty alerts on export failures or audit gap detection
  - [ ] Update `docs/analytics/offers-dashboard.md` with audit widgets
- [ ] Expand automated test coverage (AC: 5) [Source: docs/tech-spec-epic-9.md – Test Traceability]
  - [ ] Endpoint tests for pagination, filters, RBAC breach attempts
  - [ ] Service tests verifying hash chain integrity + Glacier export scheduling
  - [ ] Widget tests for offline cache merging + timeline rendering
  - [ ] Terraform integration tests validating Glacier vault + SNS wiring

## Dev Notes
### Previous Story Insights
- Story 9.2 established audit logging primitives; extend rather than duplicate schemas. [Source: docs/tech-spec-epic-9.md – Data Models]
- Coordinate with compliance documentation `docs/compliance/security/audit-retention.md` for retention SLAs.

### Data Models
- `OfferAuditLog` includes `old_status`, `new_status`, `reason`, `actor`, `device_info`, and hash chain metadata. [Source: docs/tech-spec-epic-9.md – Data Models]
- `OfferHistoryEntry` aggregates offer snapshot + audit details for timeline rendering. [Source: docs/tech-spec-epic-9.md – Implementation Guide §4]

### API Specifications
- `GET /offers/{offerId}/history` returns paginated timeline entries; supports query params `cursor`, `status`, `from`, `to`. [Source: docs/tech-spec-epic-9.md – Implementation Guide §4]
- Export job API (internal) triggers Glacier retrieval for compliance audits. [Source: docs/tech-spec-epic-9.md – Implementation Guide §4]

### Component Specifications
- Server code: `video_window_server/lib/src/endpoints/offers/offer_history_endpoint.dart`, `offer_audit_service.dart`. [Source: docs/tech-spec-epic-9.md – Source Tree & File Directives]
- Client code: `video_window_flutter/packages/features/commerce/lib/presentation/bloc/offer_history_bloc.dart` + widgets. [Source: docs/tech-spec-epic-9.md – Source Tree & File Directives]
- Infrastructure: `infrastructure/terraform/offers_audit_glacier.tf` for archival setup. [Source: docs/tech-spec-epic-9.md – Source Tree & File Directives]

### Testing Requirements
- Unit + integration coverage ≥80% for history endpoint/service and client history bloc/widgets. [Source: docs/tech-spec-epic-9.md – Test Traceability]
- Hash chain integrity tested with tampering simulations; test fails if mismatch not detected. [Source: docs/tech-spec-epic-9.md – Implementation Guide §4]
- Glacier export simulation in staging verifying SNS failure alerts route to on-call. [Source: docs/tech-spec-epic-9.md – Monitoring & Analytics]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2025-10-29 | v1.0    | Definitive scope for offer history + audit retention mapped to Implementation Guide §4 | GitHub Copilot AI |

## Dev Agent Record
### Agent Model Used
_(To be completed by Dev Agent)_

### Debug Log References
_(To be completed by Dev Agent)_

### Completion Notes List
_(To be completed by Dev Agent)_

### File List
_(To be completed by Dev Agent)_

## QA Results
_(To be completed by QA Agent)_
