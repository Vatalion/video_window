# Story 1.1: Implement Email OTP Sign-In

## Status
Ready for Dev

## Story
**As a** user (viewer or maker),
**I want** to sign in with email one-time passwords,
**so that** I can access the marketplace without needing a password

## Acceptance Criteria
1. OTP-based email flow with multi-layer rate limiting, account lockout, and comprehensive success/failure messaging.
2. Secure token storage using enhanced Flutter secure storage with AES-256-GCM encryption, RS256 JWT tokens, 15-minute expiry, and automatic refresh rotation via Serverpod.
3. Integration tests cover happy path, invalid OTP attempts, brute force resistance, and token manipulation scenarios.
4. **SECURITY CRITICAL**: Implement cryptographically secure OTP generation with user-specific salts and 5-minute maximum validity.
5. **SECURITY CRITICAL**: Implement progressive account lockout (5 failed attempts → 30 min → 1 hour → 24 hour locks).
6. **SECURITY CRITICAL**: Implement comprehensive JWT token validation with device binding and token blacklisting.
7. **UNIFIED AUTH**: Same authentication flow serves both viewers and makers, with role differentiation happening after successful sign-in.

## Prerequisites
1. Story 01.1 – Bootstrap Repository and Flutter App (monorepo structure, melos tooling, Serverpod baseline)
2. Security research: `security/story-1.1-authentication-security-research.md`

## Tasks / Subtasks

### Phase 1 Critical Security Controls (SEC-001 & SEC-003 Mitigation)

- [ ] **SECURITY CRITICAL - SEC-001**: Implement cryptographically secure OTP generation service with user-specific salts and SHA-256 hashing (AC: 4, 6) [Source: security/story-1.1-authentication-security-research.md#otp-security-best-practices]
  - [ ] Use Random.secure() for 6-digit code generation with 5-minute maximum validity
  - [ ] Store OTP hashes only, never plaintext, with user-specific salt generation
  - [ ] Implement one-time use enforcement and immediate OTP invalidation after successful use
- [ ] **SECURITY CRITICAL - SEC-001**: Implement multi-layer rate limiting with Redis-based enforcement (AC: 1, 4, 5) [Source: security/story-1.1-authentication-security-research.md#comprehensive-rate-limiting-strategy]
  - [ ] Layer 1: Per-identifier rate limiting (3 requests/5min, 5 requests/1hr, 10 requests/24hr)
  - [ ] Layer 2: Per-IP rate limiting (20 requests/5min, 100 requests/1hr)
  - [ ] Layer 3: Global rate limiting with progressive delays for failed attempts
- [ ] **SECURITY CRITICAL - SEC-001**: Implement progressive account lockout mechanism (AC: 5) [Source: security/story-1.1-authentication-security-research.md#account-lockout-mechanisms]
  - [ ] 3 failed attempts → 5 minute lock
  - [ ] 5 failed attempts → 30 minute lock
  - [ ] 10 failed attempts → 1 hour lock
  - [ ] 15 failed attempts → 24 hour lock
  - [ ] Secure email notifications for account lockouts
- [ ] **SECURITY CRITICAL - SEC-003**: Implement secure JWT token generation with RS256 asymmetric encryption (AC: 2, 6) [Source: security/story-1.1-authentication-security-research.md#secure-jwt-implementation]
  - [ ] Use RS256 algorithm with asymmetric key pairs (more secure than HS256)
  - [ ] Set 15-minute access token expiry with comprehensive claims (jti, device_id, session_id)
  - [ ] Implement key rotation policy with secure key management
- [ ] **SECURITY CRITICAL - SEC-003**: Implement refresh token rotation with reuse detection (AC: 2, 6) [Source: security/story-1.1-authentication-security-research.md#refresh-token-rotation-strategy]
  - [ ] Rotate refresh tokens on every use with immediate invalidation of old tokens
  - [ ] Detect token reuse attempts and invalidate all user tokens on suspicious activity
  - [ ] Implement token usage logging and security alerting
- [ ] **SECURITY CRITICAL - SEC-003**: Implement comprehensive token validation with blacklisting (AC: 6) [Source: security/story-1.1-authentication-security-research.md#comprehensive-token-validation]
  - [ ] Validate token signatures, claims, and device binding
  - [ ] Check token blacklist for revoked/invalidated tokens
  - [ ] Implement suspicious activity detection and automated responses
- [ ] **SECURITY CRITICAL - SEC-003**: Implement enhanced Flutter secure storage with AES-256-GCM encryption (AC: 2) [Source: security/story-1.1-authentication-security-research.md#secure-token-storage-pattern]
  - [ ] Encrypt tokens at rest using AES-256-GCM with secure key derivation
  - [ ] Configure platform-specific security (iOS Keychain, Android Keystore)
  - [ ] Prevent iCloud sync and enforce device-only storage

### Standard Implementation Tasks

- [ ] Implement OTP request UI and BLoC state to capture email identifiers using shared design tokens (AC: 1) [Source: architecture/front-end-architecture.md#module-overview] [Source: architecture/front-end-architecture.md#state-management]
  - [ ] Add validation and user feedback for success, failure, and rate-limit messaging via shared error surfaces (AC: 1) [Source: architecture/front-end-architecture.md#error-handling]
- [ ] Connect the OTP request flow to the Identity service `POST /auth/email/send-otp`, handling 200 and 429 responses with SendGrid dispatch (AC: 1) [Source: architecture/architecture.md#identity-service] [Source: architecture/architecture.md#rest-api-spec-excerpt]
  - [ ] Emit analytics events for OTP request attempts via the analytics service, aligning with analytics naming conventions and coordinating any new OTP event entries (AC: 1) [Source: architecture/front-end-architecture.md#analytics-instrumentation] [Source: analytics/mvp-analytics-events.md#conventions] [Source: prd.md#functional-requirements]
- [ ] Persist and rotate session tokens securely within the auth module, aligning with enhanced session management patterns (AC: 2) [Source: architecture/story-component-mapping.md#epic-1--viewer-authentication--session-handling] [Source: architecture/architecture.md#security]
  - [ ] Provide logout/revocation hooks to clear secure storage and notify backend of token revocation (AC: 2) [Source: architecture/architecture.md#security]

### Security Testing Requirements

- [ ] Cover OTP success and invalid attempts with comprehensive security testing including brute force resistance and token manipulation scenarios (AC: 3) [Source: security/story-1.1-authentication-security-research.md#security-testing-requirements]
  - [ ] Test brute force resistance (1000+ OTP combinations within rate limits)
  - [ ] Test token manipulation resistance (signature forgery, claim modification)
  - [ ] Test session hijacking resistance (token reuse, device binding)
  - [ ] Test OTP interception resistance (hashed storage, expiration, one-time use)

## Dev Notes
### Previous Story Insights
- No earlier Epic 1 stories are recorded, so there are no prior implementation lessons to apply. [Source: architecture/story-component-mapping.md#epic-1--viewer-authentication--session-handling]

### Data Models
- The `users` table stores unique emails or optional phone numbers alongside roles and auth provider metadata, enabling OTP flows for viewers. [Source: docs/tech-spec-epic-1.md#data-models]
- Identity service modules rely on Postgres `users` and `sessions` tables to manage token issuance and refresh logic. [Source: docs/tech-spec-epic-1.md#database-migrations]

### API Specifications
- `POST /auth/email/send-otp` accepts an email address and returns 200 on dispatch or 429 when the rate limit is exceeded. [Source: docs/tech-spec-epic-1.md#authentication-endpoints]
- OTP delivery leverages SendGrid for email with per-user rate enforcement; log message IDs only for audit purposes. [Source: docs/tech-spec-epic-1.md#monitoring-and-analytics]

### Component Specifications
- Flutter `auth` module owns OTP, session refresh, and logout UX; Identity service on Serverpod federates OTP and social login. [Source: docs/tech-spec-epic-1.md#implementation-details]
- BLoC-based state management and feature-scoped BLoCs orchestrate auth flows, with components organized under `features/auth/` layers. [Source: architecture/front-end-architecture.md#state-management]
- Use shared analytics service injection to record auth events instead of duplicating event names. [Source: docs/tech-spec-epic-1.md#monitoring-and-analytics]

### File Locations
- UI and state code for this story belong under `video_window_flutter/packages/features/auth/lib/` following presentation, application, domain, and infrastructure layering. [Source: architecture/architecture.md#source-tree]
- Tests should mirror feature paths under `video_window_flutter/packages/features/auth/test/` to match the project structure. [Source: architecture/architecture.md#testing-strategy]

### Testing Requirements
- Maintain ≥80% coverage and include integration coverage for identity flows, running `flutter test --no-pub` in CI. [Source: architecture/architecture.md#testing-strategy]
- Auth BLoCs and widgets should use bloc_test package and widget tests for critical screens. [Source: architecture/front-end-architecture.md#testing-strategy-client]

### Technical Constraints
- Authentication uses OTP for email with JWT/session tokens and requires enhanced refresh handling plus logout revocation with security monitoring. [Source: architecture/architecture.md#security] [Source: security/story-1.1-authentication-security-research.md]
- **SECURITY CRITICAL**: All OTP implementations must use cryptographically secure generation with user-specific salts and never store plaintext OTPs. [Source: security/story-1.1-authentication-security-research.md#cryptographic-otp-generation]
- **SECURITY CRITICAL**: JWT tokens must use RS256 asymmetric encryption with 15-minute expiry and comprehensive claims including device binding. [Source: security/story-1.1-authentication-security-research.md#secure-jwt-implementation]
- **SECURITY CRITICAL**: Rate limiting must be multi-layer (per-identifier, per-IP, global) with progressive account lockout mechanisms. [Source: security/story-1.1-authentication-security-research.md#comprehensive-rate-limiting-strategy]
- **SECURITY CRITICAL**: Flutter secure storage must use AES-256-GCM encryption with platform-specific security configurations. [Source: security/story-1.1-authentication-security-research.md#secure-token-storage-pattern]
- Email delivery service rate limits apply; implement client-side rate messaging aligned with backend protections.
- Error handling must surface friendly messages and retry actions via shared `ErrorView` components. [Source: architecture/front-end-architecture.md#error-handling]
- All security controls must implement comprehensive logging and monitoring for security incident detection. [Source: security/story-1.1-authentication-security-research.md#monitoring-and-alerting-configuration]

### Project Structure Notes
- Planned changes align with the documented monorepo structure rooted in `video_window_flutter/`; no deviations identified. [Source: architecture/architecture.md#source-tree]

## Testing
- Follow the project testing pipeline by running `dart format`, `flutter analyze`, and `flutter test --no-pub` before submission. [Source: architecture/architecture.md#testing-strategy]
- Add BLoC and widget tests for OTP flows with fixtures covering success and invalid OTP attempts. [Source: architecture/front-end-architecture.md#testing-strategy-client]

## Change Log
| Date       | Version | Description        | Author             |
| ---------- | ------- | ------------------ | ------------------ |
| 2025-09-30 | v0.1    | Initial draft created | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
_(To be completed by Dev Agent)_

### Debug Log References
_(To be completed by Dev Agent)_

### Completion Notes List
_(To be completed by Dev Agent)_

### File List
_(To be completed by Dev Agent)_

## QA Results
_(To be completed by QA Agent)_
