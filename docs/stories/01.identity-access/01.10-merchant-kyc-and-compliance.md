# Story 01.10: Merchant KYC and Compliance Onboarding

## Status
**Status:** Ready for Development
**Priority:** High
**Epic**: Identity & Access Foundation

## Story
**As a** marketplace operator,
**I want** a progressive merchant onboarding flow with real-time status events,
**so that** compliant sellers can start monetizing quickly while maintaining regulatory requirements.

## Business Value
- **Problem**: Manual merchant reviews delay first sales and marketplace momentum, causing missed revenue opportunities and seller frustration.
- **Solution**: Implement progressive onboarding with automated verification, real-time status propagation, and risk-based tiers for faster time-to-revenue.
- **Impact**: Reduce time-to-first-listing by 70%, increase merchant satisfaction by 50%, and maintain 100% regulatory compliance.

## Acceptance Criteria
1. **Progressive Tiers:** Low-risk merchants can list products with capped limits (e.g., $1,000/month) pending full KYC; automated near-real-time document checks enable first listings within 60 minutes.
2. **Event-Driven Architecture:** Webhooks queue → domain events → catalog/payout gating within 5 minutes; real-time status propagation prevents stale states across downstream services.
3. **Performance KPIs:** Time-to-first-listing p50 < 60 min, automated pass rate > 70%, manual queue SLA p95 < 24h; track remediation success rates and time-to-compliance.
4. **Merchant Readiness Scorecard:** Interactive checklist with nudges for missing requirements; sandbox mode allows catalog setup pre-approval with clear progression path.
5. **Automated Risk Tiers:** Real-time document scanning with configurable risk thresholds; progressive limits scale based on verification completeness and risk assessment.
6. **Status Propagation:** Merchant status changes instantly update catalog visibility, payout eligibility, and publishing permissions via event-driven architecture with audit trails.
7. **Compliance Automation:** Periodic reverification triggers on regulation/data changes; automated workflows handle routine updates while flagging high-risk cases for manual review.

## Tasks / Subtasks
- [ ] **Task 1: Progressive Onboarding Flow (AC: 1, 3, 4)**
  - [ ] Create progressive merchant onboarding UI under `lib/features/merchant/presentation/screens/onboarding/`
  - [ ] Implement risk-based tier system with capped limits for partial KYC
  - [ ] Build merchant readiness scorecard with interactive checklist
  - [ ] Design sandbox mode for catalog setup pre-approval
  - [ ] Create onboarding performance tracking (p50 < 60 min, automated pass rate > 70%)

- [ ] **Task 2: Event-Driven Architecture (AC: 2, 6, 7)**
  - [ ] Implement webhook queue system for merchant status changes
  - [ ] Create domain events for status propagation to catalog/payout systems
  - [ ] Build real-time status updates with <5 minute SLA
  - [ ] Configure audit trails for all merchant status changes
  - [ ] Set up monitoring for stale state prevention across services

- [ ] **Task 3: Automated Verification Engine (AC: 1, 3, 5, 7)**
  - [ ] Implement real-time document scanning service in `lib/features/merchant/data/services/verification_service.dart`
  - [ ] Build configurable risk thresholds and scoring system
  - [ ] Create progressive limit scaling based on verification completeness
  - [ ] Configure automated document check processing with near-real-time results
  - [ ] Set up periodic reverification triggers for regulatory changes

- [ ] **Task 4: KYC/KYB Integration (AC: 1, 3, 5, 7)**
  - [ ] Integrate with KYC/KYB provider APIs for identity verification
  - [ ] Implement document upload and validation workflows
  - [ ] Build sanctions screening and compliance checking
  - [ ] Create automated risk assessment with manual review escalation
  - [ ] Configure compliance automation for regulatory changes

- [ ] **Task 5: Mobile-First Merchant Experience (AC: 1, 4, 6)**
  - [ ] Optimize onboarding flow for mobile document capture
  - [ ] Implement camera integration for document scanning using `camera`
  - [ ] Build mobile-friendly document upload with progress tracking
  - [ ] Create push notification system for onboarding status updates
  - [ ] Configure offline capabilities for onboarding continuity

- [ ] **Task 6: Admin & Review Tools (AC: 3, 5, 7)**
  - [ ] Create admin dashboard for manual review queues
  - [ ] Build merchant management interface for compliance teams
  - [ ] Implement remediation workflow tracking and success metrics
  - [ ] Configure manual queue SLA monitoring (p95 < 24h)
  - [ ] Set up compliance reporting and audit trail access

- [ ] **Task 7: Testing & Quality Assurance (AC: 1-7)**
  - [ ] Create comprehensive unit tests in `test/features/merchant/onboarding/`
  - [ ] Build integration tests for event-driven status propagation
  - [ ] Implement performance testing for onboarding SLAs
  - [ ] Conduct compliance validation for regulatory requirements
  - [ ] Create test automation for document verification scenarios

## Dev Notes
- **Architecture Alignment**: Follow clean architecture pattern with event-driven communication. Integrate with existing auth and profile systems from Stories 01.01-01.09.
- **Mobile-First KYC**: Use `camera` for document capture, `image_picker` for photo uploads, `flutter_secure_storage` for sensitive merchant data, and `connectivity_plus` for network-aware verification.
- **Event-Driven Design**: Implement domain events for merchant status changes with guaranteed delivery. Use webhooks for external system integration with retry mechanisms.
- **Risk-Based Approach**: Focus on progressive verification that allows low-risk merchants to start selling quickly while maintaining compliance. Use configurable thresholds for risk assessment.
- **Compliance Focus**: Build GDPR/CCPA compliance into core workflows. Ensure data retention policies and audit trails meet regulatory requirements.
- **Performance Targets**: Optimize for mobile document processing and verification. Target <60 minutes for first listing and <5 minutes for status propagation.

### Testing
- **Test Location**: `test/features/merchant/onboarding/` following existing feature test structure
- **Testing Framework**: Use `flutter_test` and `test` packages with comprehensive mocking for KYC providers
- **Test Coverage**: Target >90% coverage for critical onboarding paths and compliance workflows
- **Performance Testing**: Document verification < 10 min, status propagation < 5 min, onboarding completion < 60 min
- **Compliance Testing**: Validate regulatory requirements through automated test suites
- **Integration Testing**: Test event propagation to catalog, payout, and publishing systems

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-22 | 1.0 | Initial story refinement with template compliance and mobile-first requirements | PO-Refinement-Agent-01 |

## Dev Agent Record

### Agent Model Used
- _To be added by dev agent_

### Debug Log References
- .ai/debug-log.md

### Completion Notes List
- _To be added by dev agent_

### File List
- Added: _TBD_
- Modified: _TBD_
- Deleted: _TBD_

## QA Results
### Review Date: YYYY-MM-DD

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

[Overall assessment]

### Refactoring Performed

- File: path/to/file
  - Change: summary
  - Why: rationale
  - How: improvement

### Compliance Check
- Coding Standards: ✓/✗ notes
- Project Structure: ✓/✗ notes
- Testing Strategy: ✓/✗ notes
- All ACs Met: ✓/✗ notes

### Improvements Checklist
- [ ] Item for dev to address

### Security Review
[notes]

### Performance Considerations
[notes]

### Final Status
[✓ Approved - Ready for Done] / [✗ Changes Required]

## Success Metrics
- **Business Metric**: Time-to-first-listing reduction of 70%, merchant satisfaction increase of 50%, automated verification rate of 70%
- **Technical Metric**: Status propagation time < 5 min, document verification p95 < 10 min, system availability 99.9%, compliance accuracy > 99%
- **User Metric**: Merchant onboarding completion rate > 85%, support ticket reduction for onboarding issues by 60%, trust in compliance process score > 4.5/5

## Technical Requirements
- Implement progressive tier system with risk-based limits and automated verification
- Deploy event-driven architecture with real-time status propagation and webhook handling
- Configure document scanning service with near-real-time processing and risk assessment
- Build merchant readiness scorecard with interactive checklist and sandbox mode
- Ensure compliance automation with periodic reverification and regulatory change detection
- Develop status propagation system with catalog, payout, and publishing integration
- Implement comprehensive analytics for onboarding funnel and risk trends

## Dependencies
- **Technical**: KYC/KYB provider APIs, webhook infrastructure, risk scoring service, document verification services
- **Business**: Legal team for compliance requirements, compliance team for review procedures, UX team for onboarding flows
- **Prerequisites**: Story 01.07 (User Profile) for base merchant profiles, Story 01.09 (Privacy Security Audit) for audit trails

## Out of Scope
- Advanced due diligence for high-risk merchants beyond standard KYC/KYB
- Complex underwriting or credit assessment beyond basic risk scoring
- International compliance beyond major regulated markets
- Advanced merchant analytics beyond basic onboarding tracking

## Related Files
- `/Volumes/workspace/projects/flutter/video_window/docs/prd.md` - Compliance requirements and marketplace strategy
- `/Volumes/workspace/projects/flutter/video_window/docs/architecture/tech-stack.md` - Technical architecture and integration patterns
- `/Volumes/workspace/projects/flutter/video_window/lib/features/merchant/` - Merchant onboarding module structure
- `/Volumes/workspace/projects/flutter/video_window/lib/api/merchant/` - Merchant API clients and endpoints
- `/Volumes/workspace/projects/flutter/video_window/docs/stories/07.admin-analytics/07.01-admin-dashboard.md` - Admin review interface

## Notes
- Progressive onboarding balances speed with security, allowing low-risk merchants to start selling quickly
- Event-driven architecture ensures real-time status synchronization across all downstream systems
- Automated verification with human oversight maintains compliance while reducing manual processing time
- Risk-based tiers enable graduated access based on verification completeness and trust level
- Sandbox mode allows merchants to prepare catalogs before full approval, reducing time-to-revenue

## PO Validation Review (2025-09-22)
- Critical Issues impacting product impact
  - Onboarding too manual; delays first sale. Lacks progressive limits and near-real-time document checks.
  - No explicit webhook/event design for status propagation to catalog/payouts; risks stale states.
  - Measurement gaps for time-to-merchant-live and remediation success.
- Should-Fix to unblock
  - Progressive tiers: allow low-risk merchants to list with capped limits pending full KYC.
  - Event-driven architecture: webhooks queue -> domain events -> catalog/payout gating within 5 minutes.
  - KPIs: time-to-first-listing p50 < 60 min, automated pass rate > 70%, manual queue SLA p95 < 24h; track remediation success.
- Nice-to-Have (high leverage)
  - Merchant readiness scorecard with checklist and nudges; sandbox mode for catalog setup pre-approval.
- Final Assessment
  - Decision: Conditional GO — ship progressive onboarding with events and SLAs.
  - Implementation Readiness Score: 7 / 10
  - Confidence Level: Medium

## Status
**Status:** Ready for Development

## Priority
High

## PO Validation Review (2025-02-14)
- **Template Compliance Issues**
  - Story follows narrative format; template sections (`Dev Notes`, `Testing`, `Change Log`, agent records) missing and tasks lack checkbox structure tied to acceptance criteria.
- **Critical Issues (Story Blocked)**
  - No Dev Notes identifying KYC provider architecture, webhook handling, or risk scoring design; teams lack integration guidance.
  - Testing plan absent—need coverage for document validation, sanctions screening, manual review SLAs, and periodic reverification.
  - Merchant onboarding relies on manual reviews that delay catalog readiness and stall marketplace momentum.
- **Should-Fix Issues**
  - Acceptance Criteria contain timing expectations (5-minute propagation, 7-year retention) without instrumentation or ownership.
  - Tasks high level; map to specific services, data stores, and compliance stakeholders to avoid gaps.
  - Privacy obligations (redaction, archive encryption) require references to legal policies and operational runbooks.
  - Adopt near-real-time document scanning, risk tiers, and progressive limits so new sellers can merchandise within their first hour.
- **Nice-to-Have Improvements**
  - Add analytics/reporting requirements for onboarding funnel, risk trends, and manual queue load.
  - Provide UX copy/flows for remediation guidance and document re-upload.
  - Instrument onboarding funnel drop-offs and coach merchants with readiness scorecards and compliance nudges.
- **Anti-Hallucination Findings**
  - Event name `merchant.onboarding.updated` and automation hooks must be confirmed with platform architecture.
- **Final Assessment**
  - Decision: **NO-GO**
  - Implementation Readiness Score: **5 / 10**
  - Confidence Level: **Low**

  - Merchant onboarding relies on manual reviews that delay catalog readiness and stall marketplace momentum.
  - Adopt near-real-time document scanning, risk tiers, and progressive limits so new sellers can merchandise within their first hour.
  - Instrument onboarding funnel drop-offs and coach merchants with readiness scorecards and compliance nudges.
## Story
As a marketplace operator, I want a progressive merchant onboarding flow with real-time status events, so that compliant sellers can start monetizing quickly while maintaining regulatory requirements.

## Context
- Trust and safety for end-to-end social commerce requires rigorous merchant vetting before catalog creation or live commerce streaming begins.
- Regulatory obligations (e.g., BSA/AML, PSD2, EU ML Directives) require auditable KYC, sanctions screening, and ongoing monitoring.
- Downstream features (catalog management, payouts, live commerce) depend on reliable merchant status signals.

## Acceptance Criteria
1. **Progressive Tiers:** Low-risk merchants can list products with capped limits (e.g., $1,000/month) pending full KYC; automated near-real-time document checks enable first listings within 60 minutes.
2. **Event-Driven Architecture:** Webhooks queue → domain events → catalog/payout gating within 5 minutes; real-time status propagation prevents stale states across downstream services.
3. **Performance KPIs:** Time-to-first-listing p50 < 60 min, automated pass rate > 70%, manual queue SLA p95 < 24h; track remediation success rates and time-to-compliance.
4. **Merchant Readiness Scorecard:** Interactive checklist with nudges for missing requirements; sandbox mode allows catalog setup pre-approval with clear progression path.
5. **Automated Risk Tiers:** Real-time document scanning with configurable risk thresholds; progressive limits scale based on verification completeness and risk assessment.
6. **Status Propagation:** Merchant status changes instantly update catalog visibility, payout eligibility, and publishing permissions via event-driven architecture with audit trails.
7. **Compliance Automation:** Periodic reverification triggers on regulation/data changes; automated workflows handle routine updates while flagging high-risk cases for manual review.

## Edge Cases
- Mismatched names between legal documents and payment accounts.
- Multi-owner entities requiring sequential identity verification.
- Document upload failures in low-connectivity situations (retry/backoff).
- Sanctions provider downtime (fallback queues with alerting).
- Merchant re-submission after previous denial (diff tracking, manual override).

## Dependencies
- Identity verification service (KYC/KYB provider) with async webhook callbacks.
- Payments/payout orchestration for risk-based blocking.
- Admin dashboards for manual review (see `docs/stories/07.admin-analytics/07.01-admin-dashboard.md`).
- Privacy and audit services (`docs/stories/01.identity-access/01.09-privacy-security-audit.md`).

## Technical Implementation Details
- Store sensitive artifacts using envelope encryption; restrict access via RBAC.
- Use job queue for long-running external checks; emit domain events (`merchant.onboarding.updated`).
- Localize consent and disclosure text based on merchant locale with fallback content.
- Provide API/SDK hooks for future automation (bulk onboarding, marketplace partners).

## Analytics & Monitoring
- Track funnel metrics (start, document submitted, automated pass, manual review, approval).
- Monitor average processing time, high-risk percentage, and manual workload.
- Alert on provider failures, SLA breaches, and abnormal risk spikes.

## Tasks
- [ ] Design merchant onboarding UX with progressive disclosure and responsive layout.
- [ ] Integrate KYC/KYB provider APIs and configure sanctions screening workflows.
- [ ] Implement risk scoring service with configurable thresholds and manual review routing.
- [ ] Build merchant review workspace with audit logging, evidence attachments, and decision capture.
- [ ] Emit onboarding status events and propagate to catalog/publishing/payout systems.
- [ ] Instrument onboarding metrics, alerts, and documentation for compliance teams.

## PO Validation Review (2025-09-22)
- **Overall Rating**: **Conditional GO**
- **Strengths found**:
  - Clear regulatory requirements and compliance focus
  - Good integration points with existing systems
  - Well-defined risk scoring approach
- **Areas for improvement**:
  - Onboarding too manual; delays first sale. Lacks progressive limits and near-real-time document checks.
  - No explicit webhook/event design for status propagation to catalog/payouts; risks stale states.
  - Measurement gaps for time-to-merchant-live and remediation success.
- **Specific recommendations**:
  - Progressive tiers: allow low-risk merchants to list with capped limits pending full KYC.
  - Event-driven architecture: webhooks queue -> domain events -> catalog/payout gating within 5 minutes.
  - KPIs: time-to-first-listing p50 < 60 min, automated pass rate > 70%, manual queue SLA p95 < 24h; track remediation success.
- **Nice-to-Have (high leverage)**:
  - Merchant readiness scorecard with checklist and nudges; sandbox mode for catalog setup pre-approval.
- **Ready for development?**: **With Changes** - Needs progressive onboarding, events, and SLAs.

## PO Validation Review (2025-02-14)
- **Template Compliance Issues**
  - Story follows narrative format; template sections (`Dev Notes`, `Testing`, `Change Log`, agent records) missing and tasks lack checkbox structure tied to acceptance criteria.
- **Critical Issues (Story Blocked)**
  - No Dev Notes identifying KYC provider architecture, webhook handling, or risk scoring design; teams lack integration guidance.
  - Testing plan absent—need coverage for document validation, sanctions screening, manual review SLAs, and periodic reverification.
  - Merchant onboarding relies on manual reviews that delay catalog readiness and stall marketplace momentum.
- **Should-Fix Issues**
  - Acceptance Criteria contain timing expectations (5-minute propagation, 7-year retention) without instrumentation or ownership.
  - Tasks high level; map to specific services, data stores, and compliance stakeholders to avoid gaps.
  - Privacy obligations (redaction, archive encryption) require references to legal policies and operational runbooks.
  - Adopt near-real-time document scanning, risk tiers, and progressive limits so new sellers can merchandise within their first hour.
- **Nice-to-Have Improvements**
  - Add analytics/reporting requirements for onboarding funnel, risk trends, and manual queue load.
  - Provide UX copy/flows for remediation guidance and document re-upload.
  - Instrument onboarding funnel drop-offs and coach merchants with readiness scorecards and compliance nudges.
- **Anti-Hallucination Findings**
  - Event name `merchant.onboarding.updated` and automation hooks must be confirmed with platform architecture.
- **Final Assessment**
  - Decision: **NO-GO**
  - Implementation Readiness Score: **5 / 10**
  - Confidence Level: **Low**
