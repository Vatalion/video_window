# Story 13.1: Shipping Address Management

## Status
Ready for Dev

## Story
**As a** winning bidder,
**I want** to provide accurate shipping information during checkout,
**so that** my purchased item can be delivered successfully

## Acceptance Criteria
1. **BUSINESS CRITICAL**: Buyer can enter shipping address during Stripe checkout session with address validation preventing undeliverable locations and fraud risk addresses.
2. Address validation ensures deliverable location using USPS/Google Maps APIs with real-time feedback on invalid addresses and suggested corrections.
3. Buyer can save multiple addresses in address book for future purchases with default address selection and address nickname management.
4. **BUSINESS CRITICAL**: International shipping restrictions are enforced per item based on maker preferences, with clear messaging when item cannot ship to buyer's location.
5. **PERFORMANCE CRITICAL**: Shipping cost calculation is shown before payment with real-time carrier rate shopping across USPS, FedEx, UPS based on item dimensions and destination.
6. Address changes are possible before maker ships item (within 72-hour window) with automatic notification to maker of updated shipping destination.

## Prerequisites
1. Story 12.1 – Stripe Checkout Integration (checkout session creation and payment flow)
2. Story 10.3 – Auction State Transitions (auction winning and order creation)
3. Story 3.1 – Viewer Profile Management (user profile and saved addresses)
4. Stripe account configured with shipping address collection enabled
5. Shipping provider API accounts (USPS, FedEx, UPS) with sandbox access

## Tasks / Subtasks

### Phase 1 – Stripe Checkout Address Integration

- [ ] **BUSINESS CRITICAL**: Configure Stripe checkout for address collection (AC: 1) [Source: docs/tech-spec-epic-13.md – Shipping Address Management]
  - [ ] Enable shipping address collection in Stripe checkout session configuration
  - [ ] Configure allowed countries based on maker shipping preferences
  - [ ] Set address validation rules (require phone number, full street address)
  - [ ] Collect buyer name and phone number for shipping label generation
  - [ ] Store collected address in order entity after successful payment
- [ ] Implement address validation service (AC: 2) [Source: docs/tech-spec-epic-13.md – Shipping Address Management]
  - [ ] Integrate USPS Address Validation API for US addresses
  - [ ] Integrate Google Maps Geocoding API for international addresses
  - [ ] Validate address deliverability and format standardization
  - [ ] Provide suggested corrections for invalid/incomplete addresses
  - [ ] Flag high-risk addresses (PO boxes for restricted items, freight forwards)
- [ ] Enforce international shipping restrictions (AC: 4) [Source: docs/tech-spec-epic-13.md – Shipping Address Management]
  - [ ] Check maker's allowed shipping countries against buyer address
  - [ ] Display error message if item cannot ship to destination
  - [ ] Show alternative shipping options if maker offers international
  - [ ] Block checkout session creation for restricted destinations
  - [ ] Log restriction events for maker analytics and policy adjustments

### Phase 2 – Address Book Management

- [ ] Build user address book functionality (AC: 3) [Source: docs/tech-spec-epic-13.md – Shipping Address Management]
  - [ ] Create `user_addresses` table with address components and metadata
  - [ ] Implement `AddressBookPage` in buyer profile section
  - [ ] Enable add/edit/delete operations on saved addresses
  - [ ] Support address nicknames (Home, Work, Gift Recipient, etc.)
  - [ ] Validate addresses upon save with standardization
- [ ] Implement default address selection (AC: 3) [Source: docs/tech-spec-epic-13.md – Shipping Address Management]
  - [ ] Allow buyer to mark one address as default shipping address
  - [ ] Pre-select default address in Stripe checkout when available
  - [ ] Display "Use Different Address" option during checkout
  - [ ] Update default address flag in database with unique constraint
  - [ ] Sync default address preference across sessions
- [ ] Create address change workflow pre-shipment (AC: 6) [Source: docs/tech-spec-epic-13.md – Shipping Address Management]
  - [ ] Add "Change Shipping Address" action on order detail page
  - [ ] Restrict address changes to 72-hour window after order completion
  - [ ] Show address selection from saved addresses or new address entry
  - [ ] Recalculate shipping cost if destination zone changes
  - [ ] Notify maker of address change via email and in-app notification

### Phase 3 – Shipping Cost Calculation

- [ ] **PERFORMANCE CRITICAL**: Integrate shipping provider APIs for rate shopping (AC: 5) [Source: docs/tech-spec-epic-13.md – Shipping Cost Calculation]
  - [ ] Integrate USPS Rates API for domestic US shipping
  - [ ] Integrate FedEx Rates API for express and international options
  - [ ] Integrate UPS Rates API for ground and priority shipping
  - [ ] Query all providers in parallel with 3-second timeout
  - [ ] Cache rate quotes for 15 minutes to optimize performance
- [ ] Implement dynamic cost display during checkout (AC: 5) [Source: docs/tech-spec-epic-13.md – Shipping Cost Calculation]
  - [ ] Calculate shipping costs based on item dimensions and weight
  - [ ] Display multiple carrier options with delivery timeframes
  - [ ] Show cheapest option as default selection
  - [ ] Update Stripe checkout line items with selected shipping cost
  - [ ] Display total cost breakdown (item + shipping + tax) before payment
- [ ] Build international shipping premium calculation (AC: 5) [Source: docs/tech-spec-epic-13.md – Shipping Cost Calculation]
  - [ ] Add international shipping surcharges based on destination zone
  - [ ] Calculate customs fees and import duties (buyer responsibility)
  - [ ] Display estimated total landed cost for international orders
  - [ ] Show delivery time estimates (7-21 days typical for international)
  - [ ] Warn buyers about potential customs delays and clearance requirements

## Dev Notes

### Previous Story Insights
- This is the first story in Epic 13, building the foundation for order fulfillment. It integrates tightly with Epic 12 (Payments) checkout flow and enables Story 13.2 (tracking integration).

### Data Models
- `UserAddress` entity: id, user_id, address_line1, address_line2, city, state, postal_code, country, phone, is_default, nickname, validated_at. [Source: docs/tech-spec-epic-13.md – Data Models]
- `Order` entity adds `shipping_address` JSONB field storing complete address snapshot at time of order. [Source: docs/tech-spec-epic-13.md – Data Models]
- `ShippingRate` cache: carrier, service_level, cost, delivery_days, expires_at for rate quote optimization. [Source: docs/tech-spec-epic-13.md – Shipping Cost Calculation]

### API Specifications
- `POST /orders/{id}/shipping-address` updates shipping address for orders in pending_shipment status (within 72h window). [Source: docs/tech-spec-epic-13.md – Shipping Address Management]
- `GET /shipping/rates` accepts item_dimensions, origin_zip, destination_address and returns carrier rate array.
- USPS API: Address Validation Web Tool for standardization and deliverability checks.
- FedEx/UPS APIs: Rate shopping with pickup/delivery service level options.
- Stripe Checkout: Shipping address collection enabled via `shipping_address_collection` parameter.

### Component Specifications
- Shipping address UI in `video_window_flutter/packages/features/commerce/lib/presentation/widgets/address_selector.dart`. [Source: docs/tech-spec-epic-13.md – Source Tree]
- Address book management in `video_window_flutter/packages/features/profile/lib/presentation/pages/address_book_page.dart`.
- Shipping cost calculation service in `video_window_flutter/packages/core/lib/services/shipping/rate_calculator_service.dart`.
- Server shipping endpoints in `video_window_server/lib/src/endpoints/orders/shipping.dart` handle address validation and rate quotes.
- Integration with Stripe checkout session creation in Story 12.1 for seamless address collection during payment.
