# Story 3.1: Viewer Profile Management

## Status
Ready for Dev

## Story
**As a** viewer,
**I want** to create and manage my profile with avatar, privacy settings, and notification preferences,
**so that** I can personalize my experience and control my data privacy and communications

## Acceptance Criteria
1. Complete profile management interface with avatar/media upload, personal information editing, and real-time validation with optimistic updates and comprehensive error handling.
2. Secure media upload system with file validation, virus scanning, automatic resizing/compression, and secure CDN storage with signed URLs for privacy protection.
3. Granular privacy settings allowing viewers to control profile visibility, data sharing preferences, and consent management with GDPR/CCPA compliance and audit trails.
4. **SECURITY CRITICAL**: Implement comprehensive PII data encryption at rest and in transit with field-level encryption for sensitive profile data and secure key management.
5. **SECURITY CRITICAL**: Implement data subject access request (DSAR) functionality allowing users to export, correct, and delete their personal information with audit logging.
6. **SECURITY CRITICAL**: Implement role-based access controls ensuring users can only modify their own profiles with proper authentication and authorization validation.
7. **PUSH NOTIFICATIONS (MVP)**: Notification preference matrix with granular controls for email, push, and in-app notifications including: new offer notifications, outbid alerts, auction ending reminders, order updates, and maker activity notifications.
8. Integration tests covering profile CRUD operations, privacy controls, media upload workflows, and comprehensive security testing including data access patterns.

## Prerequisites
1. Story 01.1 – Bootstrap Repository and Flutter App
2. Story 1.1 – Implement Email OTP Sign-In (authenticated session guarantees)
3. Story 2.1 – Maker Profile Setup & Role Assignment (shared profile table extensions)
4. Media pipeline baseline from Story 6.1 (for secure uploads) should at least provide signed URL scaffold

## Tasks / Subtasks

### Phase 1 Critical Security Controls (SEC-004 & SEC-005 Mitigation)

- [ ] **SECURITY CRITICAL - SEC-004**: Implement field-level encryption for sensitive PII data in user profiles (AC: 4) [Source: architecture/security-configuration.md#data-encryption-at-rest]
  - [ ] Use AES-256-GCM encryption for sensitive fields (phone, address, date of birth, preferences)
  - [ ] Implement secure key derivation using per-user salts with master key rotation
  - [ ] Ensure encrypted data cannot be accessed without proper authentication and authorization
- [ ] **SECURITY CRITICAL - SEC-004**: Implement secure key management system for profile data encryption (AC: 4) [Source: architecture/security-configuration.md#key-management]
  - [ ] Use AWS KMS or equivalent for master key management with automatic rotation
  - [ ] Implement key hierarchy with data encryption keys (DEKs) encrypted by master keys
  - [ ] Store only encrypted DEKs in database with secure access controls
- [ ] **SECURITY CRITICAL - SEC-005**: Implement comprehensive DSAR (Data Subject Access Request) functionality (AC: 5) [Source: docs/compliance/compliance-guide.md#gdpr-compliance]
  - [ ] Create data export API to compile user profile data in machine-readable format
  - [ ] Implement data correction functionality with audit logging for all changes
  - [ ] Create data deletion workflow with cascading deletes and confirmation requirements
  - [ ] Implement audit trail for all DSAR operations with timestamps and justifications
- [ ] **SECURITY CRITICAL - SEC-005**: Implement role-based access controls for profile management (AC: 6) [Source: architecture/security-configuration.md#authorization-controls]
  - [ ] Enforce user ownership validation for all profile read/write operations
  - [ ] Implement least-privilege access patterns for internal systems accessing profile data
  - [ ] Create audit logging for all profile access attempts (successful and failed)
- [ ] **SECURITY CRITICAL - SEC-004**: Implement secure media upload pipeline with virus scanning (AC: 2) [Source: architecture/security-configuration.md#file-upload-security]
  - [ ] Validate file types, sizes, and dimensions before processing
  - [ ] Implement virus scanning using AWS Macie or equivalent security service
  - [ ] Create secure processing pipeline with automatic image resizing and optimization
  - [ ] Store media in encrypted S3 buckets with bucket policies preventing public access

### Standard Implementation Tasks

- [ ] Implement profile editing UI with form validation, auto-save, and optimistic updates using shared design tokens and BLoC state management (AC: 1) [Source: architecture/front-end-architecture.md#module-overview] [Source: architecture/front-end-architecture.md#state-management]
  - [ ] Add real-time validation for username availability, email format, and profile completeness
  - [ ] Implement auto-save functionality with conflict resolution and offline support
  - [ ] Create responsive layout for mobile and desktop profile editing experiences
- [ ] Implement avatar/media upload functionality with drag-and-drop, cropping, and preview capabilities (AC: 2) [Source: architecture/front-end-architecture.md#media-handling]
  - [ ] Add image cropping and resizing tools with aspect ratio controls
  - [ ] Implement progress indicators for upload processes with retry capabilities
  - [ ] Create preview functionality showing how avatar appears in different contexts
- [ ] Create comprehensive privacy settings interface with granular controls and clear explanations (AC: 3) [Source: docs/compliance/compliance-guide.md#data-protection-and-privacy]
  - [ ] Implement profile visibility controls (public, friends only, private)
  - [ ] Add data sharing preferences for analytics and marketing
  - [ ] Create consent management for cookies, tracking, and third-party integrations
  - [ ] Implement privacy audit log showing data access and changes
- [ ] Implement notification preference matrix with intelligent delivery and suppression (AC: 7) [Source: architecture/story-component-mapping.md#notification-service]
  - [ ] Create granular controls for different notification types (bids, messages, updates)
  - [ ] Implement frequency controls and quiet hours for notifications
  - [ ] Add intelligent suppression to prevent notification spam
  - [ ] Create notification preview and testing functionality
- [ ] Connect profile operations to Profile Service API endpoints with proper error handling and caching (AC: 1) [Source: architecture/openapi-spec.yaml#users-endpoints] [Source: architecture/story-component-mapping.md#profile-service]
  - [ ] Implement optimistic updates with rollback on server errors
  - [ ] Add intelligent caching for profile data with cache invalidation
  - [ ] Create comprehensive error handling with user-friendly messages
- [ ] Emit analytics events for profile interactions, privacy changes, and notification preferences (AC: 1) [Source: architecture/front-end-architecture.md#analytics-instrumentation] [Source: analytics/mvp-analytics-events.md#conventions]
  - [ ] Track profile completion metrics and engagement patterns
  - [ ] Monitor privacy setting changes and consent updates
  - [ ] Analyze notification preference changes and delivery effectiveness

### Security Testing Requirements

- [ ] Cover profile security testing including PII encryption, access controls, and DSAR workflows (AC: 8) [Source: architecture/security-configuration.md#security-testing]
  - [ ] Test encryption/decryption of sensitive profile data with various key scenarios
  - [ ] Test unauthorized access attempts and ensure proper access control enforcement
  - [ ] Test DSAR workflows for data export, correction, and deletion completeness
  - [ ] Test media upload security including file validation and virus scanning
  - [ ] Test privacy control enforcement and data leakage prevention

## Dev Notes
### Previous Story Insights
- Epic 3 builds on authentication foundations from Story 1.1, requiring integration with existing user sessions and security patterns. [Source: architecture/story-component-mapping.md#epic-3--profile--settings-management]
- Follow the implementation sequence defined in docs/tech-spec-epic-3.md#implementation-guide for repository, endpoint, and UI updates.

### Data Models
- Users table includes profile_data JSONB column for flexible profile information storage and encrypted sensitive data fields. [Source: architecture/adr/ADR-0003-database-architecture.md#postgresql-schema-design]
- Profile service manages user settings, notification preferences, and public profile cards with proper access controls. [Source: architecture/story-component-mapping.md#profile-service]

### API Specifications
- `GET /users/me` retrieves current user profile with proper authentication and authorization checks. [Source: architecture/openapi-spec.yaml#users-me-get]
- `PUT /users/me` updates current user profile with validation, sanitization, and security controls. [Source: architecture/openapi-spec.yaml#users-me-put]
- Media uploads use secure signed URLs for direct-to-S3 uploads with virus scanning and processing. [Source: architecture/security-configuration.md#file-upload-security]

## Component Specifications
- Flutter profile feature package (`video_window_flutter/packages/features/profile/`) owns profile editing, privacy settings, and notification preference UX via `presentation/` widgets and BLoC controllers. [Source: architecture/story-component-mapping.md#epic-3--profile--settings-management]
- Business logic for profile actions is implemented as feature `use_cases/` delegating to repositories in `packages/core/`. [Source: architecture/front-end-architecture.md#state-management]
- Integration with Profile and Identity services occurs through `video_window_flutter/packages/core/lib/data/repositories/profile/` and generated Serverpod clients.

## File Locations
- Profile UI belongs under `video_window_flutter/packages/features/profile/lib/presentation/` with accompanying BLoCs and widgets organized by screen. [Source: architecture/architecture.md#source-tree]
- Feature use cases live under `video_window_flutter/packages/features/profile/lib/use_cases/` and operate on domain entities defined in `packages/shared/` where appropriate.
- Secure storage, encryption helpers, and repository implementations stay in `video_window_flutter/packages/core/lib/data/`.
- Serverpod API handlers reside in `video_window_server/lib/src/endpoints/profile/` with business logic in `lib/src/business/profile/`.
- Tests mirror these locations under each package’s `test/` directories (e.g., `video_window_flutter/packages/features/profile/test/presentation/`).

### Testing Requirements
- Maintain ≥80% coverage and include integration coverage for profile CRUD operations, privacy controls, and media upload workflows. [Source: architecture/architecture.md#testing-strategy]
- Profile BLoCs and widgets should use bloc_test package with comprehensive security testing scenarios. [Source: architecture/front-end-architecture.md#testing-strategy-client]

### Technical Constraints
- Profile management requires comprehensive security controls including PII encryption, access controls, and DSAR functionality. [Source: architecture/security-configuration.md] [Source: docs/compliance/compliance-guide.md]
- **SECURITY CRITICAL**: All sensitive PII data must be encrypted at rest using AES-256-GCM with secure key management. [Source: architecture/security-configuration.md#data-encryption-at-rest]
- **SECURITY CRITICAL**: DSAR functionality must be fully implemented with audit trails and data deletion capabilities. [Source: docs/compliance/compliance-guide.md#gdpr-compliance]
- **SECURITY CRITICAL**: Role-based access controls must ensure users can only access their own profile data. [Source: architecture/security-configuration.md#authorization-controls]
- **SECURITY CRITICAL**: Media uploads must include virus scanning, file validation, and secure storage with no public access. [Source: architecture/security-configuration.md#file-upload-security]
- Profile updates must implement optimistic updates with rollback capabilities for offline scenarios. [Source: architecture/front-end-architecture.md#state-management]
- Privacy settings must provide granular controls with clear explanations and immediate effect. [Source: docs/compliance/compliance-guide.md#privacy-by-default]
- Error handling must surface privacy-specific messages and provide clear guidance for data protection issues. [Source: architecture/front-end-architecture.md#error-handling]

### Project Structure Notes
- Profile management aligns with the melos-managed feature package `video_window_flutter/packages/features/profile/`. Keep persistence and encryption logic in `packages/core/` per architecture standards. [Source: architecture/architecture.md#source-tree]
- Integration with existing auth system from Story 1.1 for seamless user experience. [Source: architecture/story-component-mapping.md#epic-1--viewer-authentication--session-handling]

### Scope Notes
- The acceptance criteria cover DSAR, notification preferences, media uploads, and privacy settings. Plan to slice these into focused stories (e.g., Profile CRUD, Privacy Controls, Notification Matrix, DSAR Compliance) to maintain sprint-level predictability.

## Testing
- Follow the project testing pipeline by running `dart format`, `flutter analyze`, and `flutter test --no-pub` before submission. [Source: architecture/architecture.md#testing-strategy]
- Add comprehensive BLoC and widget tests for profile management with security-focused test scenarios including encryption, access controls, and DSAR workflows. [Source: architecture/front-end-architecture.md#testing-strategy-client]
- Include integration tests for media upload pipeline, privacy control enforcement, and notification preference changes. [Source: architecture/architecture.md#testing-strategy]

## Change Log
| Date       | Version | Description        | Author             |
| ---------- | ------- | ------------------ | ------------------ |
| 2025-10-09 | v0.1    | Initial draft created | Development Team   |

## Dev Agent Record
### Agent Model Used
_(To be completed by Dev Agent)_

### Debug Log References
_(To be completed by Dev Agent)_

### Completion Notes List
_(To be completed by Dev Agent)_

### File List
_(To be completed by Dev Agent)_

## QA Results
_(To be completed by QA Agent)_