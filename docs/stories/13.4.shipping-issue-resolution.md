# Story 13.4: Shipping Issue Resolution

## Status
Ready for Dev

## Story
**As a** buyer or maker,
**I want** to resolve shipping issues (lost packages, damage, delays),
**so that** transactions can be completed fairly for both parties

## Acceptance Criteria
1. **BUSINESS CRITICAL**: Buyer can report issues (not received, damaged, wrong item, quality issue) with evidence upload and detailed description within 14 days of delivery date.
2. Maker can respond to issues within 48 hours with counter-evidence, resolution offers (refund, replacement, partial refund), and explanation of circumstances.
3. **BUSINESS CRITICAL**: Platform can mediate disputes with refund/replacement options, payment hold/release authority, and final binding decisions when parties cannot agree.
4. Insurance claims can be filed for high-value items (>$500) lost or damaged in transit with carrier claims integration and documentation support.
5. **BUSINESS CRITICAL**: Resolution timeline is enforced (5 business days max) with automated escalation to support team and SLA breach alerts for unresolved cases.
6. Maker rating is protected for legitimate shipping issues beyond their control (carrier delays, lost packages, damage in transit) with neutral feedback flagging.

## Prerequisites
1. Story 13.3 – Delivery Confirmation Flow (delivery tracking and completion workflow)
2. Story 13.2 – Tracking Integration System (carrier tracking data for evidence)
3. Story 12.1 – Stripe Checkout Integration (refund processing capability)
4. Story 11.1 – Notification System (issue alerts and resolution updates)
5. Epic 14 – Issue Resolution (support ticket system and mediation tools - partial dependency)

## Tasks / Subtasks

### Phase 1 – Issue Reporting System

- [ ] **BUSINESS CRITICAL**: Build issue reporting form (AC: 1) [Source: docs/tech-spec-epic-13.md – Issue Resolution]
  - [ ] Create `ReportIssuePage` with issue type selection (not_received, damaged, wrong_item, quality_issue)
  - [ ] Provide detailed description text field with minimum character requirement
  - [ ] Enable photo evidence upload (max 5 images, 10MB total)
  - [ ] Allow tracking screenshot upload for not_received claims
  - [ ] Validate issue reporting within 14-day window from delivery date
  - [ ] Block duplicate issue reports for same order
- [ ] Implement issue notification workflow (AC: 1) [Source: docs/tech-spec-epic-13.md – Issue Resolution]
  - [ ] Create `ShippingIssueReportedNotification` for maker
  - [ ] Include issue type, description, and evidence links
  - [ ] Send urgent email and SMS to maker (48h response required)
  - [ ] Alert support team for high-severity issues (not_received, major damage)
  - [ ] Create support ticket linked to order and issue report
- [ ] Build issue tracking dashboard (AC: 1, 5) [Source: docs/tech-spec-epic-13.md – Issue Resolution]
  - [ ] Create `IssueTrackingPage` showing all open issues for buyer/maker
  - [ ] Display issue timeline with status transitions and response history
  - [ ] Show countdown timer for resolution SLA (5 business days)
  - [ ] Highlight overdue issues with urgent styling
  - [ ] Provide direct messaging between buyer and maker for clarification

### Phase 2 – Resolution Workflow & Mediation

- [ ] Build maker response interface (AC: 2) [Source: docs/tech-spec-epic-13.md – Issue Resolution]
  - [ ] Create `RespondToIssuePage` for makers with issue details display
  - [ ] Enable maker to upload counter-evidence (photos, receipts, communication)
  - [ ] Provide resolution offer options: full refund, partial refund, replacement, investigate further
  - [ ] Set 48-hour response deadline with urgency indicators
  - [ ] Auto-escalate to support if maker doesn't respond within 48h
- [ ] Implement automated resolution options (AC: 2, 3) [Source: docs/tech-spec-epic-13.md – Issue Resolution]
  - [ ] Full refund: Trigger Stripe refund and release held payment to buyer
  - [ ] Partial refund: Allow maker to propose percentage refund (10-90%)
  - [ ] Replacement: Require maker to provide new tracking number within 7 days
  - [ ] Investigate: Request additional evidence from both parties
  - [ ] Buyer acceptance required for partial refund/replacement offers
- [ ] **BUSINESS CRITICAL**: Build platform mediation tools (AC: 3) [Source: docs/tech-spec-epic-13.md – Issue Resolution]
  - [ ] Create `MediationDashboard` for support team with issue queue
  - [ ] Display all evidence from buyer and maker side-by-side
  - [ ] Provide admin action buttons: approve refund, deny claim, request more info
  - [ ] Enable binding decision authority when parties cannot agree
  - [ ] Generate mediation report documenting decision rationale
  - [ ] Notify both parties of final decision with appeal process information

### Phase 3 – Insurance Integration & Maker Protection

- [ ] Implement shipping insurance claims (AC: 4) [Source: docs/tech-spec-epic-13.md – Issue Resolution]
  - [ ] Identify high-value orders (>$500) eligible for insurance claims
  - [ ] Create `FileInsuranceClaimPage` with carrier-specific forms
  - [ ] Collect required documentation: receipt, photos, tracking proof, item value
  - [ ] Submit insurance claims via carrier APIs (USPS, FedEx, UPS)
  - [ ] Track claim status and update order issue with claim progress
  - [ ] Release insurance payout to maker if claim approved
- [ ] **BUSINESS CRITICAL**: Enforce resolution timeline SLA (AC: 5) [Source: docs/tech-spec-epic-13.md – Issue Resolution]
  - [ ] Create scheduled job checking issue age against 5-day SLA
  - [ ] Send escalation alerts at 3 days (warning) and 5 days (breach)
  - [ ] Auto-escalate breached issues to senior support team
  - [ ] Track SLA compliance metrics for support team performance
  - [ ] Generate SLA breach reports for operations review
- [ ] Implement maker rating protection (AC: 6) [Source: docs/tech-spec-epic-13.md – Issue Resolution]
  - [ ] Flag issues resolved in maker's favor as "not maker fault"
  - [ ] Exclude shipping carrier issues from maker rating calculation
  - [ ] Display neutral badge on maker profile for protected issues
  - [ ] Provide maker with evidence documentation for dispute appeals
  - [ ] Track carrier performance metrics for maker shipping analytics
  - [ ] Allow maker to add response to negative feedback explaining circumstances

## Dev Notes

### Previous Story Insights
- This is the final story in Epic 13, providing critical dispute resolution capabilities that protect both buyers and makers while maintaining marketplace trust. It integrates with payment (Epic 12) and support systems (Epic 14).

### Data Models
- `ShippingIssue` entity: id, order_id, issue_type, description, evidence_urls, reported_at, resolved_at, resolution_type, resolution_notes. [Source: docs/tech-spec-epic-13.md – Data Models]
- Issue types enum: not_received, damaged, wrong_item, quality_issue, delivery_delay, missing_parts. [Source: docs/tech-spec-epic-13.md – Issue Resolution]
- Resolution types enum: full_refund, partial_refund, replacement_sent, buyer_satisfied, maker_protected, insurance_claim_filed. [Source: docs/tech-spec-epic-13.md – Issue Resolution]
- `IssueResponse` entity: issue_id, responder_type (buyer/maker/admin), message, evidence_urls, offer_type, created_at. [Source: docs/tech-spec-epic-13.md – Issue Resolution]

### API Specifications
- `POST /orders/{id}/issues` creates shipping issue with type, description, and evidence uploads. [Source: docs/tech-spec-epic-13.md – Issue Resolution]
- `POST /issues/{id}/respond` adds maker/buyer response with resolution offer or counter-evidence.
- `POST /issues/{id}/resolve` admin-only endpoint for binding mediation decisions.
- `POST /issues/{id}/insurance-claim` initiates carrier insurance claim with required documentation.
- Stripe Refund API: Process full/partial refunds for resolved issues with order and issue references.

### Component Specifications
- Issue reporting UI in `video_window_flutter/packages/features/commerce/lib/presentation/pages/report_issue_page.dart`. [Source: docs/tech-spec-epic-13.md – Source Tree]
- Mediation dashboard in `video_window_flutter/packages/features/admin/lib/presentation/pages/mediation_dashboard.dart` (Epic 15 integration).
- Issue resolution service in `video_window_flutter/packages/core/lib/services/shipping/issue_resolution_service.dart`.
- Server issue endpoints in `video_window_server/lib/src/endpoints/orders/issues.dart` handle reporting, responses, and resolution workflows.
- Scheduled job `enforce_issue_resolution_sla` monitors SLA compliance and escalates overdue issues.
- Integration with Stripe for refund processing (Epic 12) and carrier insurance claim APIs (USPS, FedEx, UPS).
