# Story 12.4: Receipt Generation and Storage

## Status
Ready for Dev

## Story
**As a** buyer and maker,
**I want** a detailed digital receipt after payment success,
**so that** both parties can keep verifiable records of the transaction.

## Acceptance Criteria
1. **RECEIPT RENDERING**: `receipt_generation_service.dart` produces branded PDF receipts using template `RECEIPT_TEMPLATE_VERSION` and stores output in S3 bucket `craft-video-receipts-${ENV}` encrypted with KMS key `payments-receipts`. (Implementation Guide §4)
2. **DELIVERY**: `payment_receipt_endpoint.dart` issues signed CloudFront URLs valid for 24 hours, and `fetch_receipt_use_case.dart` retrieves/caches metadata for the client. (Implementation Guide §4)
3. **AUDIT & ANALYTICS**: Receipt records persisted via `receipt_repository.dart` with sequential IDs from `receipt_number_generator.dart`, logging Segment event `payments.receipt.generated` and Datadog metric `payments.receipt.render_time_ms`. (Implementation Guide §4, Monitoring & Analytics)
4. **RUNBOOK LINK**: Runbook `docs/runbooks/stripe-payments.md` updated with receipt troubleshooting steps, and dashboard widgets tracking receipt successes/failures referenced in `docs/analytics/stripe-payments-dashboard.md`. (Implementation Guide §4)

## Prerequisites
1. Story 12.1 – Stripe Checkout Integration for completed transactions.
2. Story 12.3 – Payment Retry Mechanisms to propagate final success state.
3. S3 bucket + CloudFront distribution provisioned via `infrastructure/terraform/payments.tf`.

## Tasks / Subtasks

### Phase 1 – Receipt Services
- [ ] Implement `receipt_number_generator.dart` for deterministic sequencing (`RCPT-${YYYY}${NNNNN}`). (AC: 3) [Source: docs/tech-spec-epic-12.md – Implementation Guide §4]
- [ ] Build `receipt_generation_service.dart` using `pdfx` templates to render localized receipts and upload to S3 with Object Lock + metadata. (AC: 1)
- [ ] Create `receipt_repository.dart` storing receipt metadata, buyer/maker IDs, and Stripe fee breakdown. (AC: 3)

### Phase 2 – Delivery & Client UX
- [ ] Add `payment_receipt_endpoint.dart` returning signed CloudFront URL + hash for cache validation. (AC: 2)
- [ ] Implement `fetch_receipt_use_case.dart` and UI component `payment_receipt_card.dart` to display summary and download CTA. (AC: 2)
- [ ] Update `payment_status_page.dart` to surface receipt info post-success and provide resend link. (AC: 2)

### Phase 3 – Analytics, Runbook, QA
- [ ] Emit Datadog metric `payments.receipt.render_time_ms` and `payments.receipt.error_count`, plus Segment event `payments.receipt.generated` with `receipt_number`, `amount_usd`, `currency`. (AC: 3)
- [ ] Update `docs/analytics/stripe-payments-dashboard.md` + `docs/runbooks/stripe-payments.md` with receipt monitoring + troubleshooting steps. (AC: 4)
- [ ] Tests: `receipt_generation_service_test.dart`, `receipt_repository_test.dart`, `payment_receipt_endpoint_test.dart`, `fetch_receipt_use_case_test.dart`, synthetic `payments_receipt_smoke_test.dart`. (AC: 1-4) [Source: Test Traceability]

## Dev Notes
- PDF template stored in S3 versioned asset; include maker branding and shipping guidance per Product brief.
- Receipts must include Stripe fees, platform fees, and payout amount; ensure currency formatting via `intl`.
- Maintain GDPR compliance by retaining receipts for 7 years, with deletion queue for lawful requests (handled in future Epic).

## Data Models
- `receipts` table stores `receipt_number`, buyer/maker IDs, amounts, issued timestamp, download URL. [Source: docs/tech-spec-epic-12.md – Data Models]
- `transactions` record updated with `receipt_id` for traceability. [Source: docs/tech-spec-epic-12.md – Implementation Guide §4]

## API Specifications
- `GET /payments/receipts/{receiptId}` returns signed URL + summary metadata. [Source: docs/tech-spec-epic-12.md – Source Tree]
- `POST /payments/receipts/resend` (future Epic) referenced for runbook but not in this slice. [Source: docs/tech-spec-epic-12.md – Implementation Guide §4]

## Component Specifications
- Server: `receipt_generation_service.dart`, `receipt_repository.dart`, `payment_receipt_endpoint.dart`. [Source: docs/tech-spec-epic-12.md – Source Tree]
- Client: `payment_receipt_card.dart`, `fetch_receipt_use_case.dart`. [Source: docs/tech-spec-epic-12.md – Source Tree]
- Telemetry & Runbooks: `payments_metrics.dart`, `docs/runbooks/stripe-payments.md`. [Source: docs/tech-spec-epic-12.md – Implementation Guide §4]

## Testing Requirements
- Validate PDF output in tests via checksum + text extraction for key fields (amount, auction ID, receipt number). [Source: docs/tech-spec-epic-12.md – Implementation Guide §4]
- Ensure signed URLs expire at 24h and reject tampered signatures. [Source: docs/tech-spec-epic-12.md – Implementation Guide §4]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2025-10-29 | v1.0    | Definitive receipt generation scope | GitHub Copilot AI |

## Dev Agent Record
### Agent Model Used
_(To be completed by Dev Agent)_

### Debug Log References
_(To be completed by Dev Agent)_

### Completion Notes List
_(To be completed by Dev Agent)_

### File List
_(To be completed by Dev Agent)_

## QA Results
_(To be completed by QA Agent)_
