# Story 11.1: Push Notification Infrastructure & Device Registration

## Status
Ready for Dev

## Story
**As a** user (viewer or maker),
**I want** to receive push notifications for important marketplace events,
**so that** I stay informed about offers, bids, auctions, and order updates

## Acceptance Criteria
1. **SECURITY CRITICAL**: App requests push notification permission on first launch with clear value proposition, respecting user choice without aggressive re-prompting.
2. Device token registration with Firebase Cloud Messaging (FCM) for both iOS and Android, with automatic token refresh handling and server synchronization.
3. Device token stored securely on Serverpod with user association, platform identification, and token expiry tracking.
4. **RELIABILITY CRITICAL**: Automatic token refresh and re-registration on app launch, token invalidation, or platform updates within 60 seconds.
5. Multiple device support per user with independent token management and delivery tracking across devices.
6. Background notification handling when app is closed or backgrounded with proper deep linking to relevant screens.
7. Foreground notification handling with custom in-app display and immediate activity feed updates.

## Prerequisites
1. Story 1.1 – Implement Email OTP Sign-In (user authentication and session management)
2. Story 3.4 – Notification Preferences Matrix (user preference storage)
3. Firebase project setup with FCM enabled for iOS and Android

## Tasks / Subtasks

### Phase 1 – Firebase Integration & Permission Handling

- [ ] **DEPENDENCY**: Set up Firebase project and configure FCM for iOS/Android [Source: docs/tech-spec-epic-11.md – Technology Stack]
  - [ ] Create Firebase project or use existing project
  - [ ] Add `google-services.json` (Android) and `GoogleService-Info.plist` (iOS)
  - [ ] Configure FCM server key in Serverpod environment
  - [ ] Add firebase_messaging: ^14.7.9 to pubspec.yaml
- [ ] Implement notification permission request flow (AC: 1) [Source: docs/tech-spec-epic-11.md – Implementation Guide]
  - [ ] Create `NotificationPermissionService` in core package
  - [ ] Show permission rationale dialog on first app launch
  - [ ] Request iOS/Android notification permissions with FirebaseMessaging
  - [ ] Store permission status in local storage
  - [ ] Handle permission denied gracefully without re-prompting
- [ ] Build FCM token management service (AC: 2, 4) [Source: docs/tech-spec-epic-11.md – Device Registration]
  - [ ] Create `FcmTokenService` to handle token lifecycle
  - [ ] Get initial FCM token on app launch
  - [ ] Listen to token refresh events with FirebaseMessaging.onTokenRefresh
  - [ ] Store token locally with timestamp for staleness detection
  - [ ] Implement token refresh logic on app resume

### Phase 2 – Server Token Registration & Management

- [ ] Create device token registration endpoint (AC: 3) [Source: docs/tech-spec-epic-11.md – Data Models]
  - [ ] Implement `POST /notifications/register-device` Serverpod endpoint
  - [ ] Create `device_tokens` table with userId, token, platform, createdAt, lastSeenAt
  - [ ] Validate token format and platform (iOS/Android)
  - [ ] Store device token with user association and platform metadata
  - [ ] Return registration confirmation with device ID
- [ ] Implement token synchronization logic (AC: 4, 5) [Source: docs/tech-spec-epic-11.md – Implementation Guide]
  - [ ] Call registration endpoint on successful FCM token retrieval
  - [ ] Re-register token on app launch if last sync > 24 hours
  - [ ] Handle token refresh events and immediately sync to server
  - [ ] Support multiple devices per user with unique device IDs
  - [ ] Implement token invalidation endpoint for logout/uninstall
- [ ] Build token cleanup and expiry management [Source: docs/tech-spec-epic-11.md – Device Registration]
  - [ ] Mark tokens as inactive after 30 days of no app usage
  - [ ] Remove invalid tokens after failed delivery attempts
  - [ ] Update lastSeenAt timestamp on each app launch
  - [ ] Provide admin endpoint to view user's registered devices

### Phase 3 – Notification Message Handling

- [ ] Implement background notification handler (AC: 6) [Source: docs/tech-spec-epic-11.md – Implementation Guide]
  - [ ] Create `firebaseMessagingBackgroundHandler` function
  - [ ] Register background handler in main.dart before runApp()
  - [ ] Parse notification payload and extract deep link data
  - [ ] Store notification in local database for activity feed
  - [ ] Handle notification tap to navigate to relevant screen
- [ ] Implement foreground notification handler (AC: 7) [Source: docs/tech-spec-epic-11.md – Implementation Guide]
  - [ ] Listen to FirebaseMessaging.onMessage stream
  - [ ] Show custom in-app notification UI with flutter_local_notifications
  - [ ] Configure notification channels for Android (high importance)
  - [ ] Configure notification presentation for iOS (alert, badge, sound)
  - [ ] Update activity feed in real-time when foreground notification received
- [ ] Build deep linking navigation system (AC: 6) [Source: docs/tech-spec-epic-11.md – Implementation Guide]
  - [ ] Define deep link URI scheme for notification types
  - [ ] Implement `NotificationRouter` to map notification types to routes
  - [ ] Handle notification tap events with FirebaseMessaging.onMessageOpenedApp
  - [ ] Navigate to story detail, auction, order, or profile based on notification type
  - [ ] Mark notification as read when user navigates from notification

### Phase 4 – Testing & Reliability

- [ ] **RELIABILITY CRITICAL**: Implement comprehensive notification delivery testing (AC: 4) [Source: docs/tech-spec-epic-11.md – Testing Requirements]
  - [ ] Unit tests for token management and refresh logic
  - [ ] Integration tests for device registration and token sync
  - [ ] Test token refresh on app launch, resume, and token expiry
  - [ ] Test multiple device registration for same user
  - [ ] Test notification delivery in foreground, background, and terminated states
- [ ] Test notification permissions and user flows (AC: 1) [Source: docs/tech-spec-epic-11.md – Testing Requirements]
  - [ ] Test permission request dialog on first launch
  - [ ] Test permission denied handling without re-prompting
  - [ ] Test settings deep link to enable notifications later
  - [ ] Verify graceful degradation when notifications disabled
- [ ] Test background and foreground message handling (AC: 6, 7) [Source: docs/tech-spec-epic-11.md – Testing Requirements]
  - [ ] Test background notification handling when app closed
  - [ ] Test foreground notification display and in-app updates
  - [ ] Test notification tap navigation to correct screens
  - [ ] Test deep linking with various notification payloads
  - [ ] Verify notification persistence in activity feed

## Dev Notes
- FCM requires platform-specific setup - follow Firebase documentation carefully for iOS APNs certificates and Android setup
- Background handler must be top-level function, not class method
- iOS requires notification permission before receiving push notifications
- Android 13+ requires runtime notification permission (TIRAMISU)
- Test on physical devices - push notifications unreliable on simulators
- Consider notification grouping for iOS and Android notification channels
- Implement retry logic for server token registration failures
- Monitor FCM delivery reports for failed deliveries and token cleanup

## Change Log
| Date | Author | Changes |
|------|--------|---------|
| 2025-10-30 | Mary (Analyst) | Initial story creation from tech spec |
