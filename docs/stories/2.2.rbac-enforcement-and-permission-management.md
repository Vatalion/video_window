# Story 2.2: RBAC Enforcement & Permission Management

## Status
Ready for Dev

## Story
**As a** platform security administrator,
**I want** granular roles and permissions enforced across the maker experience,
**so that** makers and admins only access capabilities aligned with their responsibilities.

## Acceptance Criteria
1. Define role hierarchy (`basic_maker`, `maker_admin`, `operations_support`) with inheritance and persisted metadata; expose CRUD APIs with validation and audit logging. [Source: docs/tech-spec-epic-2.md#role--permission-entities]
2. Runtime permission checks must leverage Redis caches with automatic invalidation and fall back to Postgres when stale; cache TTL 1 hour from config. [Source: docs/tech-spec-epic-2.md#implementation-guide]
3. JWT access tokens include role IDs and resolved permission claims; middleware rejects requests when permissions missing. [Source: docs/tech-spec-epic-2.md#serverpod-maker-access-service]
4. Admin UI provides role assignment table with search, assign/remove actions, and displays effective permissions via badges. [Source: docs/tech-spec-epic-2.md#source-tree--file-directives]
5. **SECURITY CRITICAL**: All role assignment changes recorded in `role_assignment_audit` table and streamed to `audit.rbac` topic with actor, reason, and diff payload. [Source: docs/tech-spec-epic-2.md#database-migrations]

## Prerequisites
1. Story 2.1 – Maker Onboarding & Invitation Flow (ensures makers exist for role testing)
2. Story 1.3 – Session Management & Refresh (token issuance path)

## Tasks / Subtasks

### Permissions Data Layer
- [ ] Implement `permission_repository.dart` with CRUD for roles/permissions and caching hooks. [Source: docs/tech-spec-epic-2.md#source-tree--file-directives]
- [ ] Create migrations for role hierarchy indexes and audit table seed data. [Source: docs/tech-spec-epic-2.md#database-migrations]
- [ ] Seed baseline roles (`basic_maker`, `maker_admin`, `operations_support`) with initial permission sets defined in spec appendix.

### RBAC Service & Middleware
- [ ] Build `rbac_service.dart` handling inheritance resolution, cache priming, and invalidation on updates (AC: 1-3). [Source: docs/tech-spec-epic-2.md#implementation-guide]
- [ ] Integrate Serverpod middleware to check permissions on invitation, KYC, and device endpoints. [Source: docs/tech-spec-epic-2.md#serverpod-maker-access-service]
- [ ] Extend JWT issuance pipeline to include `roles` and `permissions` claims signed by Serverpod.

### Admin Role Management UI
- [ ] Create `update_role_assignments_use_case.dart` coordinating role adds/removals and audit logging (AC: 4,5). [Source: docs/tech-spec-epic-2.md#source-tree--file-directives]
- [ ] Implement `role_badge.dart` widget for effective permission display. [Source: docs/tech-spec-epic-2.md#source-tree--file-directives]
- [ ] Add admin screen listing users, assigned roles, and ability to search/modify assignments.

### Audit & Observability
- [ ] Record every role change to `role_assignment_audit` and emit streaming event with diff summary (AC: 5). [Source: docs/tech-spec-epic-2.md#monitoring-and-analytics]
- [ ] Configure alert when >5 role changes occur within 10 minutes by same actor (possible privilege escalation).

## Data Models
- Roles, permissions, and user_roles tables defined in migrations provide base schema; audit table captures actions with JSON diff. [Source: docs/tech-spec-epic-2.md#database-migrations]

## API Specifications
- `GET /roles`, `POST /roles`, `PUT /roles/{id}`, `DELETE /roles/{id}` manage role definitions. [Source: docs/tech-spec-epic-2.md#role--permission-endpoints]
- `POST /users/{userId}/roles` and `DELETE /users/{userId}/roles/{roleId}` assign/remove roles with audit log. [Source: docs/tech-spec-epic-2.md#role--permission-endpoints]

## Component Specifications
- Admin UI resides in `video_window_flutter/packages/features/admin/lib/presentation/roles/`. [Source: docs/tech-spec-epic-2.md#source-tree--file-directives]
- Serverpod middleware activated via `Serverpod` `onRequest` hook to enforce permissions. [Source: docs/tech-spec-epic-2.md#serverpod-maker-access-service]

## File Locations
- `rbac_service.dart` and `permission_repository.dart` under `video_window_server/lib/src/services/` and `.../repositories/`. [Source: docs/tech-spec-epic-2.md#source-tree--file-directives]
- Flutter BLoC/use cases located under `video_window_flutter/packages/features/admin/lib/use_cases/` with matching tests. [Source: docs/tech-spec-epic-2.md#source-tree--file-directives]

## Testing Requirements
- Unit tests: role resolution, cache invalidation, middleware enforcement, BLoC UI state. [Source: docs/tech-spec-epic-2.md#testing-strategy]
- Integration tests: assign/remove roles, JWT claim propagation, permission denial scenarios.
- Security tests: attempt privilege escalation via direct API calls and ensure denials + alerts.

## Technical Constraints
- Cache invalidation must complete within 5 seconds of role change to prevent stale permissions. [Source: docs/tech-spec-epic-2.md#implementation-guide]
- Only `maker_admin` may modify roles; enforce via middleware and UI gating.

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2025-10-29 | v1.0    | Initial RBAC story authored | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
_(To be completed by Dev Agent)_

### Debug Log References
_(To be completed by Dev Agent)_

### Completion Notes List
_(To be completed by Dev Agent)_

### File List
_(To be completed by Dev Agent)_

## QA Results
_(To be completed by QA Agent)_
