# Story 2.1: Maker Onboarding & Invitation Flow

## Status
Ready for Dev

## Story
**As a** marketplace administrator,
**I want** to issue secure invitations that guide qualified makers through onboarding,
**so that** only verified makers can claim accounts and gain maker capabilities safely.

## Acceptance Criteria
1. Administrators can create invitations assigning predefined role sets, configure expiry (default 7 days), and resend or revoke codes. Audit logs capture issuer, target email, and metadata. [Source: docs/tech-spec-epic-2.md#api-endpoints]
2. Invitation claim flow verifies the HMAC signature, enforces rate limits (5 attempts/hour per user), captures device metadata, and converts the invitee into an authenticated maker session with initial profile scaffold. [Source: docs/tech-spec-epic-2.md#implementation-guide]
3. Claimed invitations automatically enqueue onboarding steps (profile setup, KYC, device registration) and persist onboarding state in Redis + Postgres for resume support. [Source: docs/tech-spec-epic-2.md#implementation-details]
4. **SECURITY CRITICAL**: All invitation codes use cryptographically secure randomness with HMAC-SHA256 signing, are single-use, and emit alerts on brute-force attempts. [Source: docs/tech-spec-epic-2.md#security-monitoring]
5. **AUDITABILITY**: Invitation lifecycle events (created, claimed, revoked, expired) stream to `audit.invitation` topic with correlation IDs for compliance review. [Source: docs/tech-spec-epic-2.md#monitoring-and-analytics]

## Prerequisites
1. Story 1.1 – Implement Email OTP Sign-In (shared authentication/session stack)
2. Story 1.3 – Session Management & Refresh (token rotation leveraged by maker sessions)
3. Admin dashboard shell available from Epic 0 (navigation + permissions scaffolding)

## Tasks / Subtasks

### Admin Invitation Issuance

- [ ] Build invitation creation panel within admin dashboard (AC: 1) [Source: docs/tech-spec-epic-2.md#source-tree--file-directives]
  - [ ] Provide role bundle presets (`basic_maker`, `maker_admin`) and expiration picker with defaults from configuration. [Source: docs/tech-spec-epic-2.md#technology-stack]
  - [ ] Surface success/failure states with audit ID and resend link.
- [ ] Implement `create_invitation_use_case.dart` to call Serverpod endpoint, handle errors, and emit analytics event `admin_invitation_created`. [Source: docs/tech-spec-epic-2.md#implementation-guide]
- [ ] Add invitation listing with revoke/resend actions invoking `maker_invitation_repository.dart` (AC: 1,5).

### Invitation Service & API

- [ ] Create Serverpod `invitation_endpoint.dart` with `create`, `claim`, `status`, `revoke`, and `resend` routes (AC: 1,2). [Source: docs/tech-spec-epic-2.md#api-endpoints]
  - [ ] Validate issuer permissions via RBAC middleware and log audit events on each action.
  - [ ] Enforce Redis-backed rate limits per recipient email and IP. [Source: docs/tech-spec-epic-2.md#implementation-guide]
- [ ] Implement `invitation_service.dart` for HMAC code generation + verification, linking to PostgreSQL + Redis caches (AC: 2,4).
- [ ] Emit Kafka/Serverpod streaming events for lifecycle transitions to `audit.invitation`. [Source: docs/tech-spec-epic-2.md#monitoring-and-analytics]

### Invitation Claim UX & Onboarding State

- [ ] Create `maker_invitation_claim_page.dart` with multi-step wizard (code validation → account creation → onboarding checklist). [Source: docs/tech-spec-epic-2.md#implementation-details]
- [ ] Implement `maker_invitation_bloc.dart` to orchestrate claim, session bootstrap, and onboarding queue persistence in Redis. [Source: docs/tech-spec-epic-2.md#implementation-guide]
- [ ] Store device metadata (platform, attestation fingerprint) alongside claim event to seed Story 2.4. [Source: docs/tech-spec-epic-2.md#data-models]
- [ ] Generate onboarding checklist entries `profile_setup`, `kyc_submission`, `device_trust` and save to `maker_onboarding_status` table. [Source: docs/tech-spec-epic-2.md#implementation-details]

### Testing & Observability

- [ ] Author unit tests for BLoC, use case, and invitation service covering success/failure paths. [Source: docs/tech-spec-epic-2.md#testing-strategy]
- [ ] Write integration tests covering admin issuance → claim → onboarding state persistence.
- [ ] Configure dashboards/alerts for invitation failure spike (>10 failures/5min) to flag potential abuse. [Source: docs/tech-spec-epic-2.md#security-monitoring]

## Data Models
- `invitations` table tracks secure codes, assigned roles, issuer metadata, and lifecycle timestamps. [Source: docs/tech-spec-epic-2.md#database-migrations]
- `maker_onboarding_status` Redis+Postgres hybrid (new repository) stores onboarding checklist state keyed by maker ID. [Source: docs/tech-spec-epic-2.md#implementation-guide]

## API Specifications
- `POST /invitations/create` (admin) issues new invite and returns signed code + tracking ID. [Source: docs/tech-spec-epic-2.md#invitation-management-endpoints]
- `POST /invitations/{code}/claim` validates signature, rate limits attempts, and returns session + onboarding steps. [Source: docs/tech-spec-epic-2.md#invitation-management-endpoints]
- `POST /invitations/{id}/revoke` immediately revokes outstanding code and emits audit event. [Source: docs/tech-spec-epic-2.md#invitation-management-endpoints]

## Component Specifications
- Admin UI components live under `video_window_flutter/packages/features/admin/lib/presentation/invitations/` using BLoC for complex flows. [Source: docs/tech-spec-epic-2.md#source-tree--file-directives]
- Maker-facing claim flow resides in `video_window_flutter/packages/features/auth/lib/presentation/pages/` with modular step widgets and analytics instrumentation. [Source: docs/tech-spec-epic-2.md#implementation-guide]
- Serverpod middleware ensures invitation claim endpoints require valid signature before further processing. [Source: docs/tech-spec-epic-2.md#serverpod-maker-access-service]

## File Locations
- Client invitation use cases + BLoC stored in `video_window_flutter/packages/features/auth/lib/use_cases/` and `.../bloc/`. [Source: docs/tech-spec-epic-2.md#source-tree--file-directives]
- Admin invitation panel implemented under `video_window_flutter/packages/features/admin/lib/presentation/invitations/`. [Source: docs/tech-spec-epic-2.md#source-tree--file-directives]
- Server invitation logic located at `video_window_server/lib/src/endpoints/identity/invitation_endpoint.dart` with service + repository classes under `lib/src/services/`. [Source: docs/tech-spec-epic-2.md#source-tree--file-directives]
- Tests mirror lib structure within respective `test/` directories to maintain coverage targets. [Source: docs/tech-spec-epic-2.md#source-tree--file-directives]

## Testing Requirements
- Maintain ≥80% coverage for new BLoCs/use cases; integration tests exercise issuance + claim flows. [Source: docs/tech-spec-epic-2.md#testing-strategy]
- Load test invitation creation/claim to 100 req/min sustained with no >200ms latency increase. [Source: docs/tech-spec-epic-2.md#performance-tests]
- Security tests must attempt brute force, replay, and signature tampering scenarios. [Source: docs/tech-spec-epic-2.md#security-tests]

## Technical Constraints
- Invitation codes must be single-use and invalidated immediately after successful claim. [Source: docs/tech-spec-epic-2.md#implementation-guide]
- Invitations can only be created by users with `invitations.create` permission enforced via RBAC service. [Source: docs/tech-spec-epic-2.md#serverpod-maker-access-service]
- Device metadata captured during claim must be persisted for device trust calculations in Story 2.4. [Source: docs/tech-spec-epic-2.md#implementation-guide]
- All invitation lifecycle events must be captured for audit compliance. [Source: docs/tech-spec-epic-2.md#monitoring-and-analytics]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2025-10-29 | v1.0    | Rewritten to match definitive invitation flow | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
_(To be completed by Dev Agent)_

### Debug Log References
_(To be completed by Dev Agent)_

### Completion Notes List
_(To be completed by Dev Agent)_

### File List
_(To be completed by Dev Agent)_

## QA Results
_(To be completed by QA Agent)_