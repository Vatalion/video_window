# Story 2.1: Maker Onboarding & Invitation Flow

## Status
Ready for Dev

## Story
**As a** platform administrator,
**I want** to invite and onboard qualified makers through a secure invitation workflow,
**so that** only verified creators can access maker tools and publish content with appropriate role-based access controls

## Acceptance Criteria
1. Secure invitation system with role-based access control (RBAC) supporting admin-initiated invitations, approval workflows, and granular permission assignments for maker roles.
2. Comprehensive maker verification and onboarding flow with identity verification, profile setup, business verification, and secure credential management integrated with existing auth system.
3. Advanced security controls including invitation expiration, single-use invitation codes, audit logging, and automated fraud detection for maker account creation.
4. **SECURITY CRITICAL**: Implement cryptographic invitation codes with HMAC-SHA256 signing, expiration controls, and secure token management to prevent invitation code reuse and enumeration attacks.
5. **SECURITY CRITICAL**: Implement multi-tier maker verification with KYC-style identity verification, business document verification, and secure data handling with end-to-end encryption.
6. **SECURITY CRITICAL**: Implement comprehensive RBAC with least-privilege principle, role inheritance, and granular permission controls for all maker-specific features and data access.
7. **SECURITY CRITICAL**: Implement secure maker profile management with data encryption, secure document storage, and privacy controls compliant with data protection regulations.
8. **SECURITY CRITICAL**: Implement audit logging and monitoring for all maker-related activities including invitation usage, verification attempts, permission changes, and administrative actions.

## Tasks / Subtasks

### Phase 1 Critical Security Controls (SEC-002 & SEC-004 Mitigation)

- [ ] **SECURITY CRITICAL - SEC-002**: Implement cryptographic invitation system with HMAC-SHA256 signed codes (AC: 4) [Source: docs/security/story-2.1-maker-onboarding-security.md#invitation-security-implementation]
  - [ ] Generate cryptographically secure invitation codes with 32-byte random values and HMAC-SHA256 signing
  - [ ] Implement invitation expiration with configurable time-to-live (default 7 days, maximum 30 days)
  - [ ] Add one-time use enforcement and immediate invitation invalidation after successful use
  - [ ] Implement invitation rate limiting to prevent enumeration attacks
- [ ] **SECURITY CRITICAL - SEC-002**: Implement secure invitation workflow with approval mechanisms (AC: 1, 8) [Source: docs/security/story-2.1-maker-onboarding-security.md#secure-workflow-controls]
  - [ ] Multi-stage approval process: nomination → review → approval → invitation
  - [ ] Role-based invitation permissions with admin and approver roles
  - [ ] Secure invitation delivery via email/SMS with tracking and expiration
  - [ ] Comprehensive audit logging for all invitation lifecycle events
- [ ] **SECURITY CRITICAL - SEC-004**: Implement comprehensive RBAC system with granular permissions (AC: 1, 6) [Source: docs/security/story-2.1-maker-onboarding-security.md#role-based-access-control]
  - [ ] Define maker role hierarchy: Basic Maker, Verified Maker, Premium Maker, Admin
  - [ ] Implement granular permissions: content_publish, analytics_view, customer_manage, etc.
  - [ ] Role assignment and revocation with immediate effect propagation
  - [ ] Permission inheritance and conflict resolution mechanisms
- [ ] **SECURITY CRITICAL - SEC-004**: Implement secure authentication context for makers (AC: 2, 7) [Source: docs/security/story-2.1-maker-onboarding-security.md#maker-authentication]
  - [ ] Integrate with existing email/SMS authentication system from Story 1.1
  - [ ] Add maker-specific authentication factors and device registration
  - [ ] Secure session management with role-based token claims
  - [ ] Implement device binding and trust management for maker accounts
- [ ] **SECURITY CRITICAL - SEC-004**: Implement maker verification and KYC processes (AC: 2, 5) [Source: docs/security/story-2.1-maker-onboarding-security.md#maker-verification]
  - [ ] Identity verification with government-issued document validation
  - [ ] Business verification with EIN/tax number validation
  - [ ] Secure document upload with end-to-end encryption
  - [ ] Automated fraud detection and manual review workflows

### Standard Implementation Tasks

- [ ] Implement invitation management UI for administrators with search, filtering, and bulk operations using shared design tokens (AC: 1) [Source: architecture/front-end-architecture.md#module-overview] [Source: architecture/front-end-architecture.md#state-management]
  - [ ] Add invitation creation wizard with recipient selection, role assignment, and expiration settings (AC: 1) [Source: architecture/front-end-architecture.md#form-handling]
  - [ ] Implement invitation tracking dashboard with status monitoring and resend capabilities (AC: 1, 8) [Source: architecture/front-end-architecture.md#dashboard-patterns]
- [ ] Implement maker onboarding flow with profile setup, verification steps, and account activation using BLoC state management (AC: 2) [Source: architecture/front-end-architecture.md#multi-step-forms]
  - [ ] Create maker profile setup wizard with business information, preferences, and compliance declarations (AC: 2) [Source: architecture/front-end-architecture.md#form-validation]
  - [ ] Implement document upload interface with secure file handling and progress tracking (AC: 2, 5) [Source: architecture/front-end-architecture.md#file-upload-patterns]
- [ ] Connect invitation flow to the Identity service `POST /invitations/create`, `POST /invitations/{code}/claim`, and `GET /invitations/status` endpoints (AC: 1, 2, 4) [Source: architecture/architecture.md#identity-service] [Source: architecture/architecture.md#rest-api-spec-excerpt]
  - [ ] Handle invitation creation, claiming, and status updates with proper error handling and user feedback (AC: 1, 2) [Source: architecture/front-end-architecture.md#error-handling]
  - [ ] Emit analytics events for invitation lifecycle events via the analytics service, aligning with analytics naming conventions (AC: 1, 8) [Source: architecture/front-end-architecture.md#analytics-instrumentation] [Source: analytics/mvp-analytics-events.md#conventions]
- [ ] Implement role management interface for administrators with role creation, permission assignment, and user role management (AC: 1, 6) [Source: architecture/front-end-architecture.md#admin-interfaces]
  - [ ] Create role definition wizard with permission selection and role hierarchy configuration (AC: 6) [Source: architecture/front-end-architecture.md#permission-management]
  - [ ] Implement user role assignment interface with bulk operations and audit trail (AC: 1, 6, 8) [Source: architecture/front-end-architecture.md#user-management]

### Security Testing Requirements

- [ ] Cover invitation security and RBAC implementation with comprehensive security testing including privilege escalation, invitation code manipulation, and unauthorized access scenarios (AC: 3, 4, 6) [Source: security/story-2.1-maker-onboarding-security.md#security-testing-requirements]
  - [ ] Test invitation code security (brute force attempts, code reuse, expired invitations)
  - [ ] Test RBAC implementation (privilege escalation attempts, unauthorized access, role inheritance)
  - [ ] Test maker verification security (document manipulation, identity fraud, data breaches)
  - [ ] Test audit logging integrity (log tampering, monitoring gaps, alert reliability)

## Dev Notes
### Previous Story Insights
- Story 1.1 established secure email/SMS authentication patterns that should be extended for maker authentication with role-based token claims and enhanced security controls. [Source: architecture/story-component-mapping.md#epic-2--maker-authentication--access-control]
- JWT token patterns from Story 1.1 should be extended to include maker role claims and permission sets for RBAC enforcement. [Source: security/story-1.1-authentication-security-research.md#secure-jwt-implementation]

### Data Models
- `invitations` table stores invitation codes, recipient information, role assignments, expiration dates, and usage tracking with HMAC-signed invitation codes. [Source: architecture/architecture.md#database-schema-excerpt]
- `maker_profiles` table extends user accounts with business information, verification status, role assignments, and profile metadata. [Source: architecture/architecture.md#database-schema-excerpt]
- `roles` and `permissions` tables support RBAC implementation with role hierarchy, permission definitions, and user role assignments. [Source: architecture/architecture.md#database-schema-excerpt]
- `verification_documents` table stores encrypted verification documents with metadata and processing status. [Source: architecture/architecture.md#database-schema-excerpt]

### API Specifications
- `POST /invitations/create` accepts recipient email, role assignment, expiration settings, and custom message; returns invitation code and tracking ID. [Source: architecture/architecture.md#rest-api-spec-excerpt]
- `POST /invitations/{code}/claim` validates invitation code, creates maker account, and initiates onboarding flow; returns maker profile data. [Source: architecture/architecture.md#rest-api-spec-excerpt]
- `GET /invitations/status/{code}` returns invitation status, expiration, and usage information for tracking and validation. [Source: architecture/architecture.md#rest-api-spec-excerpt]
- `POST /maker/verification/upload` securely uploads verification documents with encryption and metadata; returns processing status. [Source: architecture/architecture.md#rest-api-spec-excerpt]
- `GET/PUT /maker/profile` manages maker profile information with role-based access controls and validation. [Source: architecture/architecture.md#rest-api-spec-excerpt]

### Component Specifications
- Flutter `maker_auth` module owns invitation management, onboarding flows, and maker profile management; extends existing `auth` module patterns with maker-specific features. [Source: architecture/story-component-mapping.md#epic-2--maker-authentication--access-control]
- Admin dashboard components manage invitation creation, role assignment, and verification workflows with BLoC-based state management. [Source: architecture/front-end-architecture.md#admin-dashboard-patterns]
- Secure file upload components handle verification documents with encryption, progress tracking, and validation. [Source: architecture/front-end-architecture.md#secure-file-handling]
- Role-based UI components render interfaces based on user permissions with dynamic content filtering and access control. [Source: architecture/front-end-architecture.md#role-based-ui]

### File Locations
- UI and state code for this story belong under `video_window/lib/features/maker_auth/` following presentation, application, domain, and infrastructure layering. [Source: architecture/architecture.md#source-tree]
- Admin dashboard components should be organized under `video_window/lib/features/admin/` with maker-specific sub-modules. [Source: architecture/architecture.md#source-tree]
- Tests should mirror feature paths under `video_window/test/features/maker_auth/` to match the project structure. [Source: architecture/architecture.md#testing-strategy]

### Testing Requirements
- Maintain ≥80% coverage and include integration coverage for maker auth flows, running `flutter test --no-pub` in CI. [Source: architecture/architecture.md#testing-strategy]
- Maker auth BLoCs and widgets should use bloc_test package and widget tests for critical screens. [Source: architecture/front-end-architecture.md#testing-strategy-client]
- Security testing should include penetration testing for invitation code manipulation, privilege escalation attempts, and data breach scenarios. [Source: security/story-2.1-maker-onboarding-security.md#security-testing-requirements]

### Technical Constraints
- Maker authentication extends existing OTP system with role-based access control and enhanced verification requirements. [Source: architecture/architecture.md#security] [Source: security/story-2.1-maker-onboarding-security.md]
- **SECURITY CRITICAL**: All invitation codes must use HMAC-SHA256 signing with cryptographic randomness and never store plaintext invitation codes. [Source: security/story-2.1-maker-onboarding-security.md#cryptographic-invitation-codes]
- **SECURITY CRITICAL**: RBAC implementation must enforce least-privilege principle with granular permission controls and immediate effect propagation. [Source: security/story-2.1-maker-onboarding-security.md#rbac-security-requirements]
- **SECURITY CRITICAL**: Verification documents must be encrypted at rest and in transit with secure key management and access controls. [Source: security/story-2.1-maker-onboarding-security.md#secure-document-storage]
- **SECURITY CRITICAL**: All maker-related activities must be logged with comprehensive audit trails and real-time monitoring for security incident detection. [Source: security/story-2.1-maker-onboarding-security.md#audit-logging-requirements]
- Maker verification integrates with third-party KYC services with secure API communication and data handling. [Source: architecture/architecture.md#third-party-integrations]
- Error handling must balance security (not revealing invitation codes) with usability (clear guidance for legitimate users). [Source: architecture/front-end-architecture.md#error-handling]
- All security controls must implement comprehensive logging and monitoring for compliance and security incident detection. [Source: security/story-2.1-maker-onboarding-security.md#monitoring-and-compliance]

### Project Structure Notes
- Planned changes extend the documented monorepo structure with new maker_auth features; no structural deviations identified. [Source: architecture/architecture.md#source-tree]

## Testing
- Follow the project testing pipeline by running `dart format`, `flutter analyze`, and `flutter test --no-pub` before submission. [Source: architecture/architecture.md#testing-strategy]
- Add BLoC and widget tests for maker auth flows with fixtures covering invitation creation, claiming, verification, and role assignment scenarios. [Source: architecture/front-end-architecture.md#testing-strategy-client]
- Include security-focused tests for invitation code security, RBAC enforcement, and verification document handling. [Source: security/story-2.1-maker-onboarding-security.md#security-testing-requirements]

## Change Log
| Date       | Version | Description        | Author             |
| ---------- | ------- | ------------------ | ------------------ |
| 2025-01-09 | v0.1    | Initial draft created | Claude (Dev Agent) |

## Dev Agent Record
### Agent Model Used
Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
_(To be completed by Dev Agent)_

### Completion Notes List
_(To be completed by Dev Agent)_

### File List
_(To be completed by Dev Agent)_

## QA Results
_(To be completed by QA Agent)_