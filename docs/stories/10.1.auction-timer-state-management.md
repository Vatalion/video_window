# Story 10.1: Auction Timer & State Management

## Status
Ready for Dev

## Story
**As a** marketplace participant (viewer, maker, or admin),
**I want** reliable 72-hour auction timer lifecycle with 15-minute soft-close extensions and comprehensive state management,
**so that** auction events execute with precise timing, accurate state transitions, and complete audit logging for trustworthy marketplace operations

## Acceptance Criteria
1. **TIMER CRITICAL**: 72-hour auction timer with sub-second precision, server-synchronized countdown, and Redis-based state persistence with automatic recovery mechanisms.
2. **BUSINESS CRITICAL**: 15-minute soft-close extension logic triggered by bids in final 15 minutes, with 24-hour maximum extension cap and real-time WebSocket notifications.
3. **BUSINESS CRITICAL**: Complete auction state machine implementation (pending → active → accepted/ended → completed) with comprehensive audit logging and state transition validation.
4. **BUSINESS CRITICAL**: Real-time timer synchronization between server and clients with drift correction, connection recovery, and fallback polling mechanisms.
5. **BUSINESS CRITICAL**: Integration with Epic 9 offer system for auction initiation, bid placement validation, and high bid management with optimistic UI updates.
6. **INTEGRATION CRITICAL**: State persistence and recovery mechanisms for service restarts, network failures, and timer drift with automatic Redis state restoration.
7. **ANALYTICS CRITICAL**: Comprehensive event tracking for all timer events, state transitions, bid activities, and auction lifecycle metrics for business intelligence.
8. **RELIABILITY CRITICAL**: Timer accuracy within ±5 seconds under normal load, supporting 100+ concurrent auctions with 99.9% uptime SLA.

## Tasks / Subtasks

### Phase 1 Core Timer Infrastructure (TIMER-001 & TIMER-002)

- [ ] **TIMER CRITICAL - TIMER-001**: Implement Redis-based auction timer service with 72-hour countdown and sub-second precision (AC: 1, 4, 8) [Source: tech-spec-epic-10.md#timer-management-service]
  - [ ] Use Redis sorted sets for timer storage with millisecond precision and automatic expiration
  - [ ] Implement server time synchronization with NTP and drift correction algorithms
  - [ ] Store timer state with version control for conflict resolution and recovery
  - [ ] Implement background task scheduling for timer expiration with Serverpod's job system
- [ ] **TIMER CRITICAL - TIMER-001**: Implement soft-close extension logic with 15-minute increments and 24-hour cap (AC: 2, 8) [Source: brief.md#soft-close-auction-mechanics] [Source: tech-spec-epic-10.md#soft-close-extension-logic]
  - [ ] Detect bids within final 15 minutes of auction end time
  - [ ] Extend auction end time by 15 minutes per bid, max 24 hours total extension
  - [ ] Update Redis timer state and broadcast WebSocket events immediately
  - [ ] Log all extension events with bid context and timing metrics
- [ ] **TIMER CRITICAL - TIMER-002**: Implement comprehensive auction state machine with validation (AC: 3, 8) [Source: tech-spec-epic-10.md#auction-state-machine]
  - [ ] Define valid state transitions: pending → active → accepted/ended → completed
  - [ ] Implement state transition validation with rollback capabilities
  - [ ] Add audit logging for all state changes with user context and timestamps
  - [ ] Handle concurrent state transitions with optimistic locking

### Phase 2 Real-time Synchronization (TIMER-003 & TIMER-004)

- [ ] **BUSINESS CRITICAL - TIMER-003**: Implement WebSocket-based real-time timer updates with connection management (AC: 4, 8) [Source: tech-spec-epic-10.md#websocket-real-time-updates]
  - [ ] Create WebSocket subscription management for auction participants
  - [ ] Broadcast timer updates every second for active auctions
  - [ ] Implement connection recovery and state resynchronization on reconnection
  - [ ] Handle WebSocket connection pooling and scaling for 1000+ concurrent users
- [ ] **BUSINESS CRITICAL - TIMER-003**: Implement client-side timer synchronization with drift correction (AC: 4, 8) [Source: tech-spec-epic-10.md#timer-precision-considerations]
  - [ ] Sync client timers every 30 seconds with server time
  - [ ] Implement drift detection and correction algorithms
  - [ ] Provide fallback polling for unreliable WebSocket connections
  - [ ] Handle timezone conversions and display formatting
- [ ] **BUSINESS CRITICAL - TIMER-004**: Implement state persistence and recovery mechanisms (AC: 6, 8) [Source: tech-spec-epic-10.md#redis-timer-state-management]
  - [ ] Persist timer state in Redis with automatic expiration
  - [ ] Implement automatic recovery on service restart or network failure
  - [ ] Add health checks and monitoring for timer service availability
  - [ ] Implement graceful degradation when Redis is unavailable

### Phase 3 Integration & Analytics (TIMER-005 & TIMER-006)

- [ ] **INTEGRATION CRITICAL - TIMER-005**: Integrate with Epic 9 offer system for auction lifecycle management (AC: 5, 8) [Source: tech-spec-epic-10.md#component-mapping] [Source: architecture/story-component-mapping.md#epic-9--offers-auctions]
  - [ ] Connect timer service to offer submission flow for auction initiation
  - [ ] Implement bid placement validation with timer state checks
  - [ ] Provide high bid management and winner determination logic
  - [ ] Implement optimistic UI updates for bid placement activities
- [ ] **ANALYTICS CRITICAL - TIMER-006**: Implement comprehensive analytics event tracking (AC: 7, 8) [Source: analytics/mvp-analytics-events.md#offers-auction] [Source: tech-spec-epic-10.md#monitoring-and-analytics]
  - [ ] Track auction timer events: timer_started, timer_updated, timer_expired
  - [ ] Track soft-close events: auction_softclose_reset, auction_auto_closed_at_cap
  - [ ] Track state transition events with timing metrics and user context
  - [ ] Implement KPI tracking for auction completion rates and timer accuracy

### Standard Implementation Tasks

- [ ] Implement Flutter auction timer UI with BLoC state management using shared design tokens (AC: 1, 4) [Source: architecture/front-end-architecture.md#module-overview] [Source: architecture/front-end-architecture.md#state-management]
  - [ ] Create countdown timer widget with soft-close indication and formatting
  - [ ] Add timer synchronization logic with WebSocket integration
  - [ ] Implement loading states and error handling for timer disruptions
- [ ] Connect timer UI to Serverpod auction service via WebSocket and REST APIs (AC: 1, 2, 4) [Source: tech-spec-epic-10.md#api-endpoints] [Source: architecture/architecture.md#auction-service]
  - [ ] Implement GET /auctions/{id}/timer endpoint for timer status
  - [ ] Connect to WebSocket /auctions/{id}/updates for real-time updates
  - [ ] Handle connection failures and implement retry logic
- [ ] Implement timer accuracy monitoring and SLA compliance tracking (AC: 8) [Source: tech-spec-epic-10.md#monitoring-and-analytics]
  - [ ] Monitor timer drift and accuracy metrics
  - [ ] Track WebSocket latency and connection success rates
  - [ ] Implement alerting for timer failures or SLA breaches
  - [ ] Provide performance dashboards for timer service health

### Testing Requirements

- [ ] Comprehensive timer testing including precision, concurrency, and failure scenarios (AC: 1, 2, 3, 4, 5, 6, 7, 8) [Source: tech-spec-epic-10.md#testing-strategy]
  - [ ] Unit tests for timer logic, state machine, and extension mechanisms
  - [ ] Integration tests for WebSocket connectivity and event delivery
  - [ ] Performance tests for timer precision under load (100+ concurrent auctions)
  - [ ] Failure scenario tests for Redis persistence, network failures, and service restarts
  - [ ] End-to-end tests for complete auction lifecycle with timer events

## Dev Notes
### Previous Story Insights
- Epic 9 (Offer Submission) provides the foundation for auction initiation and bid placement logic. Timer management must integrate seamlessly with offer validation and bid processing. [Source: architecture/story-component-mapping.md#epic-9--offers-auctions]

### Data Models
- The `auctions` table stores timer state with `starts_at`, `ends_at`, and `soft_close_until` fields, enabling precise timer management and extension logic. [Source: tech-spec-epic-10.md#database-schema] [Source: solution-architecture.md#auction-table-schema]
- Redis stores active timer states with millisecond precision and version control for conflict resolution and recovery. [Source: tech-spec-epic-10.md#redis-timer-state-management]
- The `auction_audit_log` table captures all timer events, state transitions, and extension activities for comprehensive audit trails. [Source: tech-spec-epic-10.md#auction-audit-log-table]

### API Specifications
- `GET /auctions/{id}/timer` returns current timer state with remaining time, soft-close status, and synchronization data. [Source: tech-spec-epic-10.md#get-auction-timer-status]
- `WebSocket /auctions/{id}/updates` provides real-time timer updates, bid notifications, and state transition events to all connected participants. [Source: tech-spec-epic-10.md#websocket-real-time-updates]
- Timer service endpoints (`GET /timers/active`, `POST /timers/sync`, `GET /timers/{id}/status`) support monitoring and synchronization operations. [Source: tech-spec-epic-10.md#timer-management-endpoints]

### Component Specifications
- Flutter `commerce` module owns auction timer UI, WebSocket integration, and real-time updates using BLoC state management. [Source: architecture/story-component-mapping.md#epic-10--auction-timer-state-management]
- Serverpod `auction_service` implements timer logic, state machine, soft-close extensions, and WebSocket event broadcasting. [Source: architecture/story-component-mapping.md#serverpod-services-modules]
- Redis provides timer state persistence, real-time pub/sub, and background task scheduling for reliable timer operations. [Source: tech-spec-epic-10.md#technology-stack]

### File Locations
- UI and state code for this story belong under `video_window/lib/features/commerce/auction_timer/` following presentation, application, domain, and infrastructure layering. [Source: architecture/architecture.md#source-tree]
- Serverpod auction service implementation belongs under `serverpod/lib/src/modules/auction_service/` with timer, state, and WebSocket submodules. [Source: architecture/architecture.md#source-tree]
- Tests should mirror feature paths under `video_window/test/features/commerce/auction_timer/` and `serverpod/test/modules/auction_service/`. [Source: architecture/architecture.md#testing-strategy]

### Testing Requirements
- Maintain ≥80% coverage with comprehensive integration coverage for timer lifecycle, running `flutter test --no-pub` and `dart test` in CI. [Source: architecture/architecture.md#testing-strategy]
- Timer BLoCs and WebSocket components should use bloc_test package and integration tests for real-time communication scenarios. [Source: architecture/front-end-architecture.md#testing-strategy-client]
- Performance testing must validate timer precision within ±5 seconds under load of 100+ concurrent auctions. [Source: tech-spec-epic-10.md#performance-tests]

### Technical Constraints
- Timer precision must be maintained within ±5 seconds under normal load with server time synchronization and client drift correction. [Source: tech-spec-epic-10.md#timer-precision-considerations]
- Soft-close extensions must be limited to 15-minute increments with a maximum 24-hour total extension cap from original end time. [Source: brief.md#soft-close-auction-mechanics]
- WebSocket connections must support 1000+ concurrent participants with <100ms latency for timer updates and bid notifications. [Source: tech-spec-epic-10.md#real-time-updates]
- Redis timer state must persist across service restarts with automatic recovery and conflict resolution using version control. [Source: tech-spec-epic-10.md#redis-timer-state-management]
- All timer events and state transitions must be logged to the audit table with complete context for compliance and debugging. [Source: tech-spec-epic-10.md#auction-audit-log-table]
- Error handling must provide graceful degradation when Redis or WebSocket services are unavailable, with fallback polling mechanisms. [Source: tech-spec-epic-10.md#error-handling]

### Project Structure Notes
- Timer implementation aligns with documented monorepo structure using Flutter commerce module and Serverpod auction service. [Source: architecture/architecture.md#source-tree]
- WebSocket integration follows established patterns for real-time communication with connection pooling and recovery mechanisms. [Source: tech-spec-epic-10.md#websocket-infrastructure]

## Testing
- Follow the project testing pipeline by running `dart format`, `flutter analyze`, `flutter test --no-pub`, and `dart test` before submission. [Source: architecture/architecture.md#testing-strategy]
- Add comprehensive timer BLoC tests with fixtures covering timer precision, soft-close extensions, state transitions, and WebSocket communication scenarios. [Source: architecture/front-end-architecture.md#testing-strategy-client]
- Implement performance tests validating timer accuracy under load, WebSocket scalability, and Redis persistence reliability. [Source: tech-spec-epic-10.md#performance-tests]

## Change Log
| Date       | Version | Description        | Author             |
| ---------- | ------- | ------------------ | ------------------ |
| 2025-10-09 | v0.1    | Initial draft created | Claude Code Assistant |

## Dev Agent Record
### Agent Model Used
_(To be completed by Dev Agent)_

### Debug Log References
_(To be completed by Dev Agent)_

### Completion Notes List
_(To be completed by Dev Agent)_

### File List
_(To be completed by Dev Agent)_

## QA Results
_(To be completed by QA Agent)_