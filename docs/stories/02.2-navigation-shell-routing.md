# Story 02.2: Navigation Shell & Route Registry

**Epic:** 02 - Core Platform Services  
**Story ID:** 02.2  
**Created:** 2025-10-30  
**Status:** Ready for Development

---

## User Story

**As a** user,  
**I want** consistent navigation scaffolding,  
**so that** I can move between feed, story, dashboard, and settings without dead ends.

---

## Business Value

Establishes the navigation foundation that all features will build upon. Critical for user experience and deep linking support.

**Priority:** P0 (Critical - Foundation)

---

## Acceptance Criteria

1. **Navigator 2.0 Implementation:**
   - Implement declarative routing using Navigator 2.0 (or go_router)
   - Define typed routes for core destinations (feed, story detail, profile, settings, maker dashboard)
   - Support deep linking with URL parsing
   - Handle back button and system navigation gestures

2. **Route Guards:**
   - Implement authentication guards for maker-only routes
   - Redirect unauthenticated users to sign-in
   - Preserve deep link destination after successful auth

3. **Analytics Integration:**
   - Fire route change events to analytics system
   - Include previous route, new route, and navigation trigger
   - Support analytics tagging for A/B tests

4. **Error Handling:**
   - Implement 404/not-found route
   - Handle invalid deep links gracefully
   - Provide fallback navigation for error states

---

## Tasks / Subtasks

- [ ] **Task 1**: Router Setup (AC: 1)
  - [ ] Choose routing solution (go_router vs custom Navigator 2.0)
  - [ ] Define route paths and parameters
  - [ ] Implement RouterDelegate and RouteInformationParser
  - [ ] Configure deep linking (AndroidManifest.xml, Info.plist)

- [ ] **Task 2**: Route Registry (AC: 1)
  - [ ] Define all route names as constants
  - [ ] Create typed route builders with parameter validation
  - [ ] Implement route transition animations
  - [ ] Add route metadata (title, auth required, analytics tags)

- [ ] **Task 3**: Authentication Guards (AC: 2)
  - [ ] Implement auth state listener
  - [ ] Create redirect logic for protected routes
  - [ ] Store intended destination for post-auth redirect
  - [ ] Handle session expiry during navigation

- [ ] **Task 4**: Analytics Integration (AC: 3)
  - [ ] Create navigation observer
  - [ ] Emit screen_view events with route metadata
  - [ ] Track navigation source (deep link, in-app, back button)
  - [ ] Include user_id and session_id in events

- [ ] **Task 5**: Error Handling (AC: 4)
  - [ ] Create 404 not-found screen
  - [ ] Implement error boundary for navigation failures
  - [ ] Handle malformed deep links with user-friendly messages
  - [ ] Add fallback home navigation from error states

---

## Dependencies

- **Technical:** Epic 02.1 (Design tokens) for themed navigation UI
- **Business:** Define priority order for feature rollout (which routes first)
- **Prerequisites:** Epic 01.1 (Repository) complete, Flutter app structure exists

---

## Out of Scope

- Bottom navigation bar implementation (separate story in Epic 04)
- Side drawer/menu implementation
- Tab-based navigation within features
- Gesture-based navigation animations

---

## Related Files

- `video_window_flutter/lib/presentation/routing/app_router.dart`
- `video_window_flutter/lib/presentation/routing/route_guards.dart`
- `video_window_flutter/lib/presentation/routing/route_paths.dart`
- `video_window_flutter/lib/presentation/routing/navigation_observer.dart`
- `android/app/src/main/AndroidManifest.xml`
- `ios/Runner/Info.plist`

---

## Testing Requirements

### Unit Tests
- Route parsing logic
- Auth guard redirect behavior
- Deep link parsing

### Widget Tests
- Navigation between routes
- Back button handling
- Route transitions

### Integration Tests
- Deep link end-to-end flow
- Auth guard with sign-in flow
- Analytics event emission

**Minimum Coverage:** 85%

---

## Notes

**Technical Notes:** Prefer go_router for type safety and deep link handling. Benchmark route transition performance on mid-tier devices.

**Security Notes:** Validate all route parameters to prevent injection attacks. Never trust deep link parameters without sanitization.

---

## Change Log

| Date | Version | Changes | Author |
|------|---------|---------|--------|
| 2025-10-30 | 1.0 | Initial story creation | Bob (Scrum Master) |
