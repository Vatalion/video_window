# Story 03.1: Structured Logging & Metrics

**Epic:** 03 - Observability & Compliance Baseline  
**Story ID:** 03.1  
**Created:** 2025-10-30  
**Status:** Ready for Development

---

## User Story

**As an** SRE,  
**I want** structured logs and key metrics from day one,  
**so that** issues can be detected and triaged quickly.

---

## Business Value

Enables operational excellence and rapid incident response. Critical for meeting SLA targets and debugging production issues.

**Priority:** P0 (Critical - Foundation)

---

## Acceptance Criteria

1. **Flutter Application Logging:**
   - Log user/session identifiers (hashed) with severity levels (debug, info, warn, error, fatal)
   - Route logs to console in development, backend collector in production
   - Include contextual metadata (screen, action, user_id)
   - Never log PII, passwords, or payment details

2. **Serverpod Structured Logging:**
   - Emit JSON logs with request IDs, latency, error codes
   - Include user_id, session_id, endpoint name
   - Log level configuration (debug in dev, info in prod)
   - Export logs to CloudWatch/stdout for container environments

3. **Key Metrics Collection:**
   - API request rate, latency (p50/p90/p95/p99)
   - Error rates (4xx, 5xx) per endpoint
   - Database query duration
   - Cache hit/miss rates
   - Export metrics via Prometheus/OpenTelemetry

4. **Monitoring Dashboard:**
   - Create Grafana dashboard stub (or CloudWatch dashboard)
   - Document expected charts (RPS, latency, errors, DB performance)
   - Define alert thresholds (latency p95 > 500ms, error rate > 5%)
   - Link to runbooks for common alerts

---

## Tasks / Subtasks

- [ ] **Task 1**: Flutter Logging Setup (AC: 1)
  - [ ] Configure logging package (`logger` or `logging`)
  - [ ] Create LoggingService wrapper
  - [ ] Implement log routing (console vs backend)
  - [ ] Add contextual logging helpers (screen_name, user_id)
  - [ ] Implement PII redaction filters

- [ ] **Task 2**: Serverpod Logging (AC: 2)
  - [ ] Configure structured JSON logging
  - [ ] Add request_id middleware
  - [ ] Log all endpoint requests (method, path, duration, status)
  - [ ] Emit error logs with stack traces
  - [ ] Configure log levels per environment

- [ ] **Task 3**: Metrics Instrumentation (AC: 3)
  - [ ] Integrate Prometheus client or OpenTelemetry
  - [ ] Instrument HTTP endpoints (request count, duration histogram)
  - [ ] Instrument database queries (query count, duration)
  - [ ] Instrument Redis operations (get/set counts, hit rate)
  - [ ] Expose `/metrics` endpoint for scraping

- [ ] **Task 4**: Monitoring Dashboard (AC: 4)
  - [ ] Create Grafana dashboard JSON or CloudWatch dashboard
  - [ ] Add panels for RPS, latency percentiles, error rates
  - [ ] Add DB query duration and connection pool metrics
  - [ ] Document alert thresholds in `docs/runbooks/monitoring.md`
  - [ ] Link alerts to runbooks

---

## Dependencies

- **Technical:** Serverpod backend running, Docker/K8s for log aggregation
- **Business:** Define SLA targets (latency, availability)
- **Prerequisites:** Epic 01.1 complete

---

## Out of Scope

- Distributed tracing (deferred to post-MVP)
- Log aggregation platform setup (use Docker logs → CloudWatch for MVP)
- Custom alerting platform (use CloudWatch Alarms for MVP)
- APM tools (New Relic, Datadog) - MVP uses basic monitoring

---

## Related Files

- `video_window_flutter/packages/core/lib/services/logging_service.dart`
- `video_window_server/lib/src/middleware/logging_middleware.dart`
- `video_window_server/lib/src/middleware/metrics_middleware.dart`
- `docs/runbooks/monitoring.md`
- `deploy/grafana/dashboards/api-overview.json`

---

## Testing Requirements

### Unit Tests
- Log formatting and redaction
- Metrics emission correctness

### Integration Tests
- End-to-end log flow (app → backend → CloudWatch)
- Metrics scraping endpoint

**Minimum Coverage:** 80%

---

## Notes

**Technical Notes:** Use `logger` package for Flutter, built-in Serverpod logging for backend. Prometheus is preferred for metrics but OpenTelemetry acceptable.

**Security Notes:** Audit log output to ensure no PII leakage. Implement automated PII detection tests.

---

## Change Log

| Date | Version | Changes | Author |
|------|---------|---------|--------|
| 2025-10-30 | 1.0 | Initial story creation | Bob (Scrum Master) |
