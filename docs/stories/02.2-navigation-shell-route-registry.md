# Story 02.2: Build Navigation Shell and Route Registry

**Epic:** 02 - Core Platform Services  
**Story ID:** 02.2  
**Priority:** P0 - Critical (Foundation)  
**Estimated Effort:** 8 story points  
**Status:** Draft

---

## User Story

**As a** user,  
**I want** consistent navigation scaffolding,  
**So that** I can move between feed, story, dashboard, and settings without dead ends.

---

## Business Value

- **User Experience:** Seamless navigation across all app sections
- **Developer Velocity:** Standardized routing patterns reduce implementation time
- **Maintainability:** Centralized navigation logic simplifies future changes
- **Deeplink Support:** Enable marketing campaigns and external integrations

---

## Acceptance Criteria

1. **Navigator 2.0 Implementation**
   - Implement declarative routing with go_router or equivalent
   - Define typed routes for all core destinations (feed, story, profile, settings)
   - Support nested navigation for complex flows (offer → bid → payment)

2. **Route Guards**
   - Implement authentication guards for protected routes
   - Redirect unauthenticated users to login
   - Implement maker-only route protection with role checks

3. **Deeplink Handling**
   - Support universal links for iOS (associated domains configured)
   - Support app links for Android (intent filters configured)
   - Parse and navigate to deep-linked routes on app launch
   - Handle invalid/expired deeplinks gracefully

4. **Navigation Analytics**
   - Emit route change events when navigation occurs
   - Include source route, destination route, and user context
   - Support navigation funnel analysis (e.g., feed → story → offer)

5. **Error Handling**
   - Display "Page Not Found" screen for invalid routes
   - Provide navigation back to home feed
   - Log navigation errors for debugging

---

## Technical Implementation

### Route Structure
```dart
// Core routes
/feed                           # Home feed
/story/:storyId                 # Story detail
/offer/:offerId                 # Offer submission
/auction/:auctionId             # Auction detail
/payment/:orderId               # Payment window
/profile                        # User profile
/settings                       # App settings

// Maker routes (guarded)
/maker/dashboard                # Maker overview
/maker/create                   # Story creation
/maker/listings                 # Listings management
/maker/orders                   # Orders & shipping
```

### Router Configuration
```dart
final router = GoRouter(
  routes: [
    GoRoute(
      path: '/feed',
      builder: (context, state) => FeedPage(),
    ),
    GoRoute(
      path: '/story/:storyId',
      builder: (context, state) => StoryDetailPage(
        storyId: state.params['storyId']!,
      ),
    ),
    // Maker routes with guards
    GoRoute(
      path: '/maker/dashboard',
      redirect: (context, state) {
        final authBloc = context.read<AuthBloc>();
        if (!authBloc.state.isAuthenticated) return '/login';
        if (!authBloc.state.user?.isMaker) return '/feed';
        return null; // Allow navigation
      },
      builder: (context, state) => MakerDashboardPage(),
    ),
  ],
  redirect: (context, state) {
    // Global auth redirect logic
  },
);
```

---

## Tasks / Subtasks

### Phase 1: Router Setup (Day 1)
- [ ] Add go_router dependency to pubspec.yaml
- [ ] Create `lib/core/routing/app_router.dart` with route definitions
- [ ] Define typed route paths in `lib/core/routing/routes.dart`
- [ ] Implement MaterialApp.router configuration
- [ ] Test basic navigation between pages

### Phase 2: Route Guards (Day 1-2)
- [ ] Implement authentication guard checking AuthBloc state
- [ ] Create maker role guard checking user.isMaker flag
- [ ] Add redirect logic for unauthorized access
- [ ] Test protected route access scenarios
- [ ] Implement persistent redirect after login

### Phase 3: Deeplink Support (Day 2)
- [ ] Configure iOS associated domains in Xcode
- [ ] Configure Android intent filters in AndroidManifest.xml
- [ ] Implement deeplink parsing in router
- [ ] Test deeplink navigation on both platforms
- [ ] Handle invalid/malformed deeplinks

### Phase 4: Analytics Integration (Day 2-3)
- [ ] Create navigation observer for route tracking
- [ ] Emit `screen_view` analytics events on route change
- [ ] Include route metadata (name, params, source)
- [ ] Test analytics event emission
- [ ] Verify event flow to backend

### Phase 5: Error Handling (Day 3)
- [ ] Create NotFoundPage widget for 404 errors
- [ ] Implement error redirect logic in router
- [ ] Add navigation error logging
- [ ] Test error scenarios (invalid routes, missing params)
- [ ] Create user-friendly error messages

---

## Dependencies

**Technical:**
- Epic 02.1 (Design Tokens) for consistent page styling
- Epic 02.4 (Telemetry) for analytics integration
- Epic 1 (Authentication) for route guards

**Business:**
- UX team approval on navigation patterns
- Marketing team input on deeplink structure

**Prerequisites:**
- Flutter app scaffold from Epic 01.1
- AuthBloc implementation from Epic 1

---

## Out of Scope

- Advanced navigation animations (post-MVP)
- Navigation state persistence across app restarts
- Complex nested navigation with bottom nav + tabs
- Custom transition animations
- Web-specific routing features

---

## Testing Requirements

### Unit Tests
- Route parsing and parameter extraction
- Guard logic (auth, role checks)
- Redirect logic for unauthorized access

### Widget Tests
- Navigation between pages
- Back button behavior
- Deeplink handling

### Integration Tests
- End-to-end navigation flows (feed → story → offer)
- Protected route access attempts
- Deeplink navigation from external sources

**Coverage Target:** ≥80%

---

## Definition of Done

- [ ] All acceptance criteria validated
- [ ] Unit tests passing with ≥80% coverage
- [ ] Widget tests for navigation flows passing
- [ ] Integration tests for deeplinks passing
- [ ] Code review approved
- [ ] Documentation updated (routing architecture)
- [ ] Analytics events verified in test environment
- [ ] UX team sign-off on navigation patterns

---

## Notes

**UX Considerations:**
- Navigation transitions should feel smooth and natural
- Back button behavior must be intuitive (especially in nested flows)
- Loading states during navigation handled gracefully
- Deeplinks must work from cold app start

**Technical Debt:**
- Consider migration to auto_route if route generation becomes complex
- Navigation state restoration will be needed for state preservation

---

**Related Documents:**
- [Core Platform Services Tech Spec](../tech-spec-epic-02.md)
- [Front-End Architecture](../architecture/front-end-architecture.md)
- [Coding Standards](../architecture/coding-standards.md)

---

*Created: 2025-10-30*  
*Last Updated: 2025-10-30*  
*Author: Bob (Scrum Master)*
