# Story 1.3: Session Management & Refresh

## Status
Ready for Dev

## Story
**As a** logged-in viewer or maker,
**I want** sessions to refresh automatically and revoke securely when needed,
**so that** I stay authenticated without interruption while protecting my account.

## Acceptance Criteria
1. Client schedules background refresh five minutes before access token expiry, retries with exponential backoff, and logs out gracefully after consecutive failures. [Source: docs/tech-spec-epic-1.md#implementation-guide]
2. Serverpod `session_service.dart` rotates refresh tokens on each use, rejects reuse, records device/IP metadata, and blacklists revoked tokens. [Source: docs/tech-spec-epic-1.md#session-management]
3. Logout invalidates sessions server-side, clears secure storage, and broadcasts revocation analytics + audit events. [Source: docs/tech-spec-epic-1.md#security-implementation]
4. **SECURITY CRITICAL**: Refresh token reuse detection locks the account, forces global logout, and alerts security monitoring. [Source: docs/tech-spec-epic-1.md#security-implementation]
5. **PERFORMANCE**: Refresh latency ≤ 1s p95 and failure rate <1% under load, measured via Datadog dashboards. [Source: docs/analytics/authentication-dashboard.md]

## Prerequisites
1. Story 1.1 – Implement Email OTP Sign-In (baseline session issuance).
2. Story 1.2 – Social Login Integration (shared auth repository + analytics events).
3. Redis and Postgres migrations for refresh tokens deployed per tech spec.

## Tasks / Subtasks

### Phase 1 – Client Session Lifecycle
- [ ] Implement `session_service.dart` client with refresh scheduler, retries, and logout hooks (AC: 1). [Source: docs/tech-spec-epic-1.md#source-tree--file-directives]
- [ ] Persist refresh metadata (last refresh time, failure streak) to secure storage for crash resilience (AC: 1).
- [ ] Extend `AuthBloc` to handle `SessionRefreshRequested`, `SessionRefreshSucceeded`, `SessionRefreshFailed`, and `LogoutRequested` transitions (AC: 1,3).

### Phase 2 – Server Session Hardening
- [ ] Update Serverpod `session_service.dart` to rotate refresh tokens, blacklist revoked tokens, and store device/IP fingerprinting (AC: 2,4). [Source: docs/tech-spec-epic-1.md#session-management]
- [ ] Add refresh token repository + migration for hashed token storage and reuse detection timestamps (AC: 2).
- [ ] Emit audit events (`auth.session.rotated`, `auth.session.revoked`, `auth.session.reuse_detected`) and push to security channel. [Source: docs/tech-spec-epic-1.md#monitoring-and-analytics]

### Phase 3 – Observability & Testing
- [ ] Configure Datadog monitors for refresh latency, failure rate, and reuse alerts; integrate with `Authentication Dashboard`. [Source: docs/analytics/authentication-dashboard.md]
- [ ] Write unit tests for client scheduler, secure storage adapters, and server reuse detection logic (AC: 1,2,4).
- [ ] Add integration tests covering successful refresh, expired refresh token, reuse attempt, and logout flows (AC: 2,3,4).

## Data Models
- `sessions` table stores device info, expiry, and IP to support reuse detection. [Source: docs/tech-spec-epic-1.md#database-migrations]
- `refresh_tokens` table (new) maintains hashed token, user ID, device fingerprint, and revocation metadata. [Source: docs/tech-spec-epic-1.md#source-tree--file-directives]

## API Specifications
- `POST /auth/refresh` exchanges refresh token for new session/refresh pair; returns HTTP 401 on invalid or reused tokens. [Source: docs/tech-spec-epic-1.md#authentication-endpoints]
- `POST /auth/logout` revokes the active session and associated refresh token. [Source: docs/tech-spec-epic-1.md#authentication-endpoints]

## Component Specifications
- Client scheduler lives in `packages/core/lib/data/services/auth/session_service.dart` and integrates with app lifecycle to pause/resume refresh. [Source: docs/tech-spec-epic-1.md#source-tree--file-directives]
- Server rotation enforcement resides in `video_window_server/lib/src/services/session_service.dart` with Redis cache for blacklist checks. [Source: docs/tech-spec-epic-1.md#session-management]

## File Locations
- Client: `video_window_flutter/packages/core/lib/data/services/auth/` and `.../repositories/auth_repository.dart`.
- Server: `video_window_server/lib/src/services/session_service.dart`, `.../repositories/refresh_token_repository.dart`.
- Tests: `packages/features/auth/test/use_cases/session_refresh_use_case_test.dart`, integration tests under `video_window_server/test/identity/`.

## Testing Requirements
- Unit tests for client scheduler, server reuse detection, and logout revocation logic.
- Integration tests simulating refresh rotation, reuse alerts, and multi-device scenarios.
- Load test refresh endpoint to validate latency target using k6 script referenced in spec.
- Security tests ensure revoked tokens cannot be reused and suspicious reuse triggers alerts.

## Technical Constraints
- Refresh tokens stored hashed (bcrypt) with per-device salt; plaintext never persisted. [Source: docs/tech-spec-epic-1.md#security-implementation]
- Reuse detection must lock account and flush all sessions; manual override documented in runbook. [Source: docs/runbooks/authentication.md]
- Scheduler integrates with app lifecycle to avoid refresh while backgrounded beyond iOS/Android limits.
- Logging must exclude token values; only hashes/correlation IDs allowed.

## Change Log
| Date       | Version | Description                                      | Author            |
| ---------- | ------- | ------------------------------------------------ | ----------------- |
| 2025-10-29 | v1.0    | Definitive session refresh story authored        | GitHub Copilot AI |

## Dev Agent Record
### Agent Model Used
_(To be completed by Dev Agent)_

### Debug Log References
_(To be completed by Dev Agent)_

### Completion Notes List
_(To be completed by Dev Agent)_

### File List
_(To be completed by Dev Agent)_

## QA Results
_(To be completed by QA Agent)_
