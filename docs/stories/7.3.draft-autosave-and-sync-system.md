# Story 7.3: Draft Autosave & Sync System

## Status
Ready for Dev

## Story
**As a** platform reliability engineer,
**I want** resilient draft autosave, conflict resolution, and multi-device synchronization,
**so that** makers never lose editing progress and can seamlessly collaborate across devices.

## Acceptance Criteria
1. Autosave cadence runs every 20 seconds (configurable via `AUTO_SAVE_INTERVAL_SECONDS`) persisting encrypted snapshots to Drift-backed storage with version numbers. *(Ref: docs/tech-spec-epic-7.md – Environment Configuration, Implementation Guide §3)*
2. Draft sync communicates with Serverpod `draft_endpoint.dart`, exchanging version vectors and detecting conflicts; conflicts surface UI prompts via `draft_sync_bloc`. *(Ref: docs/tech-spec-epic-7.md – Source Tree & File Directives, Implementation Guide §3)*
3. Conflict resolution uses three-way merge with audit logging; resolved drafts emit analytics event `maker_draft_resolved` and create history entries. *(Ref: docs/tech-spec-epic-7.md – Implementation Guide §3, Monitoring & Analytics)*
4. Autosave latency p95 ≤ 250ms and sync success ≥ 99% tracked through Datadog metrics `maker.draft.autosave_latency_ms` and `maker.capture.success_rate`. *(Ref: docs/tech-spec-epic-7.md – Monitoring & Analytics)*
5. Offline resilience ensures edits queue locally and replay once connectivity returns, with backoff/retry policy and end-to-end tests. *(Ref: docs/tech-spec-epic-7.md – Implementation Guide §3)*
6. Drift schema (`draft_database.dart`) migrates existing draft data without loss and exposes migrations tested in staging. *(Ref: docs/tech-spec-epic-7.md – Source Tree & File Directives)*

## Prerequisites
1. Story 7.1 – Maker Story Capture & Editing Tools (baseline capture data model).
2. Story 7.2 – Timeline Editing & Captioning Implementation (timeline surface & analytics hooks).
3. Serverpod infrastructure for drafts (`story/draft` endpoints) provisioned per Epic 7 spec.

## Tasks / Subtasks

### Phase 1 – Local Persistence & Autosave
- [ ] Create Drift schema `draft_database.dart` mirroring spec tables, including migrations for legacy SQLite data. *(Ref: docs/tech-spec-epic-7.md – Source Tree & File Directives)*
- [ ] Update `draft_repository.dart` to use Drift DAOs, encryption via `local_encryption_service.dart`, and LRU cleanup of stale drafts. *(Ref: docs/tech-spec-epic-7.md – Implementation Guide §3)*
- [ ] Implement autosave scheduler in `draft_sync_bloc.dart` using `AUTO_SAVE_INTERVAL_SECONDS` and device profiling for throttle adjustments. *(Ref: docs/tech-spec-epic-7.md – Environment Configuration)*
- [ ] Emit Datadog metric `maker.draft.autosave_latency_ms` and Segment event `maker_draft_autosaved` with payload (version, clip count). *(Ref: docs/tech-spec-epic-7.md – Monitoring & Analytics)*

### Phase 2 – Sync & Conflict Resolution
- [ ] Extend Serverpod `draft_endpoint.dart` to accept version vectors, detection flags, and return conflict payloads. *(Ref: docs/tech-spec-epic-7.md – Source Tree & File Directives)*
- [ ] Implement `resolve_draft_conflict_use_case.dart` using three-way merge strategy; add unit tests for clip merges, caption merges, and simultaneous edits. *(Ref: docs/tech-spec-epic-7.md – Implementation Guide §3)*
- [ ] Build UI flow in `draft_sync_bloc` and maker studio page for conflict toast, comparison view, and manual selection. *(Ref: docs/tech-spec-epic-7.md – Implementation Guide §3)*
- [ ] Log conflicts to Kibana via structured logs and emit Segment `maker_draft_conflict_detected`. *(Ref: docs/tech-spec-epic-7.md – Monitoring & Analytics)*

### Phase 3 – Offline & QA Hardening
- [ ] Add queued sync transactions with exponential backoff, dedupe, and jitter; verify offline-first behaviour via integration tests. *(Ref: docs/tech-spec-epic-7.md – Implementation Guide §3)*
- [ ] Update `maker_studio_checks.yaml` to run conflict simulation suite and offline replay tests. *(Ref: docs/tech-spec-epic-7.md – Implementation Guide §4)*
- [ ] Document runbook `docs/runbooks/maker-studio.md` for autosave failures, conflicts, and remediation steps. *(Ref: docs/tech-spec-epic-7.md – Implementation Guide §5)*
- [ ] Ensure GDPR/CCPA compliance for draft data retention and deletion workflows. *(Ref: docs/compliance/data-retention.md)*

## Dev Notes
- Keep encrypted snapshots small by storing incremental diffs; rely on ffmpeg re-encoding pipeline only when necessary. *(Ref: docs/tech-spec-epic-7.md – Implementation Guide §3)*
- Autosave scheduler should pause during high-load operations (export/render) and resume afterwards. *(Ref: docs/tech-spec-epic-7.md – Monitoring & Analytics)*
- Coordinate conflict logging with analytics team for dashboard updates and SLA tracking. *(Ref: docs/analytics/maker-studio-dashboard.md)*

## Testing
- Run `melos run test -- --tags maker-draft` covering repositories, blocs, and use cases. *(Ref: docs/tech-spec-epic-7.md – Test Traceability)*
- Execute integration tests `maker_draft_sync_test.dart` (offline/online) and `draft_conflict_flow_test.dart`. *(Ref: docs/tech-spec-epic-7.md – Implementation Guide §3)*
- Validate Datadog dashboards: autosave latency ≤ 250ms p95, conflict rate trend <5% of total saves. *(Ref: docs/tech-spec-epic-7.md – Monitoring & Analytics)*

## Change Log
| Date       | Version | Description                  | Author            |
| ---------- | ------- | ---------------------------- | ----------------- |
| 2025-10-29 | v0.1    | Initial story definition     | GitHub Copilot AI |
