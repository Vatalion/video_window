# Story 5.2: Accessible Playback & Transcripts

## Status
Ready for Dev

## Story
**As a** viewer who relies on accessibility features,
**I want** captions, transcripts, keyboard controls, and assistive integrations in the story experience,
**so that** I can fully consume story content regardless of my accessibility needs

## Acceptance Criteria
1. Closed captions support at least English, Spanish, and French tracks with ability to toggle per user session and styling that meets WCAG 2.1 AA contrast requirements.
2. Transcript panel renders synchronized cues with keyboard navigation (Tab/Shift+Tab, Arrow keys), search filtering, and click-to-seek back into the video.
3. Screen reader announcements cover playback state changes, section navigation, and transcript selection using localized messaging.
4. Keyboard shortcuts (Space, Arrow Left/Right, Arrow Up/Down, `C`, `F`) control playback, seeking, volume, captions, and fullscreen as defined in the spec without conflicting with OS reserved keys.
5. High contrast mode and reduced motion preferences are auto-detected from system settings and applied without requiring a restart.
6. Accessibility assets (captions/transcripts) are cached offline per story for 24 hours with eviction when storage exceeds 50MB.
7. Analytics events `story_caption_toggled` and `story_transcript_viewed` emit with required attributes (`storyId`, `language`, `wasEnabled`, `searchTerm`, `userAccessibilityProfile`).
8. Axe-core CI job (`story_accessibility_checks.yaml`) and widget tests pass with zero violations; manual QA confirms compliance using VoiceOver/TalkBack.

## Prerequisites
1. Story 5.1 – Story Detail Page Implementation (layout and base player shell)
2. Epic 6 Story 6.1 – Media Pipeline Content Protection (ensures caption track availability)
3. Accessibility guidelines outlined in `accessibility/accessibility-guide.md`

## Tasks / Subtasks

### Phase 1 – Caption & Transcript Infrastructure

- [ ] Implement `prepare_accessibility_assets_use_case.dart` to fetch caption and transcript assets, persisting to secure storage with 24h TTL (AC: 1, 2, 6) [Source: docs/tech-spec-epic-5.md#source-tree--file-directives]
  - [ ] Integrate with `story_transcript_service.dart` endpoint to request localized caption bundles (AC: 1) [Source: docs/tech-spec-epic-5.md#implementation-guide]
  - [ ] Add offline cache eviction policy (50MB cap) with unit coverage in `prepare_accessibility_assets_use_case_test.dart` (AC: 6) [Source: docs/tech-spec-epic-5.md#test-traceability-matrix]
- [ ] Create `accessibility/caption_service.dart` for WebVTT parsing, styling, and language switching (AC: 1, 7) [Source: docs/tech-spec-epic-5.md#source-tree--file-directives]
  - [ ] Normalize cues and expose `CaptionCue` streams for the video player BLoC (AC: 1)
  - [ ] Emit analytics via `story_analytics_service.dart` when captions toggled (AC: 7)
- [ ] Build `transcript_panel.dart` widget with synchronized cue highlighting, search box, and keyboard nav traps (AC: 2, 4) [Source: docs/tech-spec-epic-5.md#accessibility-implementation]
  - [ ] Implement `find` shortcut (`Cmd/Ctrl+F`) and `Enter` to jump to selected cue (AC: 2)
  - [ ] Add focus-visible outlines and high contrast palette tokens (AC: 2, 5)

### Phase 2 – Player Accessibility Enhancements

- [ ] Enhance `story_video_player.dart` controls for screen reader labels, high contrast themes, and reduced motion toggles (AC: 3, 5) [Source: docs/tech-spec-epic-5.md#accessibility-implementation]
  - [ ] Ensure `Semantics` tree announces playback state transitions (`playing`, `paused`, `buffering`, etc.) (AC: 3)
  - [ ] Respect platform reduced motion preferences by disabling auto-animations (AC: 5)
- [ ] Implement keyboard shortcut handler referencing spec key map, including conflict detection with OS shortcuts (AC: 4) [Source: docs/tech-spec-epic-5.md#implementation-guide]
  - [ ] Add automated tests simulating keyboard events for Space, Arrow keys, `C`, and `F` (AC: 4)
- [ ] Create `story_accessibility_page.dart` debug surface toggled from developer menu to visualize captions, transcript sync, and focus order (AC: 8) [Source: docs/tech-spec-epic-5.md#source-tree--file-directives]

### Phase 3 – Analytics, QA, and Monitoring

- [ ] Extend `story_event_sink.dart` to publish `story_caption_toggled` and `story_transcript_viewed` schemas with defined attributes (AC: 7) [Source: docs/tech-spec-epic-5.md#analytics--observability]
  - [ ] Update Segment tracking plan and Datadog dashboards with caption/transcript metrics (AC: 7)
- [ ] Configure CI workflow `story_accessibility_checks.yaml` to run axe-core Flutter driver tests nightly (AC: 8) [Source: docs/tech-spec-epic-5.md#analytics--observability]
  - [ ] Add widget golden comparisons for captions/transcript panels at 320px, 768px, and 1280px widths (AC: 1, 2)
- [ ] Document VoiceOver/TalkBack manual QA steps in `testing/manual/accessibility-story.md` (AC: 8) [Source: docs/tech-spec-epic-5.md#test-traceability-matrix]

## Dev Notes
- Reference `docs/tech-spec-epic-5.md#implementation-guide` for sequencing and cross-team dependencies.
- Ensure caption/transcript caching honors 1Password-managed secrets detailed in `docs/tech-spec-epic-5.md#deployment-considerations` when requesting signed URLs.
- Coordinate with Media Pipeline team to validate caption asset availability and fallback behavior before merging.

## Dev Agent Record

### Context Reference

<!-- Path(s) to story context XML will be added here by context workflow -->

### Agent Model Used

<!-- Will be populated during dev-story execution -->

### Debug Log References

<!-- Will be populated during dev-story execution -->

### Completion Notes List

<!-- Will be populated during dev-story execution -->

### File List

<!-- Will be populated during dev-story execution -->

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-06 | v0.1 | Initial story creation | Bob (SM) |
