# Story 5.3: Share & Save Functionality

## Status
Ready for Dev

## Story
**As a** viewer who wants to revisit and promote favorite stories,
**I want** to save stories to a wishlist and share deep linked previews with friends,
**so that** I can return later to purchase and help others discover the maker

## Acceptance Criteria
1. "Save" button toggles wishlist state with optimistic UI, persists via Serverpod, and reflects status across sessions within 2 seconds.
2. Share sheet presents platform native options (iOS ShareSheet, Android Intent chooser) and copies deep link to clipboard with success confirmation.
3. Generated deep links include signed Firebase Dynamic Link, UTM parameters, maker attribution, expiry 24h, and open the corresponding story/section in-app/web.
4. Share previews render OG metadata (title, description, image) using `story-share-renderer@2025.10` Lambda; preview loads in ≤400ms p95.
5. Every share/save action emits analytics events (`story_shared`, `story_saved`) with schema defined in the tech spec and correlates with story feed metrics.
6. Rate limiting prevents more than 20 share tokens per user per hour; exceeding attempts return friendly error state with retry guidance.
7. Offline handling queues share/save requests and syncs within 10 seconds of reconnect.
8. QA sign-off confirms links operate correctly on iOS, Android, and mobile web, including deep link fallback to the App Store when app absent.

## Prerequisites
1. Story 5.1 – Story Detail Page Implementation (CTA placement, base share button)
2. Story 5.2 – Accessible Playback & Transcripts (ensures share button accessible semantics)
3. Epic 1 Story 1.1 – Viewer Authentication (for user identity in shares/saves)

## Tasks / Subtasks

### Phase 1 – Wishlist & State Management

- [ ] Update `toggle_story_save_use_case.dart` to call new Serverpod endpoint and handle optimistic UI with rollback on failure (AC: 1, 7) [Source: docs/tech-spec-epic-5.md#source-tree--file-directives]
  - [ ] Extend `story_bloc.dart` state to include `isSaved`, `wishlistId`, and error messaging (AC: 1) [Source: docs/tech-spec-epic-5.md#implementation-guide]
  - [ ] Add persistence via `share_repository.dart` with cache invalidation on logout (AC: 1)
- [ ] Instrument `story_saved` analytics via `story_analytics_service.dart` capturing `storyId`, `makerId`, `saveState`, `ctaSurface` (AC: 5) [Source: docs/tech-spec-epic-5.md#analytics--observability]

### Phase 2 – Share Token Issuance & UI

- [ ] Build `story_share_sheet.dart` widget invoking platform share sheets, clipboard operations, and preview thumbnails (AC: 2, 4) [Source: docs/tech-spec-epic-5.md#source-tree--file-directives]
  - [ ] Display preview metadata returned from deep link use case, including expiration timestamp (AC: 4)
  - [ ] Add toast/snackbar confirming copy success with analytics hook (AC: 2, 5)
- [ ] Implement `generate_story_deep_link_use_case.dart` to call `story_share_endpoint.dart`, handle rate limiting (HTTP 429), and produce `ShareResponse` domain entity (AC: 3, 6) [Source: docs/tech-spec-epic-5.md#implementation-guide]
  - [ ] Attach UTM params (`utm_source`, `utm_medium`, `utm_campaign`) and maker handle to link as defined in spec (AC: 3)
  - [ ] Queue offline share intents via local storage when network unavailable; sync on reconnect (AC: 7)

### Phase 3 – Server & Infrastructure

- [ ] Create Serverpod `story_share_endpoint.dart` with rate limiting (20/hour) using Redis token bucket and audit logging (AC: 3, 6) [Source: docs/tech-spec-epic-5.md#source-tree--file-directives]
  - [ ] Persist share records in `story_shares` table with expiry; ensure cleanup job in cron worker (AC: 3, 6)
- [ ] Extend Lambda `story-share-renderer@2025.10` to fetch story assets and render OG metadata compliant with spec (AC: 4) [Source: docs/tech-spec-epic-5.md#analytics--observability]
  - [ ] Monitor latency via CloudWatch metric forwarded to Datadog alert `story-share-latency` (AC: 4, 5)

### Phase 4 – QA, Analytics, and Compliance

- [ ] Update Segment schemas and Datadog dashboards for `story_shared` and `story_saved` metrics with conversion goals (AC: 5) [Source: docs/tech-spec-epic-5.md#analytics--observability]
  - [ ] Add Grafana panel for share conversion rate (target ≥12%) and wishlist retention (AC: 5)
- [ ] Execute cross-platform QA playbook verifying deep link routing, App Store fallback, and expirations (AC: 8) [Source: docs/tech-spec-epic-5.md#success-metrics]
  - [ ] Document manual QA steps in `testing/manual/story-share-flow.md` with screenshots (AC: 8)
- [ ] Validate offline queue with simulated airplane mode scenario and ensure sync within 10 seconds on reconnect (AC: 7) [Source: docs/tech-spec-epic-5.md#test-traceability-matrix]

## Dev Notes
- Follow `docs/tech-spec-epic-5.md#implementation-guide` for sequencing between Flutter, Serverpod, and infrastructure workstreams.
- Use secrets declared in `docs/tech-spec-epic-5.md#deployment-considerations` (`vault://content-protection/story_hls_jwt_secret_v3`, Firebase Dynamic Links credentials) when configuring deep link service.
- Coordinate with Growth/Marketing for UTM campaign naming to ensure analytics dashboards correlate with feed attribution.
