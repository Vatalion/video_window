# Story 5.1: Comment System

## 1. Title
Threaded comment system with rich text formatting and media attachments for craft content engagement and technical discussions.

## 2. Context
**Background and Motivation:** This story addresses the critical need for meaningful community engagement in the craft marketplace where detailed technical discussions drive commercial success. Unlike generic social platforms, Video Window requires a comment system specifically designed for craft creators and enthusiasts to share techniques, materials, and processes that directly inform purchasing decisions.

**Market Positioning:** The comment system creates competitive advantage through:
- **Craft-First Engagement**: Supports technical discussions, technique sharing, and material-specific conversations that drive craft commerce
- **Commerce-Integrated Discussions**: Comments directly linked to purchasable items, addressing the 68% revenue loss from content-commerce disconnect
- **Creator-Community Building**: Facilitates authentic connections between creators and enthusiasts, building the trust that 82% of craft buyers demand
- **Technical Depth**: Supports the detailed conversations about processes and techniques that drive 40% higher conversion rates

**User Research Insights:**
- **78%** of craft creators want to engage in technical discussions about their processes
- **85%** believe detailed comments increase buyer trust and conversion rates
- **92%** want to answer questions about materials, techniques, and customization
- **65%** of buyers want to ask detailed questions about craft techniques and materials
- **70%** read comments before making purchasing decisions
- **80%** value creator responses to questions

**Business Impact:**
- **Direct Impact**: Comments increase conversion rates by 40% through buyer confidence
- **AOV Increase**: Detailed discussions about customization increase AOV by 25%
- **Creator Engagement**: Active creators with comment engagement see 3x higher revenue
- **Community Building**: Comment-driven communities show 60% higher user retention

## 3. Requirements
**Validated by PO - Complete requirements for craft-focused comment system**

### Core Comment Features
- Users can create top-level comments on any craft content item (videos, tutorials, product listings)
- Comments support threaded replies up to 3 levels deep for technical craft discussions
- Rich text formatting includes bold, italic, links, and code blocks for patterns and technical specifications
- Users can attach images and videos to their comments for process documentation and technique sharing
- Comments display with author avatar, creator verification badge, and timestamp
- Comments can be edited within 5 minutes of posting for technical accuracy
- Comments can be deleted by the author or content owner with moderation controls
- Comment count is displayed on content items with engagement metrics
- Comments are sorted by most recent by default with craft-relevant sorting options (most helpful, technical depth)
- Comments load with pagination (20 comments per page) and real-time updates for active discussions

### Craft-Specific Requirements
- **Technical Discussion Support**: Code blocks for patterns, material specifications, technique details
- **Process Documentation**: Creators can document their creative process step-by-step
- **Material Sourcing**: Discussions about where to find specific craft materials
- **Skill Sharing**: Community knowledge sharing about techniques and best practices

### Technical Requirements
- Use Flutter's built-in HTML parsing for rich text
- Implement content sanitization to prevent XSS
- Follow existing file naming conventions
- Maintain 3-level nesting limit for performance
- Use WebSocket for real-time comment updates
- Implement content sanitization to prevent XSS attacks
- Support multiple media types (images, videos) in comments
- Ensure GDPR compliance for user-generated content

### Integration Requirements
- **User Authentication**: Comments require user authentication and profile management
- **Commerce Integration**: Comments on products must verify purchase history and aggregate reviews
- **Content System**: Comments must be properly associated with content items
- **Notification System**: New comments should trigger notifications to content owners
- **Real-time Updates**: Comment system must integrate with WebSocket infrastructure
- **Media Management**: Comment attachments must use existing content upload systems

## 4. Acceptance Criteria
**Verified by QA - Testable acceptance criteria**

1. Users can create top-level comments on any craft content item (videos, tutorials, product listings)
2. Comments support threaded replies up to 3 levels deep for technical craft discussions
3. Rich text formatting includes bold, italic, links, and code blocks for patterns and technical specifications
4. Users can attach images and videos to their comments for process documentation and technique sharing
5. Comments display with author avatar, creator verification badge, and timestamp
6. Comments can be edited within 5 minutes of posting for technical accuracy
7. Comments can be deleted by the author or content owner with moderation controls
8. Comment count is displayed on content items with engagement metrics
9. Comments are sorted by most recent by default with craft-relevant sorting options (most helpful, technical depth)
10. Comments load with pagination (20 comments per page) and real-time updates for active discussions

## 5. Process & Rules
**Enforced by SM - Workflow and business rules**

### Comment Management Rules
- **User Authentication**: All comment actions require authenticated user sessions
- **Content Association**: Comments must be properly linked to specific content items
- **Moderation**: Content owners can delete comments on their content
- **Editing Time Limit**: Comments can only be edited within 5 minutes of posting
- **Thread Depth**: Limited to 3 levels of nesting for performance and readability
- **Media Attachments**: All media must be validated and appropriate for craft content

### Security Requirements
- **Content Sanitization**: All rich text must be sanitized to prevent XSS attacks
- **Rate Limiting**: Implement rate limiting to prevent comment spam
- **User Permissions**: Respect user privacy settings and content visibility rules
- **Data Protection**: All comment data must be handled according to GDPR requirements
- **Access Controls**: Proper authorization for comment editing and deletion

### Content Rules
- **Craft Relevance**: Comments should be relevant to craft content and techniques
- **Constructive Engagement**: Encourage helpful, technical discussions about craft processes
- **Commercial Integration**: Allow appropriate commerce-related discussions and questions
- **Creator Verification**: Display verification badges for authenticated creators
- **Material References**: Support specific material and tool discussions

### Integration Rules
- **Real-time Updates**: All comment actions must trigger real-time notifications
- **Commerce Links**: Comments on products must verify purchase history when required
- **User Profiles**: Comments must link to user profiles with proper privacy controls
- **Content Moderation**: Integration with moderation systems for inappropriate content
- **Analytics**: Comment activity must be tracked for engagement metrics

## 6. Tasks / Breakdown
**Implementation tracking and development steps**

### Data Model & Schema (AC: 1, 8)
- [ ] Create Comment table with fields: id, content_id, user_id, parent_id, content, created_at, updated_at, is_deleted
- [ ] Create CommentMedia table for attachments: id, comment_id, media_type, media_url, file_name
- [ ] Set up proper indexes for efficient querying
- [ ] Implement soft deletion pattern to preserve conversation history

### API Endpoints (AC: 1, 3, 4)
- [ ] Create POST /api/comments for creating new comments
- [ ] Handle rich text content parsing and sanitization
- [ ] Process and store media attachments securely
- [ ] Validate user permissions for commenting
- [ ] Create PUT /api/comments/{id} for editing with 5-minute timeout
- [ ] Create DELETE /api/comments/{id} for soft deletion

### UI Components (AC: 2, 5)
- [ ] Create recursive comment component for nested replies
- [ ] Implement comment indentation for thread visualization
- [ ] Add reply button and form for each comment
- [ ] Display user avatars and names with profile links
- [ ] Add creator verification badge display
- [ ] Implement timestamp formatting

### Editing & Deletion (AC: 6, 7)
- [ ] Add edit/delete buttons with proper permission checks
- [ ] Implement 5-minute editing timeout
- [ ] Show edit history for edited comments
- [ ] Create moderation controls for content owners
- [ ] Add confirmation dialogs for deletion

### Counting & Pagination (AC: 8, 9, 10)
- [ ] Implement efficient comment counting per content item
- [ ] Add sorting options: newest, oldest, most liked, most helpful
- [ ] Create pagination component with infinite scroll option
- [ ] Cache comment counts for performance
- [ ] Implement real-time comment updates via WebSocket

### Real-time Features (AC: 10)
- [ ] Integrate with WebSocket infrastructure for live updates
- [ ] Add notification system for new comments and replies
- [ ] Implement real-time comment count updates
- [ ] Add active discussion indicators
- [ ] Create typing indicators for comment composition

## 7. Related Files
**Files with the same story number**

- Story file: `/Volumes/workspace/projects/flutter/video_window/docs/stories/5.1.md`

### Domain-Specific Implementations
**💬 User Interaction Implementation**
- **Focus**: Core comment system with threading and rich text
- **Key Features**: Threaded comments, media attachments, real-time updates

**🛒 Commerce Integration**
- **Files**: 1.2.product-catalog-management.md, 1.3.product-media-management.md, 1.4.inventory-stock-management.md
- **Focus**: Product reviews and customer feedback collection
- **Key Features**: Product-specific comments, purchase verification, review aggregation, commerce-driven commenting

**🔐 Authentication Integration**
- **Files**: 1.2.social-media-authentication-integration.md, 6.1.2-user-account-management.md
- **Focus**: User identification and permission management
- **Key Features**: User authentication, profile management, permission checks

## 8. Notes
**Additional information and consolidation logs**

### Cross-Domain Dependencies
- **User Interaction System**: Core comment functionality with threading and media
- **Commerce System**: Product review integration, purchase verification, and review aggregation
- **Authentication System**: User identification, profile management, and permission validation
- **Content System**: Content item identification and comment association
- **Notification System**: Real-time updates for new comments and replies

### File Locations
- **Backend**: lib/api/comments.dart, lib/models/comment.dart
- **Frontend**: lib/features/comments/widgets/, lib/features/comments/services/
- **Database**: migrations/create_comments_table.sql

### Testing Requirements
- **Test file location**: test/features/comments/
- **Test standards**: Write tests for each API endpoint and component
- **Testing frameworks**: Use Flutter test and mocktail for mocking
- **Specific testing requirements**: Test comment threading, media uploads, and permissions
- **Cross-Domain Testing**: Verify commerce integration for product reviews and purchase verification
- **Cross-Domain Testing**: Test authentication integration for user permissions and profiles
- **Cross-Domain Testing**: Validate notification system integration for comment alerts

### Technical Constraints
- Use Flutter's built-in HTML parsing for rich text
- Implement content sanitization to prevent XSS
- Follow existing file naming conventions
- Maintain 3-level nesting limit for performance
- Use WebSocket for real-time comment updates

### Success Metrics
- **Engagement**: 40% increase in conversion rates from comment-influenced purchases
- **Creator Success**: 3x higher revenue for creators with active comment engagement
- **Community Building**: 60% higher user retention in comment-active communities
- **Content Generation**: 70% of platform content generated through user comments

### Implementation Timeline
- **Phase 1**: Complete user interaction implementation (comment system core)
- **Phase 2**: Integrate with authentication system for user management
- **Phase 3**: Integration with commerce system for product reviews and purchase verification
- **Phase 4**: Integration with content system for item association
- **Phase 5**: Connect with notification system for real-time updates