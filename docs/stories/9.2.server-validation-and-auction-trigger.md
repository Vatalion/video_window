# Story 9.2: Server Validation & Auction Trigger

## Status
Ready for Dev

## Story
**As a** commerce platform operator,
**I want** the offers service to validate submissions and launch auctions atomically,
**so that** every qualifying offer enforces business policy and starts bidding without inconsistency

## Acceptance Criteria
1. **BUSINESS CRITICAL**: `offer_validation_endpoint` evaluates maker policies via OPA (`offer_rule_engine` bundle), applies maker/buyer eligibility, and returns deterministic rule codes within 400ms p95.
2. **BUSINESS CRITICAL**: `offer_submit_endpoint` enforces idempotency, executes `OfferSubmissionSaga` (validation → payment pre-authorization → risk check → persistence) in a single transaction, and emits `OfferSubmitted` audit events.
3. Auction trigger integration fires `auction_trigger_service.start()` on first accepted offer, publishes EventBridge event `offers.auction.started`, and records SNS notification payloads for makers.
4. Stripe, Sift, and Plaid integrations surface decision context in logs and Datadog metrics (`offers.risk_check.duration_ms`, `offers.submission.success_rate`) with redaction of PII, and recover gracefully on partner outages.
5. Contract, endpoint, and service tests cover positive/negative paths, including idempotent replay, rule denials, payment failures, and auction event verification.

## Prerequisites
1. Story 9.1 – Offer Submission Flow (client validation handshake)
2. Story 1.1 – Implement Email OTP Sign-In (session/token validation)
3. Story 2.1 – Maker Profile Setup & Role Assignment (maker policy data)
4. Story 6.1 – Media Pipeline Content Protection (auction artifact contracts)

## Tasks / Subtasks

### Phase 1 – Validation Pipeline & Policy Enforcement (BUS-001)

- [ ] **BUSINESS CRITICAL - BUS-001**: Implement `offer_validation_endpoint.dart` orchestrating policy checks (AC: 1) [Source: docs/tech-spec-epic-9.md – Implementation Guide §2]
  - [ ] Hydrate maker policy cache (Redis TTL 5m) including `autoRejectBelowAmount`, currency, and max offers
  - [ ] Execute OPA evaluation via `offer_rule_engine` sidecar with policy bundle `opa-offers-bundle@2025-10-15`
  - [ ] Enforce buyer eligibility: authentication, payment method presence, geographic allow-list
  - [ ] Return structured response with rule severities (`blocker`, `warning`) and normalization hints
- [ ] Expand `offer_validation_service.dart` to translate OPA decisions into domain failures (AC: 1) [Source: docs/tech-spec-epic-9.md – Implementation Guide §2]
  - [ ] Map ReGo decision payloads to `OfferValidationFailure` enums
  - [ ] Record Datadog metric `offers.validation.duration_ms`
  - [ ] Persist trace metadata for Sentry correlation

### Phase 2 – Offer Submission Saga & Auction Trigger (BUS-002)

- [ ] **BUSINESS CRITICAL - BUS-002**: Build `OfferSubmissionSaga` inside `offer_submission_service.dart` (AC: 2) [Source: docs/tech-spec-epic-9.md – Implementation Guide §2-3]
  - [ ] Require `idempotency_key` + `submission_trace_id`; persist to Redis guard set
  - [ ] Invoke `stripe_connect_client.verifyPaymentMethod()` and handle declines with compensating actions
  - [ ] Call `sift_risk_client.score()` and abort submissions above `RISK_SCORE_REJECTION_THRESHOLD`
  - [ ] Persist offer + audit entry inside transaction; ensure rollback on partner failure
- [ ] Integrate `auction_trigger_service.dart` to start auction on first accepted offer (AC: 3) [Source: docs/tech-spec-epic-9.md – Implementation Guide §2]
  - [ ] Detect "opening" offer and emit EventBridge event `offers.auction.started`
  - [ ] Publish SNS notification to makers with contextual payload
  - [ ] Update Redis cache tracking active auctions for soft-close coordination

### Phase 3 – Observability, Resilience, & QA

- [ ] Implement structured logging with `submission_trace_id`, partner decision payload hashes, and latency metrics (AC: 4) [Source: docs/tech-spec-epic-9.md – Monitoring & Analytics]
  - [ ] Configure Kibana index `offers-submission-*` for log ingestion
  - [ ] Mask PII while preserving decision context for compliance
  - [ ] Create Datadog monitors for validation and submission latency
- [ ] Expand testing suite (AC: 5) [Source: docs/tech-spec-epic-9.md – Test Traceability]
  - [ ] Add endpoint tests for validation + submission success/failure paths
  - [ ] Create saga unit tests simulating payment/risk partner outages
  - [ ] Implement contract tests (`offers_contract_test.dart`) ensuring response schema stability
  - [ ] Add load test profile `offers_locustfile.py` baseline (200 RPS) verifying idempotency

## Dev Notes
### Previous Story Insights
- Coordinate with Story 9.1 to ensure client validation codes align with server rule identifiers. [Source: docs/tech-spec-epic-9.md – Implementation Guide §1-2]
- Reference auction domain rules from `architecture/offers-auction-orders-model.md#auction-state-machine` while implementing trigger logic.

### Data Models
- `Offer` aggregates amount, currency, buyer, maker policy snapshot, status, and `submission_trace_id`. [Source: docs/tech-spec-epic-9.md – Data Models]
- `OfferAuditLog` records state transitions, user context, and device metadata. [Source: docs/tech-spec-epic-9.md – Data Models]
- `OfferPolicyCacheEntry` stores maker thresholds and rate limits with TTL for validation reuse. [Source: docs/tech-spec-epic-9.md – Implementation Guide §2]

### API Specifications
- `POST /offers/validation` accepts story ID + amount payload, returns normalized thresholds and rule outcomes. [Source: docs/tech-spec-epic-9.md – Implementation Guide §2]
- `POST /offers/submit` requires idempotency headers, returns offer entity with status and auction trigger indicator. [Source: docs/tech-spec-epic-9.md – Implementation Guide §2-3]
- EventBridge topic `offers-submission` publishes `offers.auction.started` events for downstream auction services. [Source: docs/tech-spec-epic-9.md – Monitoring & Analytics]

### Component Specifications
- Serverpod endpoints located at `video_window_server/lib/src/endpoints/offers/`. [Source: docs/tech-spec-epic-9.md – Source Tree & File Directives]
- Business services in `video_window_server/lib/src/services/offers/` orchestrate saga steps. [Source: docs/tech-spec-epic-9.md – Source Tree & File Directives]
- External integrations under `video_window_server/lib/src/integrations/` wrap Stripe, Sift, Plaid APIs. [Source: docs/tech-spec-epic-9.md – Source Tree & File Directives]

### Testing Requirements
- Maintain ≥85% coverage across validation and submission services; run `melos run test:unit -- --tags offers` prior to merge. [Source: docs/tech-spec-epic-9.md – Test Traceability]
- Execute contract tests against sandbox Stripe, Sift, and Plaid environments nightly; failures page the commerce on-call. [Source: docs/tech-spec-epic-9.md – Monitoring & Analytics]
- Include load test artifacts with target 200 RPS, ensuring p95 latency < 2s and zero duplicate submissions. [Source: docs/tech-spec-epic-9.md – Monitoring & Analytics]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2025-10-29 | v1.0    | Definitive server validation + auction trigger scope derived from tech spec Implementation Guide §§2-3 | GitHub Copilot AI |

## Dev Agent Record
### Agent Model Used
_(To be completed by Dev Agent)_

### Debug Log References
_(To be completed by Dev Agent)_

### Completion Notes List
_(To be completed by Dev Agent)_

### File List
_(To be completed by Dev Agent)_

## QA Results
_(To be completed by QA Agent)_
