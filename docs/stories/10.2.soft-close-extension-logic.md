# Story 10.2: Soft-Close Extension Logic

## Status
Ready for Dev

## Story
**As a** bidder,
**I want** soft-close extensions to trigger whenever late bids arrive,
**so that** auctions stay fair and give everyone a chance to respond

## Acceptance Criteria
1. **BUSINESS CRITICAL**: `soft_close_service.dart` extends auctions by `SOFT_CLOSE_EXTENSION_MINUTES` when a bid arrives inside the final 15 minutes, capped by `SOFT_CLOSE_MAX_EXTENSION_MINUTES`, and records an immutable audit entry (Implementation Guide §2).
2. **REAL-TIME CRITICAL**: WebSocket payloads broadcast soft-close events within 1s of extension, and `soft_close_indicator.dart` reflects the new end time with animation + accessibility text (Implementation Guide §2).
3. **OPERATIONS CRITICAL**: Manual override endpoint (`auction_soft_close_endpoint.dart`) lets admins extend or lock auction end times with RBAC checks and audit trail, emitting EventBridge event `auctions.soft_close.overridden` (Implementation Guide §2).
4. **OBSERVABILITY CRITICAL**: Metrics `auctions.soft_close.trigger_count`, `auctions.soft_close.cap_hits`, and Segment event `auction_soft_close_extended` are emitted with cause metadata (Monitoring & Analytics §2).

## Prerequisites
1. Story 10.1 – Auction Timer & State Management (baseline timer + drift handling)
2. Story 9.2 – Server Validation & Auction Trigger (bid events + auction activation)
3. Maker policy configuration contains soft-close parameters (see docs/tech-spec-epic-9.md)

## Tasks / Subtasks

### Phase 1 – Server-Side Extension Rules
- [ ] Implement extension eligibility in `soft_close_service.dart` (AC: 1) [Source: docs/tech-spec-epic-10.md – Implementation Guide §2]
  - [ ] Detect bids where `bid.timestamp >= auction.endsAt - 15min`
  - [ ] Extend `endsAt` by configured increment with cap check
  - [ ] Persist extension metadata in Redis sorted set `auction:softclose:{id}`
  - [ ] Write audit log entry `auction_soft_close_extended`
- [ ] Update `auction_timer_scheduler.dart` to consume extension metadata (AC: 1)
  - [ ] Reschedule next tick based on new end time
  - [ ] Prevent duplicate extension for same bid via idempotency key

### Phase 2 – Client UX & Notifications
- [ ] Build `auction_soft_close_bloc.dart` and `soft_close_indicator.dart` (AC: 2) [Source: Source Tree & Implementation Guide §2]
  - [ ] Subscribe to WebSocket `SoftCloseExtended` events
  - [ ] Animate countdown badge change and update accessible label
  - [ ] Show toast/alert summarizing new end time with timezone support
- [ ] Update `auction_timer_page.dart` to surface extension history (AC: 2)
  - [ ] Display list of extension timestamps + triggering bids
  - [ ] Provide CTA for maker/admin to view override screen

### Phase 3 – Overrides, Observability, QA
- [ ] Create `auction_soft_close_endpoint.dart` (AC: 3) [Source: Implementation Guide §2]
  - [ ] Enforce RBAC (makers, commerce admins)
  - [ ] Support manual extend and lock operations
  - [ ] Emit EventBridge event and audit log entry
- [ ] Instrument analytics + monitoring (AC: 4) [Source: Monitoring & Analytics]
  - [ ] Track Segment events for auto + manual extensions
  - [ ] Update Datadog dashboards per `docs/analytics/auction-timer-dashboard.md`
  - [ ] Alert Slack `#eng-offers` when cap reached more than 3 times/day
- [ ] Expand tests: `soft_close_service_test.dart`, `auction_soft_close_endpoint_test.dart`, bloc/widget coverage (AC: 1-4) [Source: Test Traceability]

## Dev Notes
- Reuse OPA policy evaluation from Story 9.2 to respect maker thresholds when determining eligibility.
- Coordinate with Story 10.3 to ensure state transitions handle soft-close updates before auction end.

## Data Models
- Redis soft-close sorted set entries include bid ID, timestamp, and extension duration. [Source: docs/tech-spec-epic-10.md – Implementation Guide §2]
- `auction_audit_log` gains `soft_close_reason` field for manual overrides. [Source: docs/tech-spec-epic-10.md – Implementation Guide §2]

## API Specifications
- `POST /auctions/{id}/soft-close/override` accepts `{action: extend|lock, minutes?: int}` and returns updated end time + audit reference. [Source: docs/tech-spec-epic-10.md – Implementation Guide §2]
- WebSocket events `SoftCloseExtended` and `SoftCloseOverridden` broadcast to participants. [Source: docs/tech-spec-epic-10.md – Implementation Guide §2]

## Component Specifications
- Server services: `soft_close_service.dart`, `auction_soft_close_endpoint.dart`. [Source: docs/tech-spec-epic-10.md – Source Tree]
- Client presentation: `soft_close_indicator.dart`, `auction_soft_close_bloc.dart`. [Source: docs/tech-spec-epic-10.md – Source Tree]
- Infrastructure: Terraform updates in `auctions_timer.tf` for alerts. [Source: docs/tech-spec-epic-10.md – Source Tree]

## Testing Requirements
- Maintain ≥80% coverage for soft-close service, endpoint, and client bloc widgets. [Source: docs/tech-spec-epic-10.md – Test Traceability]
- Include integration test verifying extension cap enforcement and manual override path. [Source: docs/tech-spec-epic-10.md – Implementation Guide §2]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2025-10-29 | v1.0    | Definitive soft-close scope aligned to Implementation Guide §2 | GitHub Copilot AI |

## Dev Agent Record
### Agent Model Used
_(To be completed by Dev Agent)_

### Debug Log References
_(To be completed by Dev Agent)_

### Completion Notes List
_(To be completed by Dev Agent)_

### File List
_(To be completed by Dev Agent)_

## QA Results
_(To be completed by QA Agent)_
