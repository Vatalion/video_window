# Story 11.4: Maker-Specific Alerts & SLA Notifications

## Status
Ready for Dev

## Story
**As a** maker,
**I want** to receive time-sensitive alerts for my listings, offers, auctions, and fulfillment obligations,
**so that** I can respond promptly and avoid SLA violations or missed opportunities

## Acceptance Criteria
1. Maker receives immediate push notification when first qualifying offer received on listing (≥ minimum price), triggering 72-hour auction countdown.
2. Maker receives push notification when new bid placed on active auction, including bid amount and current high bidder status.
3. **SLA CRITICAL**: Maker receives escalating alerts for shipping tracking requirement (24h, 48h, 72h warnings) before SLA violation.
4. Maker receives push notification when auction enters final 15 minutes (soft-close period) with option to accept current high bid immediately.
5. Maker receives push notification when payment received, triggering fulfillment workflow with 72-hour tracking requirement countdown.
6. **BUSINESS CRITICAL**: Maker can accept current high bid from notification action button, immediately ending auction and entering payment window.
7. Maker dashboard shows SLA status indicators for all active orders with color-coded urgency (green/yellow/red) and time remaining.

## Prerequisites
1. Story 11.1 – Push Notification Infrastructure (push delivery system)
2. Story 11.2 – In-App Activity Feed (notification center)
3. Story 9.2 – Server Validation & Auction Trigger (auction state management)
4. Story 10.3 – Auction State Transitions (auction lifecycle)
5. Story 13.2 – Tracking Integration System (shipping tracking)

## Tasks / Subtasks

### Phase 1 – Maker Notification Event System

- [ ] Define maker-specific notification events (AC: 1, 2, 3, 4, 5) [Source: docs/tech-spec-epic-11.md – Data Models]
  - [ ] Add NotificationType.offer_received_maker (first qualifying offer)
  - [ ] Add NotificationType.bid_placed_maker (new bid on maker's auction)
  - [ ] Add NotificationType.auction_soft_close (final 15 minutes)
  - [ ] Add NotificationType.payment_received_maker (payment success)
  - [ ] Add NotificationType.shipping_sla_warning (24h/48h/72h warnings)
  - [ ] Add NotificationType.shipping_sla_violated (tracking not added)
- [ ] Implement notification trigger points in auction service (AC: 1, 2, 4) [Source: docs/tech-spec-epic-11.md – Implementation Guide]
  - [ ] Trigger offer_received_maker when first qualifying offer validated
  - [ ] Trigger bid_placed_maker when new bid placed (except maker's own bids)
  - [ ] Trigger auction_soft_close when auction enters final 15 minutes
  - [ ] Include auction data (current high bid, bidder count, time remaining)
- [ ] Implement SLA tracking and warning system (AC: 3) [Source: docs/tech-spec-epic-11.md – Implementation Guide]
  - [ ] Create SLA monitor background job in Serverpod
  - [ ] Calculate time remaining until 72h shipping tracking deadline
  - [ ] Trigger shipping_sla_warning at 48h (24h remaining)
  - [ ] Trigger shipping_sla_warning at 60h (12h remaining)
  - [ ] Trigger shipping_sla_warning at 69h (3h remaining)
  - [ ] Trigger shipping_sla_violated at 72h if tracking still missing
- [ ] Implement payment success notification (AC: 5) [Source: docs/tech-spec-epic-11.md – Implementation Guide]
  - [ ] Listen to Stripe webhook checkout.session.completed
  - [ ] Trigger payment_received_maker notification to maker
  - [ ] Include order details (buyer, amount, item) in notification
  - [ ] Start 72h tracking requirement countdown
  - [ ] Update maker dashboard with new fulfillment task

### Phase 2 – Interactive Notification Actions

- [ ] **BUSINESS CRITICAL**: Implement accept bid action from notification (AC: 6) [Source: docs/tech-spec-epic-11.md – Implementation Guide]
  - [ ] Add "Accept Bid" action button to auction_soft_close notification
  - [ ] Implement notification action handler in FCM background handler
  - [ ] Call auction service endpoint POST /auctions/{id}/accept
  - [ ] Validate maker authority and auction state before accepting
  - [ ] End auction immediately and transition to payment window
  - [ ] Send notification to winning bidder about acceptance
  - [ ] Show confirmation to maker after successful acceptance
- [ ] Build notification action routing system (AC: 6) [Source: docs/tech-spec-epic-11.md – Implementation Guide]
  - [ ] Create NotificationActionHandler service
  - [ ] Map action IDs to handler functions
  - [ ] Handle authentication requirement for protected actions
  - [ ] Show in-app confirmation before executing destructive actions
  - [ ] Handle action failures gracefully with error messages
  - [ ] Log all notification actions for audit trail
- [ ] Add deep link actions to notification payloads (AC: 6) [Source: docs/tech-spec-epic-11.md – Implementation Guide]
  - [ ] Include actionUrl in notification data for direct navigation
  - [ ] Support /auctions/{id}, /orders/{id}, /shipping/{id} deep links
  - [ ] Open relevant maker management screen from notification tap
  - [ ] Pre-populate forms with notification context data
  - [ ] Highlight specific action required (e.g., add tracking button)

### Phase 3 – Maker Dashboard SLA Indicators

- [ ] Build SLA status dashboard widgets (AC: 7) [Source: docs/tech-spec-epic-11.md – Implementation Guide]
  - [ ] Create `SlaStatusCard` widget for active orders
  - [ ] Display order ID, buyer, item name, and SLA countdown
  - [ ] Show color-coded urgency indicator (green: >24h, yellow: 12-24h, red: <12h)
  - [ ] Display specific time remaining (e.g., "18 hours remaining")
  - [ ] Show "Tracking added ✓" status when requirement met
  - [ ] Add direct "Add Tracking" CTA button in card
- [ ] Implement real-time SLA countdown updates (AC: 7) [Source: docs/tech-spec-epic-11.md – Implementation Guide]
  - [ ] Create SLA timer widget that updates every minute
  - [ ] Recalculate urgency level based on time remaining
  - [ ] Transition color states smoothly (green → yellow → red)
  - [ ] Show notification icon when SLA warnings received
  - [ ] Persist SLA status across app restarts
- [ ] Add maker dashboard filtering and sorting (AC: 7) [Source: docs/tech-spec-epic-11.md – Implementation Guide]
  - [ ] Filter orders by status (pending_tracking, in_transit, delivered)
  - [ ] Sort by SLA urgency (red → yellow → green)
  - [ ] Sort by time remaining (soonest deadline first)
  - [ ] Show count of orders needing attention in tab badge
  - [ ] Highlight overdue SLA violations prominently

### Phase 4 – Notification Copy & Timing Optimization

- [ ] Craft maker-specific notification copy (AC: 1, 2, 3, 4, 5) [Source: docs/tech-spec-epic-11.md – Implementation Guide]
  - [ ] offer_received_maker: "🎉 First offer on [Item]! Auction starts now - 72 hours to go"
  - [ ] bid_placed_maker: "New bid: $[amount] on [Item] • [X] bidders • [time] remaining"
  - [ ] auction_soft_close: "⏰ Last 15 min! Accept $[amount] now or let bidding continue"
  - [ ] payment_received_maker: "💰 Payment received for [Item]! Add tracking within 72h"
  - [ ] shipping_sla_warning: "⚠️ [X] hours to add tracking for [Item] • Tap to add now"
  - [ ] shipping_sla_violated: "🚨 Tracking deadline missed for [Item] • Contact support"
- [ ] Optimize notification timing and frequency (AC: 3) [Source: docs/tech-spec-epic-11.md – Implementation Guide]
  - [ ] Batch multiple bids into single notification if within 5 minutes
  - [ ] Don't send bid notifications during maker's quiet hours (unless critical)
  - [ ] Escalate SLA warnings: normal → high → critical priority
  - [ ] Send soft-close notification only once (not on each extension)
  - [ ] Rate limit to prevent notification spam

### Phase 5 – Analytics & Monitoring

- [ ] Implement maker notification analytics (AC: 1, 2, 3, 4, 5, 6) [Source: docs/tech-spec-epic-11.md – Analytics Requirements]
  - [ ] Track notification delivery success/failure rates by type
  - [ ] Track notification open rates and action completion rates
  - [ ] Track time-to-response for SLA warnings (warning sent → tracking added)
  - [ ] Track acceptance rate from soft-close notifications
  - [ ] Monitor SLA violation frequency and patterns
  - [ ] Generate weekly maker engagement reports
- [ ] Build SLA monitoring dashboard (AC: 3, 7) [Source: docs/tech-spec-epic-11.md – Monitoring Requirements]
  - [ ] Create admin view of SLA compliance across all makers
  - [ ] Show percentage of orders meeting 72h tracking requirement
  - [ ] Display average time-to-tracking by maker
  - [ ] Alert admin team for repeated SLA violations by maker
  - [ ] Provide maker education when SLA issues detected

### Phase 6 – Testing

- [ ] Unit tests for maker notification triggers (AC: 1, 2, 3, 4, 5) [Source: docs/testing/master-test-strategy.md]
  - [ ] Test offer_received_maker triggered on first qualifying offer
  - [ ] Test bid_placed_maker triggered on new bids
  - [ ] Test SLA warning schedule (48h, 60h, 69h, 72h)
  - [ ] Test auction_soft_close triggered in final 15 minutes
  - [ ] Test payment_received_maker on successful payment
  - [ ] Verify notification not sent if maker preferences disabled
- [ ] Integration tests for notification actions (AC: 6) [Source: docs/testing/master-test-strategy.md]
  - [ ] Test accept bid action from notification
  - [ ] Test deep link navigation to auction/order/shipping screens
  - [ ] Test action authentication and authorization
  - [ ] Test action error handling
  - [ ] Verify audit trail for all notification actions
- [ ] E2E tests for SLA workflow (AC: 3, 7) [Source: docs/testing/master-test-strategy.md]
  - [ ] Test complete SLA warning escalation flow
  - [ ] Test maker responds to warning and adds tracking
  - [ ] Test SLA violation when tracking not added within 72h
  - [ ] Test dashboard SLA indicators update in real-time
  - [ ] Verify SLA status persists across app restarts

## Dev Notes
- Consider adding "Snooze" action for non-critical notifications
- Implement rate limiting to prevent notification spam during busy auctions
- Add maker notification history view to review past alerts
- Consider SMS fallback for critical SLA warnings
- Test notification delivery reliability on both iOS and Android
- Implement retry logic for failed action executions
- Add maker education in-app about SLA requirements
- Monitor for notification fatigue and adjust thresholds if needed

## Change Log
| Date | Author | Changes |
|------|--------|---------|
| 2025-10-30 | Mary (Analyst) | Initial story creation from tech spec |
