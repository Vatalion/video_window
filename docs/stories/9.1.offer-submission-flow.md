# Story 9.1: Offer Submission Flow

## Status
Ready for Dev

## Story
**As a** buyer,
**I want** to submit an offer with immediate validation feedback and transparent confirmation,
**so that** I know my offer meets maker policies before it is processed

## Acceptance Criteria
1. **BUSINESS CRITICAL**: Offer submission page renders maker policy data (minimum amount, currency, max attempts) and blocks submission until client- and server-side validation succeed, presenting inline error states mapped to rule codes.
2. **BUSINESS CRITICAL**: Real-time validation requests fire on amount/note changes, debounce at 350ms, surface rule outcomes in `offer_validation_banner.dart`, and persist the latest valid payload for submission (per docs/tech-spec-epic-9.md – Implementation Guide §1).
3. Offer confirmation workflow presents `offer_summary_sheet.dart` with terms, fees, and consent checkbox; successful submission shows confirmation state tied to `OfferSubmissionSuccess` event and automatically refreshes story context.
4. Client applies rate limiting via `rate_limit_guard.dart`, generates `submission_trace_id`, and records Segment events `offer_draft_started`, `offer_validation_failed`, and `offer_submitted` with normalized payloads.
5. Error handling routes server validation failures, risk denials, and network errors to localized banners/snackbars, allowing retry without retyping and logging to Sentry with trace context.

## Prerequisites
1. Story 01.1 – Bootstrap Repository and Flutter App
2. Story 1.1 – Implement Email OTP Sign-In (authenticated sessions + secure storage)
3. Story 2.1 – Maker Profile Setup & Role Assignment (maker policy + thresholds)
4. Story 4.1 / 5.1 – Feed & Story detail delivery (entry points to offer CTA)
5. Stripe account + payment method vaulting established via Story 12.1 dependency contracts

## Tasks / Subtasks

### Phase 1 – Offer Entry Experience Hardening (BUS-001 Mitigation)

- [ ] **BUSINESS CRITICAL - BUS-001**: Implement policy-aware form initialization pulling maker thresholds and prior buyer attempts (AC: 1) [Source: docs/tech-spec-epic-9.md – Source Tree & Implementation Guide §1]
  - [ ] Extend `offers_repository.dart` to hydrate minimums + max attempts via `offer_validation_endpoint`
  - [ ] Populate `OfferDraft` model and present guard rails (min amount, currency) in UI header
  - [ ] Disable submission CTA until validation passes and consent checkbox ticked
  - [ ] Persist `OfferDraft` locally for recovery if page dismissed
- [ ] **BUSINESS CRITICAL - BUS-001**: Add real-time validation pipeline with debounced requests (AC: 2) [Source: docs/tech-spec-epic-9.md – Implementation Guide §1]
  - [ ] Implement `OfferValidationRequested` event with 350ms debounce in `offer_bloc.dart`
  - [ ] Call `offers_validation_service.dart` to normalize currency via `Money` value objects
  - [ ] Update `offer_validation_banner.dart` to categorize rule severities (blocker vs warning)
  - [ ] Cache last successful validation payload for optimistic submission
- [ ] Wire `submit_offer_use_case.dart` with rate limiting + idempotency (AC: 2, 4, 5) [Source: docs/tech-spec-epic-9.md – Implementation Guide §1]
  - [ ] Utilize `rate_limit_guard.dart` to enforce client quotas before network call
  - [ ] Generate `submission_trace_id` and attach to headers for observability
  - [ ] Handle server responses mapping OPA codes → localized strings
  - [ ] Implement retry/backoff using `retry` 3.1.2 with capped attempts

### Phase 2 – Confirmation, Analytics, and Error Workflows

- [ ] Build `offer_summary_sheet.dart` with fee breakdown, maker policy copy, and consent capture (AC: 3) [Source: docs/tech-spec-epic-9.md – Implementation Guide §1]
  - [ ] Surface taxes/fees via `MoneyFormatter` and ensure localized currency strings
  - [ ] Gate final confirmation on consent toggle and valid validation token
  - [ ] Trigger maker notification dispatch via repository handshake after success acknowledgement
  - [ ] Provide post-submit CTA to view offer history (Story 9.4 dependency placeholder)
- [ ] Emit analytics + observability signals (AC: 4) [Source: docs/tech-spec-epic-9.md – Monitoring & Analytics]
  - [ ] Fire Segment events (`offer_draft_started`, `offer_validation_failed`, `offer_submitted`) with `submission_trace_id`
  - [ ] Record Datadog custom metric `offers.client.validation_latency_ms`
  - [ ] Capture Sentry breadcrumbs for validation outcomes + submission result
  - [ ] Update analytics documentation entry `docs/analytics/offers-dashboard.md`
- [ ] Harden UX recovery paths (AC: 5) [Source: docs/tech-spec-epic-9.md – Implementation Guide §1]
  - [ ] Implement offline banner + retry queue for validation
  - [ ] Provide inline actions for risk declines (trigger support contact)
  - [ ] Ensure form state persists across navigation/back stack events
  - [ ] Localize all error strings and map to translation keys

## Dev Notes
### Previous Story Insights
- This is the first story in Epic 9. Borrow the session management and secure storage patterns from Epic 1 while aligning with Implementation Guide §1 of docs/tech-spec-epic-9.md.

### Data Models
- `OfferDraft` aggregates buyer amount, currency, note, and maker policy metadata pulled from the validation endpoint. [Source: docs/tech-spec-epic-9.md – Data Models]
- The `Offer` entity persists submission outcomes with status, audit context, and `submission_trace_id`. [Source: docs/tech-spec-epic-9.md – Data Models]
- Maker policy payload includes `autoRejectBelowAmount`, `maxOffersPerStory`, and currency definitions used to initialize the client form. [Source: docs/tech-spec-epic-9.md – Data Models]

### API Specifications
- `POST /offers/submit` requires `idempotency_key` and `submission_trace_id` headers, returning confirmation payloads or validation error structures with rule codes. [Source: docs/tech-spec-epic-9.md – Implementation Guide §1]
- `POST /offers/validation` performs rule evaluation and returns normalized thresholds plus warning/error arrays. [Source: docs/tech-spec-epic-9.md – Implementation Guide §1]
- Cancellation and history endpoints are implemented in Stories 9.3 and 9.4; reference those stories for follow-on scopes.

### Component Specifications
- Feature package `video_window_flutter/packages/features/commerce/` hosts the presentation layer (pages, widgets, BLoCs) and client use cases. [Source: docs/tech-spec-epic-9.md – Source Tree & File Directives]
- Core module repositories/services reside in `video_window_flutter/packages/core/` and should expose validation + submission APIs used here. [Source: docs/tech-spec-epic-9.md – Source Tree & File Directives]
- Server endpoints for validation/submission live in Story 9.2 scope; this story focuses on client integration, rate limiting, and analytics instrumentation.

### File Locations
- Presentation & state management: `video_window_flutter/packages/features/commerce/lib/presentation/offers/` with matching tests under `.../test/presentation/offers/`. [Source: architecture/front-end-architecture.md#feature-package-structure]
- Offer use cases: `video_window_flutter/packages/features/commerce/lib/use_cases/offers/` delegating to repositories in `video_window_flutter/packages/core/lib/data/repositories/offers/`.
- Server-side logic: `video_window_server/lib/src/endpoints/offers/` with supporting business services in `lib/src/business/offers/` and tests in `video_window_server/test/endpoints/offers/`.
- Analytics schemas live in `video_window_flutter/packages/shared/lib/domain/analytics/` shared across features.

### Testing Requirements
- Maintain ≥80% coverage for `offer_bloc.dart`, `offer_submission_page.dart`, and `offer_validation_banner.dart` with widget + bloc tests. [Source: docs/tech-spec-epic-9.md – Test Traceability]
- Validate client rate limiting, analytics emission, and retry flows with unit tests harnessed via `fake_async`. [Source: docs/tech-spec-epic-9.md – Monitoring & Analytics]
- Ensure integration tests exercise validation + submission handshake against mocked Serverpod client responses. [Source: docs/tech-spec-epic-9.md – Test Traceability]

### Technical Constraints
- Offer submission requires comprehensive qualification validation including authentication, payment method verification, and story eligibility checks. [Source: architecture/offers-auction-orders-model.md#state-machines]
- **BUSINESS CRITICAL**: All offer validations must be performed server-side with client-side validation for UX only. [Source: architecture/offers-auction-orders-model.md#audit-idempotency]
- **BUSINESS CRITICAL**: Minimum offer thresholds must be enforced in real-time with proper currency conversion support. [Source: architecture/offers-auction-orders-model.md#derived-fields-constraints]
- **BUSINESS CRITICAL**: Offer state transitions must be atomic with comprehensive audit trails and idempotent operations. [Source: architecture/offers-auction-orders-model.md#audit-idempotency]
- **BUSINESS CRITICAL**: Auction integration must use event-driven architecture with proper state machine implementation. [Source: architecture/offers-auction-orders-model.md#auction-state-machine]
- Error handling must surface friendly messages and retry actions via shared `ErrorView` components. [Source: architecture/front-end-architecture.md#error-handling]
- All business rules must implement comprehensive logging and monitoring for compliance and analytics. [Source: architecture/offers-auction-orders-model.md#audit-idempotency]

### Project Structure Notes
- Planned changes align with the melos-managed structure; ensure feature packages remain presentation/use-case only and delegate core data logic to `packages/core/`. [Source: architecture/front-end-architecture.md#feature-package-structure]

### Scope Notes
- Consider launching with a narrower slice (Offer Submission + Validation) followed by separate stories for Cancellation/Modification UX and Analytics to keep iteration cadence manageable.

## Testing
- Follow the project testing pipeline by running `dart format`, `flutter analyze`, and `flutter test --no-pub` before submission. [Source: architecture/front-end-architecture.md#testing-strategy-client]
- Add BLoC and widget tests for offer flows with fixtures covering success, validation failures, and error scenarios. [Source: architecture/front-end-architecture.md#testing-strategy-client]
- Include integration tests for offer submission with auction system integration and event emission validation. [Source: architecture/offers-auction-orders-model.md#audit-idempotency]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2025-10-09 | v0.1    | Initial draft created | Claude (Dev Agent) |
| 2025-10-29 | v1.0    | Scoped to client offer entry UX, aligned with definitive spec Implementation Guide §1 | GitHub Copilot AI |

## Dev Agent Record
### Agent Model Used
_(To be completed by Dev Agent)_

### Debug Log References
_(To be completed by Dev Agent)_

### Completion Notes List
_(To be completed by Dev Agent)_

### File List
_(To be completed by Dev Agent)_

## QA Results
_(To be completed by QA Agent)_