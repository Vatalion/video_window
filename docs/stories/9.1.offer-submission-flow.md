# Story 9.1: Offer Submission Flow

## Status
Ready for Dev

## Story
**As a** buyer,
**I want** to submit offers on stories with validation against minimums and clear confirmation,
**so that** I can participate in auctions with confidence and transparency

## Acceptance Criteria
1. Offer submission UI with real-time validation against maker-set minimum thresholds, comprehensive business rule enforcement, and multi-layered error handling with user-friendly feedback.
2. Offer confirmation flow with clear terms, fees disclosure, and maker notification system integration for immediate alerts on new offers.
3. Offer cancellation and modification interface with business rule enforcement (cancellation windows, modification restrictions) and history tracking for audit purposes.
4. **BUSINESS CRITICAL**: Implement comprehensive offer qualification checks including user authentication, payment method verification, story eligibility validation, and geographic restrictions.
5. **BUSINESS CRITICAL**: Implement minimum offer validation with real-time threshold checking, currency conversion support, and maker policy enforcement.
6. **BUSINESS CRITICAL**: Implement offer state management with proper status transitions, audit trail generation, and integration with auction system (Epic 10).
7. **BUSINESS CRITICAL**: Implement comprehensive analytics tracking for offer events with proper event schema validation and funnel analysis support.

## Tasks / Subtasks

### Phase 1 Critical Business Controls (BUS-001 & BUS-002 Mitigation)

- [ ] **BUSINESS CRITICAL - BUS-001**: Implement comprehensive offer qualification validation service (AC: 4) [Source: architecture/offers-auction-orders-model.md#state-machines]
  - [ ] User authentication and authorization checks (must be authenticated, not blocked)
  - [ ] Payment method verification (valid payment method on file)
  - [ ] Story eligibility validation (story status must be Listed, not Sold/Archived)
  - [ ] Geographic restriction enforcement (buyer location eligible for story)
  - [ ] Maker policy validation (maker accepts offers, not blocked)
- [ ] **BUSINESS CRITICAL - BUS-001**: Implement minimum offer validation with real-time threshold checking (AC: 1, 5) [Source: architecture/offers-auction-orders-model.md#derived-fields-constraints]
  - [ ] Fetch and cache maker minimum offer thresholds
  - [ ] Real-time validation against minimum thresholds with instant feedback
  - [ ] Currency conversion support for international offers
  - [ ] Increment validation (must be ≥ minimum threshold)
  - [ ] Format validation (numeric, within reasonable bounds)
- [ ] **BUSINESS CRITICAL - BUS-001**: Implement comprehensive business rule enforcement engine (AC: 1, 4, 5) [Source: architecture/offers-auction-orders-model.md#state-machines]
  - [ ] Offer limit validation (max offers per story per user)
  - [ ] Time-based restrictions (no offers during story processing)
  - [ ] Balance validation (sufficient funds/credit available)
  - [ ] Duplicate offer prevention (identical offers within time window)
  - [ ] Rate limiting (offer submission frequency limits)
- [ ] **BUSINESS CRITICAL - BUS-002**: Implement offer state machine with proper transitions and audit trail (AC: 6) [Source: architecture/offers-auction-orders-model.md#offers-auction-story-centric]
  - [ ] Status transitions: Pending → AutoRejected → Rejected → Accepted → Superseded
  - [ ] Automatic status updates based on business rules
  - [ ] Comprehensive audit trail for all state changes
  - [ ] Idempotent offer submission with duplicate detection
  - [ ] Atomic state updates with rollback capability
- [ ] **BUSINESS CRITICAL - BUS-002**: Implement auction system integration with event-driven architecture (AC: 6) [Source: architecture/offers-auction-orders-model.md#auction-state-machine]
  - [ ] Auction creation on first valid offer (Listed → Open transition)
  - [ ] Event emission for auction state changes
  - [ ] Real-time updates to connected clients
  - [ ] Auction timer initialization and management
  - [ ] Soft-close policy enforcement and timer extensions

### Standard Implementation Tasks

- [ ] Implement offer submission UI with real-time validation and multi-layered error handling using shared design tokens (AC: 1) [Source: architecture/front-end-architecture.md#feature-package-structure] [Source: architecture/front-end-architecture.md#state-management-architecture]
  - [ ] Add offer amount input with currency formatting and validation feedback
  - [ ] Implement offer note/attachment functionality with character limits
  - [ ] Add preview panel with offer summary and fee breakdown
  - [ ] Include progress indicators and loading states for submission
- [ ] Connect offer submission flow to offers_service with comprehensive error handling and state management (AC: 1, 2) [Source: architecture/story-component-mapping.md#epic-9--offer-submission-flow] [Source: architecture/offers-auction-orders-model.md#entities-core]
  - [ ] Implement offer submission API call with proper validation
  - [ ] Handle success responses with confirmation flow
  - [ ] Process error responses with user-friendly messaging
  - [ ] Implement retry mechanisms for transient failures
- [ ] Implement offer confirmation UI with comprehensive terms disclosure and maker notification integration (AC: 2) [Source: architecture/story-component-mapping.md#epic-9--offer-submission-flow]
  - [ ] Display offer details with fee breakdown and total amount
  - [ ] Show terms and conditions with acceptance checkbox
  - [ ] Integrate maker notification system for real-time alerts
  - [ ] Include estimated response time and next steps
- [ ] Implement offer cancellation and modification interface with business rule enforcement (AC: 3) [Source: architecture/offers-auction-orders-model.md#state-machines]
  - [ ] Cancellation interface with reason selection and confirmation
  - [ ] Modification interface for editable offers (within business rules)
  - [ ] History tracking with timestamp and change details
  - [ ] Dashboard synchronization for real-time updates
- [ ] Emit comprehensive analytics events for offer funnel tracking with proper schema validation (AC: 7) [Source: analytics/mvp-analytics-events.md#offers-auction] [Source: architecture/front-end-architecture.md#analytics-instrumentation]
  - [ ] Track offer_opened, offer_submitted, offer_auto_rejected events
  - [ ] Include all required parameters (story_id, amount, currency, threshold)
  - [ ] Implement funnel analytics for conversion tracking
  - [ ] Add error tracking for offer submission failures

### Business Logic Validation Requirements

- [ ] Cover all business rule scenarios with comprehensive validation testing (AC: 4, 5, 6) [Source: architecture/offers-auction-orders-model.md#state-machines]
  - [ ] Test offer qualification validation (authentication, payment, eligibility)
  - [ ] Test minimum threshold validation with various scenarios
  - [ ] Test business rule enforcement (limits, timing, duplicates)
  - [ ] Test state transitions and audit trail generation
  - [ ] Test auction integration and event emission
  - [ ] Test cancellation and modification business rules
  - [ ] Test error handling and recovery scenarios
  - [ ] Test concurrent offer submission scenarios

## Dev Notes
### Previous Story Insights
- This is the first story in Epic 9, so there are no prior implementation lessons to apply within this epic. However, authentication patterns from Epic 1 should be referenced for user qualification checks. [Source: architecture/story-component-mapping.md#epic-9--offer-submission-flow]

### Data Models
- The `Offer` entity stores offer details including storyId, buyerId, amount, currency, note, createdAt, and status with flags for opening offers and source tracking. [Source: architecture/offers-auction-orders-model.md#entities-core]
- The `MakerProfile` entity contains offerPolicy with autoRejectBelowAmount, currency, and enabled flags for validation. [Source: architecture/offers-auction-orders-model.md#entities-core]
- The `ArtifactStory` entity tracks status (Listed|Sold|Archived) for offer eligibility validation. [Source: architecture/offers-auction-orders-model.md#entities-core]
- Offers service modules rely on Postgres `offers`, `users`, `maker_profiles`, and `artifact_stories` tables for validation and persistence. [Source: architecture/story-component-mapping.md#serverpod-services-modules]

### API Specifications
- `POST /offers/submit` accepts offer details with storyId, amount, currency, and optional note; returns 201 on success with offer ID or 400/403/429 for validation failures. [Source: architecture/offers-auction-orders-model.md#state-machines]
- `GET /offers/validation/{storyId}` returns validation rules including minimum amount, currency, and eligibility status. [Source: architecture/offers-auction-orders-model.md#derived-fields-constraints]
- `PUT /offers/{offerId}/cancel` handles offer cancellation with business rule enforcement and audit trail updates. [Source: architecture/offers-auction-orders-model.md#state-machines]
- `POST /offers/{offerId}/modify` supports offer modification within business rules with validation against current auction state. [Source: architecture/offers-auction-orders-model.md#state-machines]

### Component Specifications
- Flutter `commerce` module owns offer submission, confirmation, and management UI; offers_service on Serverpod handles validation, persistence, and auction integration. [Source: architecture/story-component-mapping.md#epic-9--offer-submission-flow]
- BLoC-based state management with feature-scoped BLoCs for offer submission, validation, and management flows. [Source: architecture/front-end-architecture.md#state-management-architecture]
- Use shared analytics service injection to record offer events instead of duplicating event names. [Source: architecture/front-end-architecture.md#analytics-instrumentation]
- Integrate with notification_service for real-time maker alerts on new offers. [Source: architecture/story-component-mapping.md#serverpod-services-modules]

### File Locations
- UI and state code for this story belong under `video_window/lib/features/commerce/` following presentation, application, domain, and infrastructure layering. [Source: architecture/front-end-architecture.md#feature-package-structure]
- Backend service implementation belongs under `serverpod/modules/offers_service/` with proper module structure. [Source: architecture/story-component-mapping.md#serverpod-services-modules]
- Tests should mirror feature paths under `video_window/test/features/commerce/` and `serverpod/test/modules/offers_service/` to match the project structure. [Source: architecture/front-end-architecture.md#testing-strategy-client]

### Testing Requirements
- Maintain ≥80% coverage and include integration coverage for offer flows, running `flutter test --no-pub` in CI. [Source: architecture/front-end-architecture.md#testing-strategy-client]
- Offer BLoCs and widgets should use bloc_test package and widget tests for critical screens. [Source: architecture/front-end-architecture.md#testing-strategy-client]
- Business logic validation should include comprehensive unit tests for all validation rules and edge cases. [Source: architecture/offers-auction-orders-model.md#audit-idempotency]

### Technical Constraints
- Offer submission requires comprehensive qualification validation including authentication, payment method verification, and story eligibility checks. [Source: architecture/offers-auction-orders-model.md#state-machines]
- **BUSINESS CRITICAL**: All offer validations must be performed server-side with client-side validation for UX only. [Source: architecture/offers-auction-orders-model.md#audit-idempotency]
- **BUSINESS CRITICAL**: Minimum offer thresholds must be enforced in real-time with proper currency conversion support. [Source: architecture/offers-auction-orders-model.md#derived-fields-constraints]
- **BUSINESS CRITICAL**: Offer state transitions must be atomic with comprehensive audit trails and idempotent operations. [Source: architecture/offers-auction-orders-model.md#audit-idempotency]
- **BUSINESS CRITICAL**: Auction integration must use event-driven architecture with proper state machine implementation. [Source: architecture/offers-auction-orders-model.md#auction-state-machine]
- Error handling must surface friendly messages and retry actions via shared `ErrorView` components. [Source: architecture/front-end-architecture.md#error-handling]
- All business rules must implement comprehensive logging and monitoring for compliance and analytics. [Source: architecture/offers-auction-orders-model.md#audit-idempotency]

### Project Structure Notes
- Planned changes align with the documented monorepo structure; no deviations identified. [Source: architecture/front-end-architecture.md#feature-package-structure]

## Testing
- Follow the project testing pipeline by running `dart format`, `flutter analyze`, and `flutter test --no-pub` before submission. [Source: architecture/front-end-architecture.md#testing-strategy-client]
- Add BLoC and widget tests for offer flows with fixtures covering success, validation failures, and error scenarios. [Source: architecture/front-end-architecture.md#testing-strategy-client]
- Include integration tests for offer submission with auction system integration and event emission validation. [Source: architecture/offers-auction-orders-model.md#audit-idempotency]

## Change Log
| Date       | Version | Description        | Author             |
| ---------- | ------- | ------------------ | ------------------ |
| 2025-10-09 | v0.1    | Initial draft created | Claude (Dev Agent) |

## Dev Agent Record
### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
No debug logs generated during story creation

### Completion Notes List
- Created comprehensive Story 9.1 following exact format from Story 1.1
- Included all critical business controls and security requirements
- Referenced appropriate architecture documents and data models
- Aligned with analytics event naming conventions
- Included comprehensive testing requirements and technical constraints

### File List
- `/Volumes/workspace/projects/flutter/video_window/docs/stories/9.1.offer-submission-flow.md` (this file)

## QA Results
_(To be completed by QA Agent)_