# Story 2.3: Maker Identity Verification & KYC Processes

## Status
Ready for Dev

## Story
**As a** compliance officer,
**I want** automated maker identity verification integrated with Persona,
**so that** we admit legitimate makers while meeting KYC obligations.

## Acceptance Criteria
1. Makers can start a Persona verification session from the onboarding checklist, upload required documents, and monitor status updates in-app. [Source: docs/tech-spec-epic-2.md#maker-verification-endpoints]
2. Serverpod KYC service stores encrypted documents in S3 using KMS CMK `alias/video-window-maker-docs` and persists metadata + hashes in Postgres. [Source: docs/tech-spec-epic-2.md#database-migrations]
3. Persona webhook callbacks update verification status, capture reviewer notes, and notify makers via email + in-app toast. [Source: docs/tech-spec-epic-2.md#implementation-guide]
4. **SECURITY CRITICAL**: Verification tokens expire after 15 minutes; reuse attempts or mismatched signatures trigger security alerts and lock the submission for manual review. [Source: docs/tech-spec-epic-2.md#security-monitoring]
5. Compliance dashboard lists pending/approved/rejected makers with exportable audit trail (CSV) and filter controls. [Source: docs/tech-spec-epic-2.md#monitoring-and-analytics]

## Prerequisites
1. Story 2.1 – Maker Onboarding & Invitation Flow
2. Persona sandbox credentials configured in secrets store (`KYC_SERVICE_API_KEY`). [Source: docs/tech-spec-epic-2.md#technology-stack]

## Tasks / Subtasks

### Persona Session Orchestration
- [ ] Implement `persona_client.dart` handling session creation, status polling, and error translation. [Source: docs/tech-spec-epic-2.md#source-tree--file-directives]
- [ ] Build `maker_kyc_page.dart` wizard with document type selection, camera/file picker integration, and progress indicators (AC: 1).
- [ ] Store onboarding progress state and disable duplicate submissions until current session completes.

### Document Handling & Storage
- [ ] Extend `kyc_service.dart` to encrypt uploaded documents using AES-256 with KMS-managed keys; persist metadata in `verification_documents`. [Source: docs/tech-spec-epic-2.md#database-migrations]
- [ ] Enforce 50 MB file size limit and allowed MIME types (pdf, jpeg, png). [Source: docs/tech-spec-epic-2.md#technology-stack]
- [ ] Hash documents with SHA-256 and store verification in DB for tamper detection.

### Webhook Processing & Notifications
- [ ] Expose `/maker/verification/webhook/persona` endpoint validating Persona signature, updating maker profile status, and logging to audit stream (AC: 3,4). [Source: docs/tech-spec-epic-2.md#api-endpoints]
- [ ] Send SendGrid transactional emails for `under_review`, `verified`, `rejected` states and surface toast/notification in app.
- [ ] Lock verification attempt on repeated signature failures and alert security channel (AC: 4).

### Compliance Dashboard
- [ ] Create admin view listing verification queue with filters (status, date, reviewer). [Source: docs/tech-spec-epic-2.md#monitoring-and-analytics]
- [ ] Provide CSV export leveraging Serverpod streaming endpoint.
- [ ] Include quick action to request additional info, triggering email + checklist update.

## Data Models
- `verification_documents` and `maker_profiles` tables track status, metadata, and review notes for compliance. [Source: docs/tech-spec-epic-2.md#database-migrations]

## API Specifications
- `POST /maker/verification/documents/upload`, `POST /maker/verification/submit`, and Persona webhooks defined in spec govern flows. [Source: docs/tech-spec-epic-2.md#maker-verification-endpoints]

## Component Specifications
- Flutter UI components live under `video_window_flutter/packages/features/auth/lib/presentation/pages/` with supporting BLoC/use cases. [Source: docs/tech-spec-epic-2.md#source-tree--file-directives]
- Serverpod services manage Persona interactions and encryption. [Source: docs/tech-spec-epic-2.md#implementation-guide]

## Testing Requirements
- Unit tests: Persona client, KYC service encryption, webhook signature validation, compliance dashboard state management. [Source: docs/tech-spec-epic-2.md#testing-strategy]
- Integration tests: full verification submission → webhook → status update.
- Security tests: expired token attempt, signature mismatch, oversized file rejection, concurrency safety.

## Technical Constraints
- Persona API requests must include correlation IDs for traceability; logs stored in centralized logging. [Source: docs/tech-spec-epic-2.md#monitoring-and-analytics]
- Document encryption keys rotated quarterly; ensure key alias usage not hard-coded to specific key IDs.

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2025-10-29 | v1.0    | Initial KYC story authored | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
_(To be completed by Dev Agent)_

### Debug Log References
_(To be completed by Dev Agent)_

### Completion Notes List
_(To be completed by Dev Agent)_

### File List
_(To be completed by Dev Agent)_

## QA Results
_(To be completed by QA Agent)_
